<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>OMAR TERMINAL</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700;800;900&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--bg4:#222;
  --orange:#ff8c00;--orange-dim:#cc7000;--orange-bg:rgba(255,140,0,0.08);
  --green:#00c853;--green-bg:rgba(0,200,83,0.1);
  --red:#ff1744;--red-bg:rgba(255,23,68,0.1);
  --white:#e8e8e8;--text:#bbb;--dim:#777;--muted:#444;
  --font:'JetBrains Mono',monospace;--sans:'Inter',sans-serif;
}
body.light{
  --bg:#f5f5f5;--bg2:#fff;--bg3:#e0e0e0;--bg4:#d0d0d0;
  --orange:#ff8c00;--orange-dim:#cc7000;--orange-bg:rgba(255,140,0,0.12);
  --green:#00c853;--green-bg:rgba(0,200,83,0.15);
  --red:#ff1744;--red-bg:rgba(255,23,68,0.15);
  --white:#1a1a1a;--text:#333;--dim:#666;--muted:#999;
}
html,body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:12px;line-height:1.4;overflow:hidden;height:100%;-webkit-font-smoothing:antialiased}
button,a,[onclick],.tf-btn,.type-btn,.draw-btn,.ov-right-row{pointer-events:auto !important;cursor:pointer !important}

/* ═══ APP SHELL ═══ */
.app{display:flex;flex-direction:column;height:100vh}

/* ═══ HEADER BAR ═══ */
.header{display:flex;align-items:center;height:44px;background:#0d0d0d;border-bottom:1px solid #222;padding:0 16px;gap:16px}
.hdr-coin{display:flex;align-items:center;gap:10px;cursor:pointer;position:relative}
.hdr-coin-input{background:transparent;border:1px solid #333;color:var(--orange);font-family:var(--font);font-size:14px;font-weight:700;padding:4px 12px;width:200px;outline:none;caret-color:var(--orange)}
.hdr-coin-input:focus{border-color:var(--orange)}
.hdr-coin-input::placeholder{color:#444}
.coin-dropdown{position:absolute;top:100%;left:0;width:240px;background:#111;border:1px solid #333;max-height:300px;overflow-y:auto;z-index:100;display:none}
.coin-dropdown.show{display:block}
.coin-opt{padding:8px 12px;cursor:pointer;display:flex;justify-content:space-between;font-size:11px;min-height:44px;align-items:center}
.coin-opt:hover{background:#1a1a1a}
.coin-opt:active{background:#222}
.coin-opt .sym{font-weight:700;color:var(--white)}

.hdr-label{font-family:var(--sans);font-weight:800;font-size:18px;color:var(--white);letter-spacing:-0.02em}
.hdr-type{font-size:10px;color:var(--dim);letter-spacing:0.05em}
.hdr-price{font-size:20px;font-weight:700;margin-left:8px}
.hdr-change{font-size:12px;font-weight:600;padding:2px 8px;border-radius:3px;margin-left:6px}
.hdr-change.up{background:var(--green-bg);color:var(--green)}
.hdr-change.down{background:var(--red-bg);color:var(--red)}
.hdr-right{margin-left:auto;display:flex;align-items:center;gap:16px}
.hdr-live{display:flex;align-items:center;gap:5px;color:var(--green);font-size:10px;font-weight:600}
.hdr-dot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 1.5s ease infinite;box-shadow:0 0 8px rgba(0,200,83,0.5)}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.7)}}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}
.hdr-time{color:var(--orange);font-size:12px;font-weight:600}
.hdr-brand{color:var(--orange);font-weight:800;font-size:13px;letter-spacing:0.12em}

/* ═══ TAB NAVIGATION ═══ */
.tabs{display:flex;align-items:center;height:36px;background:#080808;border-bottom:1px solid #1a1a1a;padding:0 16px;gap:2px}
.tab{padding:8px 16px;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;letter-spacing:0.03em;border-bottom:2px solid transparent;transition:all 0.15s;pointer-events:auto;position:relative;z-index:100}
.tab:hover{color:var(--dim)}
.tab.active{color:var(--orange);border-bottom-color:var(--orange)}
.tab .num{color:var(--orange-dim);margin-right:4px;font-size:10px}

/* ═══ MAIN VIEW ═══ */
.view{flex:1;overflow:hidden;display:none}
.view.active{display:flex;flex-direction:column}

/* ═══ OVERVIEW TAB ═══ */
.overview{display:flex;flex:1;overflow:hidden}
.ov-left{flex:1;display:flex;flex-direction:column;min-width:300px}
.ov-right{width:340px;border-left:1px solid #1a1a1a;overflow-y:auto;background:#0d0d0d}
.ov-right-row{display:flex;justify-content:space-between;padding:8px 16px;border-bottom:1px solid #141414;font-size:11px}
.ov-right-row .lbl{color:var(--dim)}
.ov-right-row .val{font-weight:600;color:var(--white)}
.ov-section-title{padding:10px 16px;font-size:10px;font-weight:700;color:var(--orange);letter-spacing:0.1em;text-transform:uppercase;background:#0a0a0a;border-bottom:1px solid #1a1a1a;position:sticky;top:0;z-index:1}

/* Chart */
.chart-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
.chart-toolbar{display:flex;align-items:center;padding:6px 12px;gap:4px;background:#0d0d0d;border-bottom:1px solid #1a1a1a}
.tf-btn{padding:4px 10px;background:transparent;border:none;color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:3px;font-weight:600}
.tf-btn:hover{color:var(--dim);background:#1a1a1a}
.tf-btn.active{background:var(--orange);color:#000}
.chart-sep{width:1px;height:16px;background:#222;margin:0 4px}
.type-btn{padding:4px 8px;background:transparent;border:none;color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:3px}
.type-btn:hover{color:var(--dim)}
.type-btn.active{color:var(--orange)}
.draw-btn{padding:4px 8px;background:transparent;border:1px solid #333;color:var(--muted);font-family:var(--font);font-size:9px;cursor:pointer;border-radius:3px;font-weight:500;transition:all 0.15s}
.draw-btn:hover{color:var(--orange-dim);border-color:var(--orange-dim);background:#1a1a1a}
.draw-btn.active{background:var(--orange);color:#000;border-color:var(--orange);font-weight:700}
.draw-btn-icon{font-size:12px;margin-right:3px}

.chart-body{flex:1;position:relative;cursor:crosshair;overflow:hidden;background:#000}
.chart-body canvas{width:100%;height:100%;pointer-events:none}
.chart-ohlc{position:absolute;top:8px;left:12px;display:flex;gap:12px;font-size:10px;pointer-events:none;z-index:2}
.chart-ohlc span{color:var(--dim)}
.chart-ohlc .lbl{color:var(--muted);font-size:9px}
.chart-watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:var(--sans);font-weight:900;font-size:50px;color:rgba(255,140,0,0.03);pointer-events:none}
.chart-scroll{height:18px;padding:3px 80px 3px 0;background:#050505;border-top:1px solid #1a1a1a}
.chart-scroll input[type=range]{-webkit-appearance:none;width:100%;height:10px;background:#111;border-radius:2px;outline:none;cursor:pointer}
.chart-scroll input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:40px;height:10px;background:var(--orange);border-radius:2px;cursor:grab}

/* Recent trades below chart */
.recent-trades{max-height:160px;overflow-y:auto;border-top:1px solid #1a1a1a}
.rt-head,.rt-row{display:grid;grid-template-columns:100px 1fr 1fr 1fr;padding:4px 12px;font-size:10px}
.rt-head{color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;font-size:9px;border-bottom:1px solid #141414;position:sticky;top:0;background:#0d0d0d;z-index:1}
.rt-row{border-bottom:1px solid #0f0f0f}
.rt-row:hover{background:#111}

/* ═══ ANALYSIS TAB ═══ */
.analysis-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:#1a1a1a;flex:1;overflow-y:auto}
.analysis-card{background:var(--bg);padding:20px}
.analysis-card h3{color:var(--orange);font-size:11px;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:12px}
.signal-meter{display:flex;gap:4px;margin:12px 0}
.signal-bar{flex:1;height:24px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700}
.indicator-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #141414;font-size:11px}
.indicator-row .name{color:var(--dim)}
.indicator-row .val{font-weight:600}
.sr-level{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px}
.sr-bar{height:4px;border-radius:2px;flex:1}

/* ═══ ORDER BOOK TAB ═══ */
.ob-view{display:flex;flex:1;overflow:hidden}
.ob-list{flex:1;overflow-y:auto;padding:0}
.ob-depth-chart{flex:1;position:relative;background:#000}
.ob-depth-chart canvas{width:100%;height:100%}
.ob-head2{display:grid;grid-template-columns:1fr 1fr 1fr;padding:6px 12px;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;border-bottom:1px solid #1a1a1a;position:sticky;top:0;background:#0d0d0d;z-index:1}
.ob-row2{display:grid;grid-template-columns:1fr 1fr 1fr;padding:3px 12px;font-size:11px;position:relative}
.ob-row2:hover{background:#111}
.ob-bar2{position:absolute;top:0;bottom:0;right:0;opacity:0.06;pointer-events:none}
.ob-mid2{text-align:center;padding:10px;font-size:16px;font-weight:700;background:#0d0d0d;border-top:1px solid #1a1a1a;border-bottom:1px solid #1a1a1a}

/* ═══ REL VALUE TAB ═══ */
.rv-chart{height:300px;background:#000;position:relative;border-bottom:1px solid #1a1a1a}
.rv-chart canvas{width:100%;height:100%}
.rv-toolbar{display:flex;align-items:center;padding:8px 16px;gap:6px;background:#0d0d0d;border-bottom:1px solid #1a1a1a}
.rv-btn{padding:4px 10px;background:transparent;border:none;color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:3px;font-weight:600}
.rv-btn:hover{color:var(--dim);background:#1a1a1a}
.rv-btn.active{background:var(--orange);color:#000}
.rv-table{flex:1;overflow-y:auto}
.rv-head,.rv-row{display:grid;grid-template-columns:80px 100px 90px 80px 80px 80px 80px 80px 1fr;padding:6px 12px;font-size:11px;align-items:center}
.rv-head{color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;font-size:9px;border-bottom:1px solid #1a1a1a;position:sticky;top:0;background:#0d0d0d;z-index:1}
.rv-row{border-bottom:1px solid #0f0f0f;cursor:pointer}
.rv-row:hover{background:#111}
.rv-row .sym{font-weight:700;color:var(--white)}

/* ═══ NEWS TAB ═══ */
.news-list{flex:1;overflow-y:auto;padding:8px 0}
.news-card{padding:12px 20px;border-bottom:1px solid #141414;cursor:pointer}
.news-card:hover{background:#111}
.news-card .time{font-size:10px;color:var(--orange-dim)}
.news-card .headline{font-size:13px;color:var(--white);margin:4px 0;font-weight:500;line-height:1.5}
.news-card .source{font-size:10px;color:var(--dim)}

/* ═══ POSITIONS TAB ═══ */
.pos-view{display:flex;flex-direction:column;flex:1;overflow:hidden}
.pos-subtabs{display:flex;padding:0 16px;border-bottom:1px solid #1a1a1a;background:#0d0d0d}
.pos-subtab{padding:8px 16px;font-size:10px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent}
.pos-subtab:hover{color:var(--dim)}
.pos-subtab.active{color:var(--orange);border-bottom-color:var(--orange)}
.pos-content{flex:1;overflow-y:auto}
.pos-head,.pos-row{display:grid;grid-template-columns:70px 55px 80px 90px 90px 80px 80px 70px 1fr;padding:6px 12px;align-items:center;font-size:11px}
.pos-head{color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;font-size:9px;border-bottom:1px solid #1a1a1a;position:sticky;top:0;background:#0d0d0d;z-index:1}
.pos-row{border-bottom:1px solid #0f0f0f}
.pos-row:hover{background:#111}
.pos-badge{font-weight:800;font-size:9px;padding:2px 6px;border-radius:2px;letter-spacing:0.05em}
.pos-long{background:var(--green-bg);color:var(--green)}
.pos-short{background:var(--red-bg);color:var(--red)}
.pos-sym{font-weight:700;color:var(--white)}
.up{color:var(--green)}.down{color:var(--red)}

/* Account summary */
.account-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:#1a1a1a}
.account-cell{background:var(--bg);padding:16px 20px}
.account-cell .lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px}
.account-cell .val{font-size:18px;font-weight:700;color:var(--white)}

/* ═══ SCROLLING TICKER ═══ */
.ticker-bar{height:28px;background:#050505;border-top:1px solid #1a1a1a;overflow:hidden;position:relative}
.ticker-track{display:flex;align-items:center;height:100%;white-space:nowrap;animation:tickerScroll 60s linear infinite}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.ticker-item{display:inline-flex;align-items:center;gap:6px;padding:0 20px;font-size:11px}
.ticker-item .sym{font-weight:700;color:var(--white)}
.ticker-item .price{color:var(--text)}
.ticker-item .chg{font-weight:600;font-size:10px}

/* Scrollbar */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:#333;border-radius:2px}

/* ═══ MOBILE RESPONSIVE ═══ */
@media (max-width: 768px) {
  html,body{font-size:10px}
  
  /* Header: stack vertically */
  .header{flex-wrap:wrap;height:auto;padding:8px}
  .hdr-coin{width:100%;order:1;margin-bottom:6px}
  .hdr-coin-input{font-size:13px}
  .hdr-label{font-size:14px;order:2}
  .hdr-type{order:3}
  .hdr-price{font-size:16px;order:4}
  .hdr-change{order:5}
  .hdr-right{width:100%;order:6;justify-content:space-between;margin-top:6px}
  
  /* Tabs: smaller, scrollable */
  .tabs{overflow-x:auto;padding:0 8px}
  .tab{font-size:9px;padding:6px 10px;white-space:nowrap}
  
  /* Overview: stack left/right vertically */
  .overview{flex-direction:column}
  .ov-left{width:100%!important}
  .ov-right{width:100%!important;max-height:400px}
  
  /* Chart toolbar: wrap, smaller buttons */
  .chart-toolbar{flex-wrap:wrap;padding:4px 8px;gap:2px}
  .tf-btn,.type-btn{font-size:8px;padding:3px 6px}
  .chart-sep{display:none} /* hide separators on mobile */
  
  /* Hide OHLC overlay on mobile (too cluttered) */
  .chart-ohlc{display:none}
  
  /* Order book view: stack side-by-side */
  .ob-view{flex-direction:column}
  .ob-list{width:100%!important;max-height:300px}
  .ob-depth-chart{width:100%!important;height:200px}
  
  /* Position table: smaller fonts, horizontal scroll */
  .pos-head,.pos-row{grid-template-columns:60px 45px 70px 75px 75px 65px 60px 60px 1fr;font-size:9px;padding:4px 6px}
  .pos-badge{font-size:8px;padding:1px 4px}
  
  /* Relative value table: horizontal scroll */
  .rv-head,.rv-row{grid-template-columns:70px 90px 80px 70px 70px 70px 70px 70px 1fr;font-size:9px}
  
  /* Ticker: slower scroll, bigger text */
  .ticker-bar{height:32px}
  .ticker-item{font-size:10px;padding:0 16px}
  
  /* Watchlist: bigger tap targets */
  .ov-right-row{padding:8px 12px}
  
  /* News cards: more padding */
  .news-card{padding:10px 16px}
  
  /* Hide watermark on mobile */
  .chart-watermark{display:none}
  
  /* Coin dropdown: full width on mobile */
  .coin-dropdown{width:calc(100vw - 16px);left:0;right:0}
  .coin-opt{min-height:48px;padding:10px 16px}
}

@media (max-width: 480px) {
  /* Extra small phones: even tighter */
  html,body{font-size:9px}
  .header{padding:6px}
  .hdr-label{font-size:12px}
  .hdr-price{font-size:14px}
  .tab{font-size:8px;padding:5px 8px}
  .tf-btn,.type-btn{font-size:7px;padding:2px 5px}
  
  /* Single column for everything */
  .analysis-grid{grid-template-columns:1fr}
  .account-grid{grid-template-columns:1fr}
  
  /* Hide some stat columns on tiny screens */
  .rv-head,.rv-row{grid-template-columns:60px 70px 70px 60px 1fr;font-size:8px}
  .rv-head span:nth-child(n+6),.rv-row span:nth-child(n+6){display:none}
}
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="hdr-coin">
      <input type="text" class="hdr-coin-input" id="coinInput" placeholder="BTC PERP" spellcheck="false" autocomplete="off">
      <div class="coin-dropdown" id="coinDropdown"></div>
    </div>
    <span class="hdr-label" id="coinLabel">Bitcoin</span>
    <span class="hdr-type" id="coinType">Perpetual</span>
    <span class="hdr-price" id="headerPrice">—</span>
    <span class="hdr-change up" id="headerChange">+0.00%</span>
    <div class="hdr-right">
      <div class="hdr-live"><div class="hdr-dot"></div>LIVE</div>
      <span class="hdr-time" id="clock"></span>
      <span onclick="toggleTheme()" style="cursor:pointer;font-size:10px;margin-left:8px;font-weight:700;letter-spacing:0.08em;padding:3px 6px;border:1px solid #333;border-radius:3px" title="Toggle theme (Alt+T)" id="themeToggle">THEME</span>
      <span onclick="showLayoutManager()" style="cursor:pointer;font-size:10px;margin-left:8px;color:var(--orange);font-weight:700;letter-spacing:0.08em;padding:3px 6px;border:1px solid var(--orange-dim);border-radius:3px" title="Manage layouts (Alt+L)">LAYOUT</span>
      <span class="hdr-brand">OMAR TERMINAL</span>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs" id="tabBar">
    <div class="tab active" data-tab="overview"><span class="num">[1]</span>OVERVIEW</div>
    <div class="tab" data-tab="analysis"><span class="num">[2]</span>ANALYSIS</div>
    <div class="tab" data-tab="orderbook"><span class="num">[3]</span>ORDER BOOK</div>
    <div class="tab" data-tab="gmm"><span class="num">[4]</span>MARKET MONITOR</div>
    <div class="tab" data-tab="screener"><span class="num">[5]</span>SCREENER</div>
    <div class="tab" data-tab="portfolio"><span class="num">[6]</span>PORTFOLIO</div>
    <div class="tab" data-tab="news"><span class="num">[7]</span>NEWS</div>
    <div class="tab" data-tab="relvalue"><span class="num">[8]</span>REL VALUE</div>
  </div>

  <!-- ═══ [1] OVERVIEW ═══ -->
  <div class="view active" id="view-overview">
    <div class="overview">
      <div class="ov-left">
        <div class="chart-container">
          <div class="chart-toolbar">
            <button class="tf-btn" data-tf="1m">1m</button>
            <button class="tf-btn" data-tf="5m">5m</button>
            <button class="tf-btn" data-tf="15m">15m</button>
            <button class="tf-btn active" data-tf="1h">1H</button>
            <button class="tf-btn" data-tf="4h">4H</button>
            <button class="tf-btn" data-tf="1d">1D</button>
            <button class="tf-btn" data-tf="1w">1W</button>
            <div class="chart-sep"></div>
            <button class="type-btn active" data-type="candle">Candle</button>
            <button class="type-btn" data-type="line">Line</button>
            <button class="type-btn" data-type="area">Area</button>
            <div class="chart-sep"></div>
            <button class="tf-btn" id="ind-sma20" style="font-size:9px;padding:3px 6px">SMA20</button>
            <button class="tf-btn" id="ind-sma50" style="font-size:9px;padding:3px 6px">SMA50</button>
            <button class="tf-btn" id="ind-ema20" style="font-size:9px;padding:3px 6px">EMA20</button>
            <button class="tf-btn" id="ind-bb" style="font-size:9px;padding:3px 6px">BB</button>
            <button class="tf-btn" id="ind-vwap" style="font-size:9px;padding:3px 6px">VWAP</button>
            <button class="tf-btn" id="ind-rsi" style="font-size:9px;padding:3px 6px">RSI</button>
            <button class="tf-btn" id="ind-volProfile" style="font-size:9px;padding:3px 6px">VOL PROFILE</button>
            <button class="tf-btn" id="ind-liqLevels" style="font-size:9px;padding:3px 6px">LIQ LEVELS</button>
            <div class="chart-sep"></div>
            <button class="draw-btn" data-tool="hline" onclick="setDrawingTool('hline')" title="Horizontal Line (H)"><span class="draw-btn-icon">━</span>H-LINE</button>
            <button class="draw-btn" data-tool="trendline" onclick="setDrawingTool('trendline')" title="Trend Line (T)"><span class="draw-btn-icon">╱</span>TREND</button>
            <button class="draw-btn" data-tool="fib_ret" onclick="setDrawingTool('fib_ret')" title="Fibonacci Retracement (F)"><span class="draw-btn-icon">F</span>FIB</button>
            <button class="draw-btn" data-tool="fib_ext" onclick="setDrawingTool('fib_ext')" title="Fibonacci Extension"><span class="draw-btn-icon">E</span>FIB-E</button>
            <button class="draw-btn" data-tool="rectangle" onclick="setDrawingTool('rectangle')" title="Rectangle (R)"><span class="draw-btn-icon">▭</span>RECT</button>
            <button class="draw-btn" data-tool="ruler" onclick="setDrawingTool('ruler')" title="Ruler/Measure (M)"><span class="draw-btn-icon">M</span>RULER</button>
            <button class="draw-btn" data-tool="text" onclick="setDrawingTool('text')" title="Text Annotation (X)"><span class="draw-btn-icon">T</span>TEXT</button>
            <div class="chart-sep"></div>
            <button class="tf-btn" onclick="exportChartPNG()" style="font-size:9px;padding:3px 6px" title="Export chart as PNG (Ctrl+P)">EXPORT</button>
            <button class="tf-btn" onclick="downloadCSV()" style="font-size:9px;padding:3px 6px" title="Download CSV data (Ctrl+D)">DATA</button>
            <button class="tf-btn" onclick="shareChart()" style="font-size:9px;padding:3px 6px" title="Copy share URL">SHARE</button>
          </div>
          <div class="chart-body" id="chartBody">
            <div class="chart-watermark">OMAR</div>
            <div class="chart-ohlc">
              <span><span class="lbl">O</span> <span id="ohlcO">—</span></span>
              <span><span class="lbl">H</span> <span id="ohlcH">—</span></span>
              <span><span class="lbl">L</span> <span id="ohlcL">—</span></span>
              <span><span class="lbl">C</span> <span id="ohlcC">—</span></span>
              <span><span class="lbl">VOL</span> <span id="ohlcV">—</span></span>
            </div>
            <canvas id="chart"></canvas>
          </div>
          <div class="chart-scroll"><input type="range" id="chartScroll" min="0" max="100" value="100"></div>
        </div>
        <div class="recent-trades" id="recentTradesPanel">
          <div class="rt-head"><span>TIME</span><span>SIDE</span><span>PRICE</span><span>SIZE</span></div>
          <div id="recentTrades"></div>
        </div>
      </div>
      <div class="ov-right" id="ovRight">
        <div class="ov-section-title">KEY STATISTICS</div>
        <div id="keyStats"></div>
        <div class="ov-section-title">CONTRACT INFO</div>
        <div id="contractInfo"></div>
        <div class="ov-section-title">MARKET SENTIMENT</div>
        <div id="fearGreedGauge"></div>
        <div class="ov-section-title">LARGE TRANSACTIONS</div>
        <div id="whaleAlerts"></div>
        <div class="ov-section-title">WATCHLIST</div>
        <div id="watchlist"></div>
      </div>
    </div>
  </div>

  <!-- ═══ [2] ANALYSIS ═══ -->
  <div class="view" id="view-analysis">
    <div class="analysis-grid" id="analysisContent"></div>
  </div>

  <!-- ═══ [3] ORDER BOOK ═══ -->
  <div class="view" id="view-orderbook">
    <div class="ob-view">
      <div class="ob-list" id="obListPanel">
        <div class="ob-head2"><span>PRICE (USD)</span><span style="text-align:right">SIZE</span><span style="text-align:right">TOTAL</span></div>
        <div id="obList"></div>
      </div>
      <div class="ob-depth-chart"><canvas id="depthCanvas"></canvas></div>
    </div>
  </div>

  <!-- ═══ [4] REL VALUE ═══ -->
  <div class="view" id="view-relvalue">
    <div class="rv-toolbar" id="rvToolbar">
      <button class="rv-btn active" data-period="1d">1D</button>
      <button class="rv-btn" data-period="1w">1W</button>
      <button class="rv-btn" data-period="1m">1M</button>
      <button class="rv-btn" data-period="3m">3M</button>
    </div>
    <div class="rv-chart"><canvas id="rvChart"></canvas></div>
    <div class="rv-table">
      <div class="rv-head"><span>COIN</span><span>MKT CAP</span><span>PRICE</span><span>24H %</span><span>7D %</span><span>VOLUME</span><span>FUNDING</span><span>OI</span><span></span></div>
      <div id="rvTableBody"></div>
    </div>
  </div>

  <!-- ═══ [4] GMM (GLOBAL MARKET MONITOR) ═══ -->
  <div class="view" id="view-gmm">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1px;background:#1a1a1a;height:100%">
      <!-- Top Movers Panel -->
      <div style="background:var(--bg);display:flex;flex-direction:column">
        <div style="padding:8px 16px;background:#0d0d0d;border-bottom:1px solid #1a1a1a;font-size:10px;font-weight:700;color:var(--orange);letter-spacing:0.08em">TOP GAINERS</div>
        <div id="gmmGainers" style="flex:1;overflow-y:auto"></div>
      </div>
      <div style="background:var(--bg);display:flex;flex-direction:column">
        <div style="padding:8px 16px;background:#0d0d0d;border-bottom:1px solid #1a1a1a;font-size:10px;font-weight:700;color:var(--orange);letter-spacing:0.08em">TOP LOSERS</div>
        <div id="gmmLosers" style="flex:1;overflow-y:auto"></div>
      </div>
      <!-- Volume & Volatility Panel -->
      <div style="background:var(--bg);display:flex;flex-direction:column">
        <div style="padding:8px 16px;background:#0d0d0d;border-bottom:1px solid #1a1a1a;font-size:10px;font-weight:700;color:var(--orange);letter-spacing:0.08em">VOLUME LEADERS</div>
        <div id="gmmVolume" style="flex:1;overflow-y:auto"></div>
      </div>
      <div style="background:var(--bg);display:flex;flex-direction:column">
        <div style="padding:8px 16px;background:#0d0d0d;border-bottom:1px solid #1a1a1a;font-size:10px;font-weight:700;color:var(--orange);letter-spacing:0.08em">MOST VOLATILE</div>
        <div id="gmmVolatile" style="flex:1;overflow-y:auto"></div>
      </div>
    </div>
  </div>

  <!-- ═══ [5] SCREENER ═══ -->
  <div class="view" id="view-screener">
    <div style="padding:12px 16px;border-bottom:1px solid #1a1a1a;display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:#0d0d0d">
      <span style="font-size:10px;color:var(--dim);font-weight:600">FILTER:</span>
      <select id="screenFilter" style="background:var(--bg3);border:1px solid #333;color:var(--text);padding:4px 8px;font-family:var(--font);font-size:10px;border-radius:2px">
        <option value="all">All Assets</option>
        <option value="gainers">Top Gainers</option>
        <option value="losers">Top Losers</option>
        <option value="volume">High Volume</option>
        <option value="volatile">Most Volatile</option>
      </select>
      <span style="font-size:10px;color:var(--dim);font-weight:600;margin-left:16px">SORT:</span>
      <select id="screenSort" style="background:var(--bg3);border:1px solid #333;color:var(--text);padding:4px 8px;font-family:var(--font);font-size:10px;border-radius:2px">
        <option value="change">% Change</option>
        <option value="price">Price</option>
        <option value="volume">Volume</option>
        <option value="name">Name</option>
      </select>
    </div>
    <div style="overflow-y:auto;flex:1" id="screenerTable"></div>
  </div>

  <!-- ═══ [6] NEWS ═══ -->
  <div class="view" id="view-news">
    <div class="news-list" id="newsList"></div>
  </div>

  <!-- ═══ [6] PORTFOLIO (Bloomberg PORT) ═══ -->
  <div class="view" id="view-portfolio">
    <div style="display:flex;flex-direction:column;height:100%">
      <!-- Portfolio Summary Header -->
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:#1a1a1a;border-bottom:1px solid #1a1a1a">
        <div style="padding:12px;background:#0d0d0d">
          <div style="font-size:9px;color:var(--muted);margin-bottom:4px;letter-spacing:0.08em">TOTAL VALUE</div>
          <div style="font-size:18px;font-weight:700;color:var(--white)" id="portTotalValue">$0.00</div>
        </div>
        <div style="padding:12px;background:#0d0d0d">
          <div style="font-size:9px;color:var(--muted);margin-bottom:4px;letter-spacing:0.08em">TOTAL P&L</div>
          <div style="font-size:18px;font-weight:700" id="portTotalPnL">$0.00</div>
        </div>
        <div style="padding:12px;background:#0d0d0d">
          <div style="font-size:9px;color:var(--muted);margin-bottom:4px;letter-spacing:0.08em">DAY P&L</div>
          <div style="font-size:18px;font-weight:700" id="portDayPnL">$0.00</div>
        </div>
        <div style="padding:12px;background:#0d0d0d">
          <div style="font-size:9px;color:var(--muted);margin-bottom:4px;letter-spacing:0.08em">POSITIONS</div>
          <div style="font-size:18px;font-weight:700;color:var(--white)" id="portPositionCount">0</div>
        </div>
        <div style="padding:12px;background:#0d0d0d">
          <div style="font-size:9px;color:var(--muted);margin-bottom:4px;letter-spacing:0.08em">WIN RATE</div>
          <div style="font-size:18px;font-weight:700;color:var(--white)" id="portWinRate">0%</div>
        </div>
      </div>
      
      <!-- Add Position Button -->
      <div style="padding:8px 12px;background:#0d0d0d;border-bottom:1px solid #1a1a1a;display:flex;gap:8px">
        <button onclick="showAddPositionModal()" style="background:var(--orange);color:#000;border:none;padding:6px 12px;font-family:var(--font);font-size:10px;font-weight:700;cursor:pointer;border-radius:3px;letter-spacing:0.05em">+ ADD POSITION</button>
        <button onclick="clearAllPositions()" style="background:transparent;color:var(--muted);border:1px solid #333;padding:6px 12px;font-family:var(--font);font-size:10px;font-weight:600;cursor:pointer;border-radius:3px">CLEAR ALL</button>
      </div>
      
      <!-- Positions Table -->
      <div style="flex:1;overflow-y:auto">
        <div style="display:grid;grid-template-columns:100px 80px 100px 100px 100px 100px 100px 80px 60px;background:#0a0a0a;border-bottom:1px solid #1a1a1a;padding:8px 12px;position:sticky;top:0;z-index:1">
          <span style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.08em">ASSET</span>
          <span style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.08em">SIDE</span>
          <span style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.08em;text-align:right">ENTRY</span>
          <span style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.08em;text-align:right">CURRENT</span>
          <span style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.08em;text-align:right">SIZE</span>
          <span style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.08em;text-align:right">VALUE</span>
          <span style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.08em;text-align:right">P&L</span>
          <span style="font-size:9px;color:var(--muted);font-weight:700;letter-spacing:0.08em;text-align:right">P&L %</span>
          <span></span>
        </div>
        <div id="portfolioPositions"></div>
      </div>
    </div>
  </div>

  <!-- SCROLLING TICKER -->
  <div class="ticker-bar">
    <div class="ticker-track" id="tickerTrack"></div>
  </div>
</div>

<script>
// ═══ EARLY DIAGNOSTIC ═══
console.log('SCRIPT STARTED');
window.addEventListener('DOMContentLoaded', () => {
  try {
    const earlyDiag = document.createElement('div');
    earlyDiag.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:red;color:white;padding:20px;font-size:20px;z-index:99999;border:5px solid yellow;';
    earlyDiag.textContent = 'JAVASCRIPT IS RUNNING!';
    document.body.appendChild(earlyDiag);
    setTimeout(() => earlyDiag.remove(), 3000);
  } catch (e) {
    console.error('Early diagnostic failed:', e);
  }
});

/* ═══════════════════════════════════════════
   CONFIG
   ═══════════════════════════════════════════ */
// ═══ ASSET CATEGORIES ═══
const CRYPTO = ['BTC','ETH','SOL','XRP','DOGE','SUI','AVAX','LINK','ADA','HYPE','PEPE','WIF','JTO','TIA','SEI','INJ','ONDO','PENDLE','PUMP'];
const STOCKS = ['SPY','QQQ','AAPL','MSFT','NVDA','TSLA','AMZN','META','GOOGL','JPM','AMD','COIN','MSTR','PLTR'];
const COMMODITIES = ['GC=F','SI=F','CL=F','NG=F'];
const FOREX = ['EURUSD=X','GBPUSD=X','USDJPY=X','DX-Y.NYB'];
const ALL_TICKERS = [...CRYPTO,...STOCKS,...COMMODITIES,...FOREX];
const COINS = CRYPTO; // backward compat

const ASSET_NAMES = {
  // Crypto
  BTC:'Bitcoin',ETH:'Ethereum',SOL:'Solana',XRP:'XRP',DOGE:'Dogecoin',SUI:'Sui',AVAX:'Avalanche',LINK:'Chainlink',ADA:'Cardano',HYPE:'Hyperliquid',PEPE:'Pepe',WIF:'dogwifhat',JTO:'Jito',TIA:'Celestia',SEI:'Sei',INJ:'Injective',ONDO:'Ondo',PENDLE:'Pendle',PUMP:'Pump.fun',
  // Stocks & ETFs
  SPY:'S&P 500 ETF',QQQ:'Nasdaq 100 ETF',AAPL:'Apple',MSFT:'Microsoft',NVDA:'NVIDIA',TSLA:'Tesla',AMZN:'Amazon',META:'Meta',GOOGL:'Alphabet',JPM:'JPMorgan',AMD:'AMD',COIN:'Coinbase',MSTR:'MicroStrategy',PLTR:'Palantir',
  // Commodities
  'GC=F':'Gold','SI=F':'Silver','CL=F':'Crude Oil','NG=F':'Natural Gas',
  // Forex
  'EURUSD=X':'EUR/USD','GBPUSD=X':'GBP/USD','USDJPY=X':'USD/JPY','DX-Y.NYB':'US Dollar Index'
};
const COIN_NAMES = ASSET_NAMES; // backward compat

const ASSET_TYPE = {};
CRYPTO.forEach(c=>ASSET_TYPE[c]='crypto');
STOCKS.forEach(s=>ASSET_TYPE[s]='stock');
COMMODITIES.forEach(c=>ASSET_TYPE[c]='commodity');
FOREX.forEach(f=>ASSET_TYPE[f]='forex');

let activeCoin = 'BTC';
let activeCategory = 'all'; // all, crypto, stocks, commodities, forex
let chartType = 'candle';
let activeTF = '1h';
let activeTab = 'overview';
let activePosSub = 'positions';
let priceData = {};
let candleData = {};
let metaData = null;
let orderBookData = {};
let fearGreedData = null; // {value, classification}
let newsData = [];
let aiInsight = null;
let economicEvents = [];
let indicators = {sma20:true,sma50:false,ema20:false,rsi:false,bb:false,vwap:false,volProfile:false,liqLevels:false};
let favorites = []; // favorite coins
let priceAlerts = [];
let soundEnabled = true;
let theme = 'dark';
let customLayouts = {};
let activeLayout = 'default';
let drawingMode = null; // null, 'hline', 'trendline', 'delete'
let drawings = {}; // keyed by coin:tf
let currentDrawing = null;

const TF_MS = {'1m':60000,'5m':300000,'15m':900000,'1h':3600000,'4h':14400000,'1d':86400000,'1w':604800000};

/* ═══════════════════════════════════════════
   PERSISTENT SETTINGS (localStorage)
   ═══════════════════════════════════════════ */
function loadSettings(){
  try{
    const saved=JSON.parse(localStorage.getItem('omar_terminal_settings')||'{}');
    if(saved.activeCoin&&ALL_TICKERS.includes(saved.activeCoin))activeCoin=saved.activeCoin;
    if(saved.activeTF&&TF_MS[saved.activeTF])activeTF=saved.activeTF;
    if(saved.indicators)indicators={...indicators,...saved.indicators};
    if(saved.favorites&&Array.isArray(saved.favorites))favorites=saved.favorites.filter(c=>ALL_TICKERS.includes(c));
    if(saved.activeCategory)activeCategory=saved.activeCategory;
    if(saved.priceAlerts&&Array.isArray(saved.priceAlerts))priceAlerts=saved.priceAlerts;
    if(saved.soundEnabled!==undefined)soundEnabled=saved.soundEnabled;
    if(saved.theme)theme=saved.theme;
  }catch(e){console.error('Settings load error:',e)}
  applyTheme();
}

function saveSettings(){
  try{
    const settings={activeCoin,activeTF,indicators,favorites,activeCategory,priceAlerts,soundEnabled,theme};
    localStorage.setItem('omar_terminal_settings',JSON.stringify(settings));
  }catch(e){console.error('Settings save error:',e)}
}

function toggleTheme(){
  theme=theme==='dark'?'light':'dark';
  applyTheme();
  saveSettings();
}

function applyTheme(){
  document.body.className=theme==='light'?'light':'';
}

/* ═══════════════════════════════════════════
   CUSTOM LAYOUTS
   ═══════════════════════════════════════════ */
function saveLayout(name){
  const layout={
    activeCoin,
    activeTF,
    activeTab,
    indicators:{...indicators},
    theme,
    activeCategory
  };
  customLayouts[name]=layout;
  localStorage.setItem('omar_terminal_layouts',JSON.stringify(customLayouts));
  alert(`✅ Layout "${name}" saved!`);
}

function loadLayout(name){
  const layout=customLayouts[name];
  if(!layout){alert(`Layout "${name}" not found`);return}
  activeCoin=layout.activeCoin||'BTC';
  activeTF=layout.activeTF||'1h';
  activeTab=layout.activeTab||'overview';
  indicators={...indicators,...layout.indicators};
  theme=layout.theme||'dark';
  activeCategory=layout.activeCategory||'all';
  activeLayout=name;
  applyTheme();
  switchTab(activeTab);
  selectCoin(activeCoin);
  document.querySelectorAll('.tf-btn').forEach(b=>b.classList.toggle('active',b.dataset.tf===activeTF));
  Object.keys(indicators).forEach(ind=>{
    const btn=document.getElementById('ind-'+ind);
    if(btn)btn.classList.toggle('active',indicators[ind]);
  });
  alert(`✅ Layout "${name}" loaded!`);
}

function showLayoutManager(){
  const names=Object.keys(customLayouts);
  const list=names.length>0?names.map(n=>`<div style="padding:8px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center">
    <span style="font-weight:600">${n}</span>
    <div style="display:flex;gap:4px">
      <button onclick="loadLayout('${n}');document.getElementById('layoutModal').remove()" style="background:var(--green-bg);color:var(--green);border:1px solid var(--green);padding:4px 10px;cursor:pointer;font-size:9px;font-family:var(--font);border-radius:2px">LOAD</button>
      <button onclick="delete customLayouts['${n}'];localStorage.setItem('omar_terminal_layouts',JSON.stringify(customLayouts));showLayoutManager()" style="background:var(--red-bg);color:var(--red);border:1px solid var(--red);padding:4px 10px;cursor:pointer;font-size:9px;font-family:var(--font);border-radius:2px">DELETE</button>
    </div>
  </div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--muted);font-size:11px">No saved layouts</div>';
  
  let modal=document.getElementById('layoutModal');
  if(modal)modal.remove();
  modal=document.createElement('div');
  modal.id='layoutModal';
  modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:999;display:flex;align-items:center;justify-content:center';
  modal.innerHTML=`<div style="background:#111;border:1px solid var(--orange);border-radius:4px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <span style="color:var(--orange);font-weight:800;font-size:14px;letter-spacing:0.1em">LAYOUTS</span>
      <span onclick="document.getElementById('layoutModal').remove()" style="cursor:pointer;color:var(--muted);font-size:18px">✕</span>
    </div>
    <button onclick="const n=prompt('Layout name:');if(n){saveLayout(n);showLayoutManager()}" style="width:100%;background:var(--orange);color:#000;border:none;padding:8px;font-family:var(--font);font-weight:700;font-size:11px;cursor:pointer;border-radius:3px;margin-bottom:12px">+ SAVE CURRENT LAYOUT</button>
    ${list}
  </div>`;
  modal.addEventListener('click',e=>{if(e.target===modal)modal.remove()});
  document.body.appendChild(modal);
}

function loadSavedLayouts(){
  try{
    const saved=localStorage.getItem('omar_terminal_layouts');
    if(saved)customLayouts=JSON.parse(saved);
  }catch(e){console.error('Layout load error:',e)}
}

/* ═══════════════════════════════════════════
   DRAWING TOOLS
   ═══════════════════════════════════════════ */
function setDrawingMode(mode){
  drawingMode=mode;
  document.querySelectorAll('.draw-btn').forEach(b=>b.classList.remove('active'));
  if(mode)document.getElementById('draw-'+mode)?.classList.add('active');
  const body=document.getElementById('chartBody');
  if(mode)body.style.cursor='crosshair';
  else body.style.cursor='crosshair';
}

function saveDrawings(){
  localStorage.setItem('omar_terminal_drawings',JSON.stringify(drawings));
}

function loadDrawings(){
  try{
    const saved=localStorage.getItem('omar_terminal_drawings');
    if(saved)drawings=JSON.parse(saved);
  }catch(e){console.error('Drawing load error:',e)}
}

function getChartKey(){return candleKey(activeCoin,activeTF)}

function renderDrawings(ctx,cW,cH,min,max,range,startIdx,gap){
  const key=getChartKey();
  if(!drawings[key])return;
  
  drawings[key].forEach(draw=>{
    if(draw.type==='hline'){
      const y=Math.max(0,Math.min(cH,cH-((draw.price-min)/range)*cH));
      ctx.setLineDash([4,2]);
      ctx.strokeStyle=draw.color||'var(--orange)';
      ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cW,y);ctx.stroke();
      ctx.setLineDash([]);
      ctx.font='10px JetBrains Mono';
      ctx.fillStyle=draw.color||'var(--orange)';
      ctx.fillText(fmtPrice(draw.price),4,y-4);
    }
    else if(draw.type==='trendline'){
      const x1=(draw.x1-startIdx)*gap+gap/2;
      const y1=Math.max(0,Math.min(cH,cH-((draw.y1-min)/range)*cH));
      const x2=(draw.x2-startIdx)*gap+gap/2;
      const y2=Math.max(0,Math.min(cH,cH-((draw.y2-min)/range)*cH));
      if(x1<0&&x2<0)return; // both off screen
      ctx.strokeStyle=draw.color||'var(--orange)';
      ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(Math.max(0,x1),y1);ctx.lineTo(Math.min(cW,x2),y2);ctx.stroke();
    }
  });
}

/* ═══════════════════════════════════════════
   EXPORT & SHARING
   ═══════════════════════════════════════════ */
function exportChartPNG(){
  const canvas=document.getElementById('chart');
  const link=document.createElement('a');
  link.download=`${activeCoin}_${activeTF}_${new Date().toISOString().slice(0,10)}.png`;
  link.href=canvas.toDataURL('image/png');
  link.click();
}

function downloadCSV(){
  const candles=candleData[candleKey(activeCoin,activeTF)];
  if(!candles||candles.length===0){alert('No candle data to export');return}
  
  let csv='Timestamp,Open,High,Low,Close,Volume\n';
  candles.forEach(c=>{
    const date=new Date(c.t).toISOString();
    csv+=`${date},${c.o},${c.h},${c.l},${c.c},${c.v}\n`;
  });
  
  // Add indicators if active
  if(indicators.sma20){
    csv+='\n\nSMA20\n';
    const sma=calcSMA(candles,20);
    sma.forEach((val,i)=>csv+=`${new Date(candles[i+candles.length-sma.length].t).toISOString()},${val}\n`);
  }
  
  const blob=new Blob([csv],{type:'text/csv'});
  const link=document.createElement('a');
  link.download=`${activeCoin}_${activeTF}_${new Date().toISOString().slice(0,10)}.csv`;
  link.href=URL.createObjectURL(blob);
  link.click();
}

function shareChart(){
  const url=new URL(window.location.href);
  url.searchParams.set('coin',activeCoin);
  url.searchParams.set('tf',activeTF);
  url.searchParams.set('theme',theme);
  if(indicators.sma20)url.searchParams.set('sma20','1');
  if(indicators.sma50)url.searchParams.set('sma50','1');
  if(indicators.ema20)url.searchParams.set('ema20','1');
  if(indicators.bb)url.searchParams.set('bb','1');
  if(indicators.vwap)url.searchParams.set('vwap','1');
  
  navigator.clipboard.writeText(url.toString()).then(()=>{
    alert('Share URL copied to clipboard!');
  }).catch(()=>{
    prompt('Share this URL:',url.toString());
  });
}

// Load state from URL params on boot
function loadFromURL(){
  const params=new URLSearchParams(window.location.search);
  if(params.get('coin')&&ALL_TICKERS.includes(params.get('coin')))activeCoin=params.get('coin');
  if(params.get('tf')&&TF_MS[params.get('tf')])activeTF=params.get('tf');
  if(params.get('theme'))theme=params.get('theme');
  if(params.get('sma20'))indicators.sma20=true;
  if(params.get('sma50'))indicators.sma50=true;
  if(params.get('ema20'))indicators.ema20=true;
  if(params.get('bb'))indicators.bb=true;
  if(params.get('vwap'))indicators.vwap=true;
}

function toggleFavorite(coin){
  const idx=favorites.indexOf(coin);
  if(idx>=0)favorites.splice(idx,1);
  else favorites.push(coin);
  saveSettings();
  renderWatchlist();
}

/* ═══════════════════════════════════════════
   PRICE ALERTS & SOUND
   ═══════════════════════════════════════════ */
function playAlertSound(){
  if(!soundEnabled)return;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.frequency.value=880; // A5 note
    osc.type='sine';
    gain.gain.setValueAtTime(0.3,ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.3);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime+0.3);
  }catch(e){console.error('Audio error:',e)}
}

function addPriceAlert(coin,price,condition){
  priceAlerts.push({coin,price,condition,triggered:false});
  saveSettings();
}

function checkPriceAlerts(){
  priceAlerts.forEach(alert=>{
    if(alert.triggered)return;
    const d=priceData[alert.coin];
    if(!d)return;
    const hit=(alert.condition==='above'&&d.price>=alert.price)||(alert.condition==='below'&&d.price<=alert.price);
    if(hit){
      alert.triggered=true;
      playAlertSound();
      const msg=`PRICE ALERT: ${alert.coin} ${alert.condition==='above'?'≥':'≤'} $${fmtPrice(alert.price)} (now $${fmtPrice(d.price)})`;
      console.log(msg);
      if('Notification' in window&&Notification.permission==='granted'){
        new Notification('Price Alert',{body:msg,icon:'https://omarkanawati2000-netizen.github.io/omars-terminal/favicon.ico'});
      }
      saveSettings();
    }
  });
}
const TF_BARS = {'1m':500,'5m':500,'15m':400,'1h':300,'4h':200,'1d':365,'1w':150};
const TF_API = {'1m':'1m','5m':'5m','15m':'15m','1h':'1h','4h':'4h','1d':'1d','1w':'1w'};

function getFilteredAssets(){
  if(activeCategory==='favorites')return favorites.length>0?favorites:ALL_TICKERS;
  if(activeCategory==='crypto')return CRYPTO;
  if(activeCategory==='stocks')return STOCKS;
  if(activeCategory==='commodities')return COMMODITIES;
  if(activeCategory==='forex')return FOREX;
  return ALL_TICKERS;
}

function displayName(sym){return ASSET_NAMES[sym]||sym}
function assetCategory(sym){return ASSET_TYPE[sym]||'crypto'}
function categoryColor(sym){const t=assetCategory(sym);return t==='crypto'?'var(--orange)':t==='stock'?'#2196f3':t==='commodity'?'#ffeb3b':'#e040fb'}
function categoryLabel(sym){const t=assetCategory(sym);return t==='crypto'?'PERP':t==='stock'?'EQUITY':t==='commodity'?'FUTURES':t==='forex'?'FX':''}
function cleanSym(sym){return sym.replace('=F','').replace('=X','').replace('-Y.NYB','').replace('DX','DXY')}

function candleKey(c,t){return c+':'+t}
let candleLoading = {};

/* ═══════════════════════════════════════════
   CLOCK
   ═══════════════════════════════════════════ */
function updateClock(){
  const now=new Date();
  document.getElementById('clock').textContent=now.toLocaleString('en-US',{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})+' MST';
}
setInterval(updateClock,1000);updateClock();

/* ═══════════════════════════════════════════
   TAB SWITCHING
   ═══════════════════════════════════════════ */
function switchTab(tab){
  activeTab=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.querySelectorAll('.view').forEach(v=>v.classList.toggle('active',v.id==='view-'+tab));
  if(tab==='overview')renderOverview();
  if(tab==='analysis')renderAnalysis();
  if(tab==='orderbook')renderOrderBookFull();
  if(tab==='gmm')renderGMM();
  if(tab==='screener')renderScreener();
  if(tab==='portfolio')renderPortfolio();
  if(tab==='news')renderNewsFull();
  if(tab==='relvalue')renderRelValue();
}

// Attach tab click listeners with error handling (after DOM loads)
window.addEventListener('DOMContentLoaded', () => {
  try {
    const tabs = document.querySelectorAll('.tab');
    console.log('Attaching click listeners to', tabs.length, 'tabs');
    tabs.forEach(t => {
      t.addEventListener('click', () => {
        console.log('Tab clicked:', t.dataset.tab);
        switchTab(t.dataset.tab);
      });
    });
    console.log('Tab listeners attached successfully');
  } catch (e) {
    console.error('FAILED TO ATTACH TAB LISTENERS:', e);
    alert('ERROR: Tab listeners failed - ' + e.message);
  }
});

/* ═══════════════════════════════════════════
   COIN SELECTOR
   ═══════════════════════════════════════════ */
const coinInput = document.getElementById('coinInput');
const coinDropdown = document.getElementById('coinDropdown');

function selectCoin(coin){
  activeCoin=coin;
  coinInput.value=cleanSym(coin)+' '+categoryLabel(coin);
  document.getElementById('coinLabel').textContent=displayName(coin);
  document.getElementById('coinType').textContent=categoryLabel(coin);
  coinDropdown.classList.remove('show');
  chartZoomX=1;chartZoomY=1;chartPanX=0;
  const key=candleKey(coin,activeTF);
  if(!candleData[key]||candleData[key].length<2)fetchRealCandles(coin,activeTF);
  fetchOrderBook(coin);
  saveSettings(); // Save coin selection
  renderAll();
}

coinInput.addEventListener('focus',()=>{
  renderCoinDropdown('');
  coinDropdown.classList.add('show');
});
coinInput.addEventListener('input',()=>{
  renderCoinDropdown(coinInput.value.trim().toUpperCase());
  coinDropdown.classList.add('show');
});
coinInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const val=coinInput.value.trim().toUpperCase().replace(/ (PERP|EQUITY|FUTURES|FX)$/,'');
    const match=ALL_TICKERS.find(t=>cleanSym(t)===val||t===val);
    if(match)selectCoin(match);
    coinDropdown.classList.remove('show');
    coinInput.blur();
  }
  if(e.key==='Escape'){coinDropdown.classList.remove('show');coinInput.blur();}
});
document.addEventListener('click',e=>{if(!e.target.closest('.hdr-coin'))coinDropdown.classList.remove('show')});

// Fuzzy match scoring
function fuzzyScore(str,query){
  if(!query)return 1;
  str=str.toUpperCase();query=query.toUpperCase();
  if(str===query)return 1000; // exact match
  if(str.startsWith(query))return 100; // starts with
  let score=0,lastIdx=-1;
  for(const char of query){
    const idx=str.indexOf(char,lastIdx+1);
    if(idx===-1)return 0; // no match
    score+=50/(idx-lastIdx); // closer chars = higher score
    lastIdx=idx;
  }
  return score;
}

function renderCoinDropdown(filter){
  const scored=ALL_TICKERS.map(c=>{
    const symScore=fuzzyScore(cleanSym(c),filter);
    const nameScore=fuzzyScore(ASSET_NAMES[c]||'',filter);
    return{coin:c,score:Math.max(symScore,nameScore)};
  }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,20); // top 20 matches
  
  coinDropdown.innerHTML=scored.map(({coin:c})=>{
    const d=priceData[c];
    const price=d?'$'+fmtPrice(d.price):'—';
    const change=d?((d.price-d.open)/d.open*100):0;
    const cls=change>=0?'up':'down';
    const badge=`<span style="font-size:8px;padding:1px 4px;border-radius:2px;background:${categoryColor(c)};color:#000;font-weight:700">${assetCategory(c).toUpperCase()}</span>`;
    return `<div class="coin-opt" onclick="selectCoin('${c}')"><span class="sym">${cleanSym(c)}</span>${badge}<span style="color:var(--dim);font-size:10px">${displayName(c)}</span><span class="${cls}">${price}</span></div>`;
  }).join('');
}

coinInput.value='BTC PERP';

/* ═══════════════════════════════════════════
   CANDLE DATA (REAL API)
   ═══════════════════════════════════════════ */
async function fetchRealCandles(coin,tf){
  // Route non-crypto to Yahoo Finance
  if(assetCategory(coin)!=='crypto'){return fetchStockCandles(coin,tf)}
  const key=candleKey(coin,tf);
  if(candleLoading[key])return;
  candleLoading[key]=true;
  try{
    const bars=TF_BARS[tf]||300;
    const interval=TF_MS[tf]||3600000;
    const endTime=Date.now();
    const startTime=endTime-bars*interval;
    const resp=await fetch('https://api.hyperliquid.xyz/info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'candleSnapshot',req:{coin,interval:TF_API[tf]||'1h',startTime,endTime}})});
    const data=await resp.json();
    if(Array.isArray(data)&&data.length>0){
      candleData[key]=data.map(c=>({o:parseFloat(c.o),h:parseFloat(c.h),l:parseFloat(c.l),c:parseFloat(c.c),v:parseFloat(c.v),t:c.t}));
      if(coin===activeCoin&&tf===activeTF)renderChart();
    }
  }catch(e){console.error('Candle fetch error:',coin,tf,e)}
  finally{candleLoading[key]=false}
}

function switchTimeframe(tf){
  activeTF=tf;
  chartZoomX=1;chartZoomY=1;chartPanX=0;
  document.querySelectorAll('.tf-btn').forEach(b=>b.classList.toggle('active',b.dataset.tf===tf));
  const key=candleKey(activeCoin,tf);
  if(!candleData[key]||candleData[key].length<2)fetchRealCandles(activeCoin,tf);
  saveSettings(); // Save timeframe selection
  renderChart();
}

/* ═══════════════════════════════════════════
   PRICE FETCHING
   ═══════════════════════════════════════════ */
async function fetchPrices(){
  try{
    const resp=await fetch('https://api.hyperliquid.xyz/info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'allMids'})});
    const data=await resp.json();
    for(const coin of COINS){
      const price=parseFloat(data[coin]||0);
      if(!price)continue;
      if(!priceData[coin]){
        priceData[coin]={price,prevPrice:price,open:price,high:price,low:price,history:[],volume:0};
        if(coin===activeCoin)fetchRealCandles(coin,activeTF);
      }else{
        priceData[coin].prevPrice=priceData[coin].price;
        priceData[coin].price=price;
        priceData[coin].high=Math.max(priceData[coin].high,price);
        priceData[coin].low=Math.min(priceData[coin].low,price);
      }
      priceData[coin].history.push({time:Date.now(),price});
      if(priceData[coin].history.length>300)priceData[coin].history.shift();
      // Update live candle
      for(const tf of Object.keys(TF_MS)){
        const key=candleKey(coin,tf);
        if(candleData[key]&&candleData[key].length>0){
          const last=candleData[key][candleData[key].length-1];
          if(Date.now()-last.t>TF_MS[tf]){
            if(coin===activeCoin&&tf===activeTF)fetchRealCandles(coin,tf);
          }else{
            last.c=price;last.h=Math.max(last.h,price);last.l=Math.min(last.l,price);
          }
        }
      }
    }
    checkPriceAlerts(); // Check if any alerts triggered
    renderAll();
  }catch(e){console.error('Fetch error:',e)}
}

// Fetch metadata (volume, funding, OI)
async function fetchMeta(){
  try{
    const resp=await fetch('https://api.hyperliquid.xyz/info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'metaAndAssetCtxs'})});
    metaData=await resp.json();
    // Map volume/funding/OI to priceData
    if(metaData&&metaData.length>=2){
      const universe=metaData[0].universe;
      const ctxs=metaData[1];
      universe.forEach((u,i)=>{
        const coin=u.name;
        if(priceData[coin]&&ctxs[i]){
          priceData[coin].volume=parseFloat(ctxs[i].dayNtlVlm||0);
          priceData[coin].funding=parseFloat(ctxs[i].funding||0);
          priceData[coin].openInterest=parseFloat(ctxs[i].openInterest||0);
          priceData[coin].markPx=parseFloat(ctxs[i].markPx||0);
          priceData[coin].prevDayPx=parseFloat(ctxs[i].prevDayPx||0);
          if(priceData[coin].prevDayPx){
            priceData[coin].open=priceData[coin].prevDayPx;
          }
        }
      });
    }
  }catch(e){console.error('Meta fetch error:',e)}
}

/* ═══════════════════════════════════════════
   STOCK/COMMODITY/FOREX FETCHING (Yahoo Finance via proxy)
   ═══════════════════════════════════════════ */
const YAHOO_SYMBOLS = [...STOCKS,...COMMODITIES,...FOREX];
const CORS_PROXY = 'https://corsproxy.io/?';

async function fetchStocks(){
  // Use v8 chart endpoint via CORS proxy (Yahoo has no CORS headers)
  const promises=YAHOO_SYMBOLS.map(async sym=>{
    try{
      const url=CORS_PROXY+encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=5d`);
      const resp=await fetch(url);
      const data=await resp.json();
      const result=data.chart&&data.chart.result&&data.chart.result[0];
      if(!result||!result.meta)return;
      const m=result.meta;
      const price=m.regularMarketPrice;
      if(!price)return;
      const open=m.chartPreviousClose||m.previousClose||price;
      const high=m.regularMarketDayHigh||price;
      const low=m.regularMarketDayLow||price;
      const vol=m.regularMarketVolume||0;
      if(!priceData[sym]){
        priceData[sym]={price,prevPrice:price,open,high,low,history:[],volume:vol,isStock:true};
      }else{
        priceData[sym].prevPrice=priceData[sym].price;
        priceData[sym].price=price;
        priceData[sym].high=high;priceData[sym].low=low;
        priceData[sym].volume=vol;priceData[sym].open=open;
      }
      priceData[sym].history.push({time:Date.now(),price});
      if(priceData[sym].history.length>300)priceData[sym].history.shift();
    }catch(e){/* silent per-symbol */}
  });
  await Promise.allSettled(promises);
  renderAll();
}

/* ═══════════════════════════════════════════
   ORDER BOOK FETCHING (Hyperliquid L2)
   ═══════════════════════════════════════════ */
async function fetchOrderBook(coin){
  // Only fetch for crypto (Hyperliquid has order books)
  if(assetCategory(coin)!=='crypto')return;
  try{
    const resp=await fetch('https://api.hyperliquid.xyz/info',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({type:'l2Book',coin})
    });
    const data=await resp.json();
    if(data&&data.levels&&data.levels.length===2){
      orderBookData[coin]={
        bids:data.levels[0].map(l=>({price:parseFloat(l.px),size:parseFloat(l.sz),count:l.n})),
        asks:data.levels[1].map(l=>({price:parseFloat(l.px),size:parseFloat(l.sz),count:l.n})),
        timestamp:data.time
      };
      if(coin===activeCoin&&activeTab==='orderbook')renderOrderBookFull();
    }
  }catch(e){console.error('Order book fetch error:',coin,e)}
}

/* ═══════════════════════════════════════════
   FEAR & GREED INDEX
   ═══════════════════════════════════════════ */
async function fetchFearGreed(){
  try{
    const resp=await fetch('https://api.alternative.me/fng/');
    const data=await resp.json();
    if(data&&data.data&&data.data[0]){
      fearGreedData={value:parseInt(data.data[0].value),classification:data.data[0].value_classification};
    }
  }catch(e){console.error('Fear & Greed fetch error:',e)}
}

/* ═══════════════════════════════════════════
   REAL-TIME CRYPTO NEWS
   ═══════════════════════════════════════════ */
async function fetchCryptoNews(){
  try{
    const resp=await fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN');
    const data=await resp.json();
    if(data&&data.Data&&Array.isArray(data.Data)){
      newsData=data.Data.slice(0,20).map(n=>({
        time:new Date(n.published_on*1000),
        title:n.title,
        url:n.url,
        source:n.source,
        imageUrl:n.imageurl,
        body:n.body
      }));
      if(activeTab==='news')renderNewsFull();
    }
  }catch(e){console.error('News fetch error:',e)}
}

/* ═══════════════════════════════════════════
   AI MARKET INSIGHTS (LLM Analysis)
   ═══════════════════════════════════════════ */
async function fetchAIInsight(){
  try{
    // Build market snapshot
    const btc=priceData['BTC'];
    const eth=priceData['ETH'];
    const sol=priceData['SOL'];
    if(!btc||!eth||!sol)return;
    
    const btcChange=((btc.price-btc.open)/btc.open*100).toFixed(2);
    const ethChange=((eth.price-eth.open)/eth.open*100).toFixed(2);
    const solChange=((sol.price-sol.open)/sol.open*100).toFixed(2);
    const fg=fearGreedData?fearGreedData.value:50;
    
    const prompt=`You are a crypto market analyst. Analyze current market conditions and provide a brief 2-3 sentence insight.

Market snapshot:
- BTC: $${btc.price.toFixed(0)} (${btcChange>=0?'+':''}${btcChange}% 24h)
- ETH: $${eth.price.toFixed(0)} (${ethChange>=0?'+':''}${ethChange}% 24h)
- SOL: $${sol.price.toFixed(0)} (${solChange>=0?'+':''}${solChange}% 24h)
- Fear & Greed Index: ${fg}/100 (${fg<25?'Extreme Fear':fg<45?'Fear':fg<55?'Neutral':fg<75?'Greed':'Extreme Greed'})

Provide actionable market outlook in 2-3 sentences max. Be concise and specific.`;

    // Use Hugging Face Inference API (free tier)
    const resp=await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({inputs:prompt,parameters:{max_new_tokens:150,temperature:0.7}})
    });
    const data=await resp.json();
    if(data&&data[0]&&data[0].generated_text){
      // Extract only the response part (after the prompt)
      let insight=data[0].generated_text.replace(prompt,'').trim();
      // Clean up any weird formatting
      insight=insight.split('\n')[0].substring(0,300); // first line, max 300 chars
      aiInsight=insight;
      if(activeTab==='analysis')renderAnalysis();
    }
  }catch(e){console.error('AI insight error:',e)}
}

/* ═══════════════════════════════════════════
   ECONOMIC CALENDAR
   ═══════════════════════════════════════════ */
async function fetchEconomicCalendar(){
  try{
    const resp=await fetch('https://nfs.faireconomy.media/ff_calendar_thisweek.json');
    const data=await resp.json();
    if(Array.isArray(data)){
      economicEvents=data.filter(e=>e.impact==='High'||e.impact==='Medium').slice(0,15).map(e=>({
        title:e.title,
        country:e.country,
        date:new Date(e.date),
        impact:e.impact,
        forecast:e.forecast,
        previous:e.previous
      }));
      if(activeTab==='analysis')renderAnalysis();
    }
  }catch(e){console.error('Economic calendar error:',e)}
}

// Fetch Yahoo Finance candles for stocks
async function fetchStockCandles(sym,tf){
  const key=candleKey(sym,tf);
  if(candleLoading[key])return;
  candleLoading[key]=true;
  try{
    // Map TF to Yahoo interval/range
    const yInterval={'1m':'1m','5m':'5m','15m':'15m','1h':'1h','4h':'1h','1d':'1d','1w':'1wk'}[tf]||'1h';
    const yRange={'1m':'1d','5m':'5d','15m':'5d','1h':'1mo','4h':'3mo','1d':'1y','1w':'5y'}[tf]||'1mo';
    const url=CORS_PROXY+encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=${yInterval}&range=${yRange}`);
    const resp=await fetch(url);
    const data=await resp.json();
    const result=data.chart&&data.chart.result&&data.chart.result[0];
    if(result&&result.timestamp&&result.indicators){
      const ts=result.timestamp;
      const q=result.indicators.quote[0];
      const candles=[];
      for(let i=0;i<ts.length;i++){
        if(q.open[i]==null)continue;
        candles.push({o:q.open[i],h:q.high[i],l:q.low[i],c:q.close[i],v:q.volume[i]||0,t:ts[i]*1000});
      }
      if(candles.length>0){
        candleData[key]=candles;
        if(sym===activeCoin&&tf===activeTF)renderChart();
      }
    }
  }catch(e){console.error('Yahoo candle error:',sym,tf,e)}
  finally{candleLoading[key]=false}
}

/* ═══════════════════════════════════════════
   FORMATTING
   ═══════════════════════════════════════════ */
function fmtPrice(p){
  if(p>=1000)return p.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  if(p>=1)return p.toFixed(4);
  if(p>=0.01)return p.toFixed(5);
  return p.toFixed(8);
}
function fmtCompact(n){
  if(n>=1e9)return(n/1e9).toFixed(2)+'B';
  if(n>=1e6)return(n/1e6).toFixed(2)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  return n.toFixed(0);
}

/* ═══════════════════════════════════════════
   TECHNICAL INDICATORS
   ═══════════════════════════════════════════ */
function calcSMA(candles,period){
  if(!candles||candles.length<period)return[];
  const sma=[];
  for(let i=period-1;i<candles.length;i++){
    const sum=candles.slice(i-period+1,i+1).reduce((a,c)=>a+c.c,0);
    sma.push(sum/period);
  }
  return sma;
}

function calcEMA(candles,period){
  if(!candles||candles.length<period)return[];
  const ema=[];
  const k=2/(period+1);
  let prevEma=candles.slice(0,period).reduce((a,c)=>a+c.c,0)/period;
  ema.push(prevEma);
  for(let i=period;i<candles.length;i++){
    prevEma=(candles[i].c-prevEma)*k+prevEma;
    ema.push(prevEma);
  }
  return ema;
}

function calcRSI(candles,period=14){
  if(!candles||candles.length<period+1)return[];
  const rsi=[];
  let gains=0,losses=0;
  for(let i=1;i<=period;i++){
    const change=candles[i].c-candles[i-1].c;
    if(change>0)gains+=change;else losses-=change;
  }
  let avgGain=gains/period,avgLoss=losses/period;
  rsi.push(100-(100/(1+(avgGain/avgLoss))));
  for(let i=period+1;i<candles.length;i++){
    const change=candles[i].c-candles[i-1].c;
    avgGain=(avgGain*(period-1)+(change>0?change:0))/period;
    avgLoss=(avgLoss*(period-1)+(change<0?-change:0))/period;
    rsi.push(100-(100/(1+(avgGain/avgLoss))));
  }
  return rsi;
}

function calcBB(candles,period=20,mult=2){
  if(!candles||candles.length<period)return{upper:[],middle:[],lower:[]};
  const sma=calcSMA(candles,period);
  const upper=[],lower=[];
  for(let i=0;i<sma.length;i++){
    const slice=candles.slice(i,i+period);
    const mean=sma[i];
    const variance=slice.reduce((a,c)=>a+Math.pow(c.c-mean,2),0)/period;
    const std=Math.sqrt(variance);
    upper.push(mean+mult*std);
    lower.push(mean-mult*std);
  }
  return{upper,middle:sma,lower};
}

function calcVWAP(candles){
  if(!candles||candles.length<1)return[];
  const vwap=[];
  let cumVolPrice=0,cumVol=0;
  candles.forEach(c=>{
    const typical=(c.h+c.l+c.c)/3;
    cumVolPrice+=typical*c.v;
    cumVol+=c.v;
    vwap.push(cumVolPrice/cumVol);
  });
  return vwap;
}

function calcVolumeProfile(candles,bins=30){
  if(!candles||candles.length<2)return{};
  const min=Math.min(...candles.map(c=>c.l));
  const max=Math.max(...candles.map(c=>c.h));
  const range=max-min;
  const binSize=range/bins;
  const profile={};
  
  for(let i=0;i<bins;i++){
    const priceLevel=min+i*binSize;
    profile[priceLevel.toFixed(2)]=0;
  }
  
  candles.forEach(c=>{
    const avgPrice=(c.h+c.l+c.c)/3;
    const binIdx=Math.floor((avgPrice-min)/binSize);
    const key=(min+binIdx*binSize).toFixed(2);
    if(profile[key]!==undefined)profile[key]+=c.v;
  });
  
  return profile;
}

function calcLiquidationLevels(price){
  // Estimate common leverage liquidation levels
  // Assumes typical leverage: 5x, 10x, 20x, 50x
  // Liq price for LONG = entry * (1 - 1/leverage)
  // Liq price for SHORT = entry * (1 + 1/leverage)
  const levels=[];
  [5,10,20,50].forEach(lev=>{
    levels.push({price:price*(1-1/lev),label:`${lev}x LONG`,type:'long',leverage:lev});
    levels.push({price:price*(1+1/lev),label:`${lev}x SHORT`,type:'short',leverage:lev});
  });
  return levels;
}

/* ═══════════════════════════════════════════
   RENDER ALL
   ═══════════════════════════════════════════ */
function renderAll(){
  updateHeader();
  updateTicker();
  if(activeTab==='overview')renderOverview();
  else if(activeTab==='analysis')renderAnalysis();
  else if(activeTab==='orderbook')renderOrderBookFull();
  else if(activeTab==='relvalue')renderRelValue();
  else if(activeTab==='screener')renderScreener();
  else if(activeTab==='news')renderNewsFull();
  else if(activeTab==='positions')renderPositionsSub();
}

function updateHeader(){
  const d=priceData[activeCoin];if(!d)return;
  const change=((d.price-d.open)/d.open*100);
  const isUp=change>=0;
  document.getElementById('headerPrice').textContent='$'+fmtPrice(d.price);
  document.getElementById('headerPrice').className='hdr-price '+(isUp?'up':'down');
  const el=document.getElementById('headerChange');
  el.textContent=(isUp?'+':'')+change.toFixed(2)+'%';
  el.className='hdr-change '+(isUp?'up':'down');
}

/* ═══════════════════════════════════════════
   TICKER BAR
   ═══════════════════════════════════════════ */
function updateTicker(){
  const items=ALL_TICKERS.map(c=>{
    const d=priceData[c];if(!d)return'';
    const change=((d.price-d.open)/d.open*100);
    const isUp=change>=0;
    const arrow=isUp?'▲':'▼';
    return `<span class="ticker-item"><span class="sym" style="color:${categoryColor(c)}">${cleanSym(c)}</span><span class="price">$${fmtPrice(d.price)}</span><span class="chg ${isUp?'up':'down'}">${arrow}${isUp?'+':''}${change.toFixed(2)}%</span></span>`;
  }).filter(Boolean).join('');
  document.getElementById('tickerTrack').innerHTML=items+items;
}

/* ═══════════════════════════════════════════
   [1] OVERVIEW RENDERING
   ═══════════════════════════════════════════ */
function renderOverview(){
  renderChart();
  renderKeyStats();
  renderContractInfo();
  renderFearGreed();
  renderWhaleAlerts();
  renderWatchlist();
  renderRecentTrades();
}

function renderWhaleAlerts(){
  const el=document.getElementById('whaleAlerts');
  // Simulated whale alerts (in production, fetch from whale-alert.io API)
  const whales=[
    {coin:'BTC',amount:250,usd:17.5e6,type:'transfer',from:'Binance',to:'Unknown',age:'3m ago'},
    {coin:'ETH',amount:8500,usd:23.5e6,type:'transfer',from:'Coinbase',to:'Unknown',age:'12m ago'},
    {coin:'USDT',amount:50e6,usd:50e6,type:'transfer',from:'Tether Treasury',to:'Binance',age:'18m ago'},
    {coin:'SOL',amount:145000,usd:24.9e6,type:'transfer',from:'FTX (Cold)',to:'Unknown',age:'1h ago'},
    {coin:'XRP',amount:92e6,usd:55e6,type:'transfer',from:'Ripple',to:'Bitstamp',age:'2h ago'}
  ];
  
  el.innerHTML=`<div style="font-size:9px;color:var(--muted);padding:8px 12px;background:#0a0a0a">Large transactions (>$10M)</div>`+whales.map(w=>{
    const icon=w.type==='transfer'?'→':'↔';
    return `<div style="padding:8px 12px;border-bottom:1px solid #0f0f0f;font-size:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:2px">
        <span style="font-weight:700;color:${categoryColor(w.coin)}">${icon} ${w.coin}</span>
        <span style="font-size:9px;color:var(--muted)">${w.age}</span>
      </div>
      <div style="color:var(--text);font-weight:600">${fmtCompact(w.amount)} ${w.coin} ($${fmtCompact(w.usd)})</div>
      <div style="font-size:9px;color:var(--dim);margin-top:2px">${w.from} → ${w.to}</div>
    </div>`;
  }).join('')+`<div style="padding:6px 12px;background:#0a0a0a;font-size:8px;color:var(--muted);text-align:center">Demo data • Add whale-alert.io API key for live feeds</div>`;
}

function renderFearGreed(){
  const el=document.getElementById('fearGreedGauge');
  if(!fearGreedData){
    el.innerHTML='<div style="padding:12px;text-align:center;color:var(--muted);font-size:10px">Loading...</div>';
    return;
  }
  const v=fearGreedData.value;
  const cls=fearGreedData.classification;
  let color;
  if(v<=25)color='var(--red)';
  else if(v<=45)color='#ff9800';
  else if(v<=55)color='#ffeb3b';
  else if(v<=75)color='#8bc34a';
  else color='var(--green)';
  el.innerHTML=`
    <div style="padding:12px;text-align:center">
      <div style="font-size:32px;font-weight:800;color:${color}">${v}</div>
      <div style="font-size:10px;color:var(--dim);margin-top:2px">${cls}</div>
      <div style="width:100%;height:6px;background:#1a1a1a;border-radius:3px;margin-top:8px;position:relative;overflow:hidden">
        <div style="position:absolute;left:0;top:0;bottom:0;width:${v}%;background:${color};transition:width 0.5s"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--muted);margin-top:4px">
        <span>Extreme Fear</span><span>Extreme Greed</span>
      </div>
    </div>
  `;
}

function renderKeyStats(){
  const d=priceData[activeCoin];if(!d)return;
  const el=document.getElementById('keyStats');
  const vol=d.volume||0;
  const funding=d.funding||0;
  const oi=d.openInterest||0;
  const mark=d.markPx||d.price;
  el.innerHTML=`
    <div class="ov-right-row"><span class="lbl">Mark Price</span><span class="val">$${fmtPrice(mark)}</span></div>
    <div class="ov-right-row"><span class="lbl">Index Price</span><span class="val">$${fmtPrice(d.price)}</span></div>
    <div class="ov-right-row"><span class="lbl">24H High</span><span class="val up">$${fmtPrice(d.high)}</span></div>
    <div class="ov-right-row"><span class="lbl">24H Low</span><span class="val down">$${fmtPrice(d.low)}</span></div>
    <div class="ov-right-row"><span class="lbl">24H Volume</span><span class="val">$${fmtCompact(vol)}</span></div>
    <div class="ov-right-row"><span class="lbl">Open Interest</span><span class="val">$${fmtCompact(oi*d.price)}</span></div>
    <div class="ov-right-row"><span class="lbl">Funding (8H)</span><span class="val ${funding>=0?'up':'down'}">${(funding*100).toFixed(4)}%</span></div>
    <div class="ov-right-row"><span class="lbl">24H Change</span><span class="val ${((d.price-d.open)/d.open*100)>=0?'up':'down'}">${((d.price-d.open)/d.open*100).toFixed(2)}%</span></div>
  `;
}

function renderContractInfo(){
  const el=document.getElementById('contractInfo');
  const cat=assetCategory(activeCoin);
  if(cat==='crypto'){
    const maxLev=activeCoin==='BTC'||activeCoin==='ETH'?'50x':'20x';
    el.innerHTML=`
      <div class="ov-right-row"><span class="lbl">Exchange</span><span class="val">Hyperliquid</span></div>
      <div class="ov-right-row"><span class="lbl">Type</span><span class="val">Perpetual</span></div>
      <div class="ov-right-row"><span class="lbl">Max Leverage</span><span class="val" style="color:var(--orange)">${maxLev}</span></div>
      <div class="ov-right-row"><span class="lbl">Settlement</span><span class="val">USDC</span></div>`;
  }else if(cat==='stock'){
    el.innerHTML=`
      <div class="ov-right-row"><span class="lbl">Exchange</span><span class="val">NASDAQ/NYSE</span></div>
      <div class="ov-right-row"><span class="lbl">Type</span><span class="val">Equity</span></div>
      <div class="ov-right-row"><span class="lbl">Currency</span><span class="val">USD</span></div>
      <div class="ov-right-row"><span class="lbl">Market Hours</span><span class="val">9:30-16:00 ET</span></div>`;
  }else if(cat==='commodity'){
    el.innerHTML=`
      <div class="ov-right-row"><span class="lbl">Exchange</span><span class="val">NYMEX/COMEX</span></div>
      <div class="ov-right-row"><span class="lbl">Type</span><span class="val">Futures</span></div>
      <div class="ov-right-row"><span class="lbl">Currency</span><span class="val">USD</span></div>`;
  }else{
    el.innerHTML=`
      <div class="ov-right-row"><span class="lbl">Market</span><span class="val">Forex</span></div>
      <div class="ov-right-row"><span class="lbl">Type</span><span class="val">Spot</span></div>
      <div class="ov-right-row"><span class="lbl">Hours</span><span class="val">24/5</span></div>`;
  }
}

function renderWatchlist(){
  const el=document.getElementById('watchlist');
  const cats=[{id:'favorites',label:'FAV'},{id:'all',label:'ALL'},{id:'crypto',label:'CRYPTO'},{id:'stocks',label:'STOCKS'},{id:'commodities',label:'CMDTY'},{id:'forex',label:'FX'}];
  const catBar=cats.map(c=>`<span style="padding:3px 8px;font-size:9px;cursor:pointer;border-radius:2px;font-weight:600;${activeCategory===c.id?'background:var(--orange);color:#000':'color:var(--muted)'}" onclick="activeCategory='${c.id}';renderWatchlist()">${c.label}</span>`).join('');
  const assets=getFilteredAssets();
  const rows=assets.map(c=>{
    const d=priceData[c];if(!d)return'';
    const change=((d.price-d.open)/d.open*100);
    const isUp=change>=0;
    const isFav=favorites.includes(c);
    const star=`<span onclick="event.stopPropagation();toggleFavorite('${c}')" style="cursor:pointer;margin-left:3px;padding:0 3px;font-size:8px;font-weight:700;border-radius:2px;${isFav?'background:var(--orange);color:#000':'border:1px solid var(--muted);color:var(--muted)'}">${isFav?'FAV':'ADD'}</span>`;
    return `<div class="ov-right-row" style="cursor:pointer;${c===activeCoin?'background:#1a1200;border-left:2px solid var(--orange);':'border-left:2px solid transparent;'}" onclick="selectCoin('${c}')">
      <span><span style="font-weight:700;color:${categoryColor(c)}">${cleanSym(c)}</span>${star} <span style="font-size:9px;color:var(--muted)">${displayName(c)}</span></span>
      <span class="${isUp?'up':'down'}" style="font-weight:600">$${fmtPrice(d.price)} <span style="font-size:10px">${isUp?'+':''}${change.toFixed(2)}%</span></span>
    </div>`;
  }).join('');
  el.innerHTML=`<div style="display:flex;gap:2px;padding:6px 12px;border-bottom:1px solid #1a1a1a">${catBar}</div>${rows}`;
}

function renderRecentTrades(){
  const d=priceData[activeCoin];if(!d)return;
  const el=document.getElementById('recentTrades');
  let html='';
  for(let i=0;i<15;i++){
    const side=Math.random()>0.5?'BUY':'SELL';
    const p=d.price*(1+(Math.random()-0.5)*0.0005);
    const size=+(Math.random()*2+0.001).toFixed(3);
    const t=new Date(Date.now()-i*2000-Math.random()*3000);
    html+=`<div class="rt-row"><span style="color:var(--muted)">${t.toLocaleTimeString('en-US',{hour12:false})}</span><span style="color:${side==='BUY'?'var(--green)':'var(--red)'};font-weight:600">${side}</span><span>$${fmtPrice(p)}</span><span style="color:var(--dim)">${size}</span></div>`;
  }
  el.innerHTML=html;
}

/* ═══════════════════════════════════════════
   CHART ZOOM/PAN
   ═══════════════════════════════════════════ */
let chartZoomX=1,chartZoomY=1,chartPanX=0,chartDragState=null;

(function(){
  const body=document.getElementById('chartBody');
  body.addEventListener('mousedown',e=>{
    const rect=body.getBoundingClientRect();
    const isPrice=e.clientX>rect.right-80;
    const isTime=e.clientY>rect.bottom-30;
    let mode='panX';
    if(isPrice)mode='zoomY';else if(isTime)mode='zoomX';
    chartDragState={startX:e.clientX,startY:e.clientY,startPanX:chartPanX,startZoomX:chartZoomX,startZoomY:chartZoomY,mode};
    body.style.cursor=mode==='zoomY'?'ns-resize':mode==='zoomX'?'ew-resize':'grab';
    e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!chartDragState)return;
    if(chartDragState.mode==='panX'){
      const dx=e.clientX-chartDragState.startX;
      const candles=candleData[candleKey(activeCoin,activeTF)];if(!candles)return;
      chartPanX=Math.max(0,Math.min(candles.length-5,chartDragState.startPanX-dx*0.5/chartZoomX));
      body.style.cursor='grabbing';
    }else if(chartDragState.mode==='zoomY'){
      const dy=e.clientY-chartDragState.startY;
      chartZoomY=Math.max(0.2,Math.min(5,chartDragState.startZoomY*(1+dy*0.005)));
    }else if(chartDragState.mode==='zoomX'){
      const dx=e.clientX-chartDragState.startX;
      chartZoomX=Math.max(0.3,Math.min(8,chartDragState.startZoomX*(1+dx*0.005)));
    }
    renderChart();
  });
  document.addEventListener('mouseup',()=>{if(chartDragState){chartDragState=null;body.style.cursor='crosshair'}});
  body.addEventListener('dblclick',()=>{chartZoomX=1;chartZoomY=1;chartPanX=0;document.getElementById('chartScroll').value=100;renderChart()});
  document.getElementById('chartScroll').addEventListener('input',function(){
    const candles=candleData[candleKey(activeCoin,activeTF)];if(!candles)return;
    chartPanX=(candles.length-5)*(1-this.value/100);renderChart();
  });
})();

/* ═══════════════════════════════════════════
   CHART RENDERING
   ═══════════════════════════════════════════ */
function renderChart(){
  const canvas=document.getElementById('chart');
  const ctx=canvas.getContext('2d');
  const rect=canvas.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height;
  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
  const d=priceData[activeCoin];if(!d)return;
  const candles=candleData[candleKey(activeCoin,activeTF)];
  if(chartType==='candle'&&candles&&candles.length>2)drawCandles(ctx,W,H,candles);
  else drawLine(ctx,W,H,d);
  
  // Render drawing tools overlay
  if(typeof renderDrawings === 'function') renderDrawings(canvas, ctx);
}

function drawCandles(ctx,W,H,allCandles){
  const mR=80,mB=30,cW=W-mR,cH=H-mB;
  const visibleCount=Math.max(5,Math.floor(allCandles.length/chartZoomX));
  const startIdx=Math.max(0,allCandles.length-visibleCount-Math.floor(chartPanX));
  const endIdx=Math.min(allCandles.length,startIdx+visibleCount);
  const candles=allCandles.slice(startIdx,endIdx);
  if(candles.length<1)return;

  const dataMin=Math.min(...candles.map(c=>c.l));
  const dataMax=Math.max(...candles.map(c=>c.h));
  const dataMid=(dataMax+dataMin)/2;
  const dataRange=(dataMax-dataMin)||1;
  const zr=dataRange/chartZoomY;
  const min=dataMid-zr/2,max=dataMid+zr/2,range=max-min||1;

  const barW=Math.max(2,Math.min(30,(cW/candles.length)-2));
  const gap=cW/candles.length;

  // Grid
  ctx.strokeStyle='#111';ctx.lineWidth=0.5;ctx.font='9px JetBrains Mono';ctx.fillStyle='#333';
  for(let i=0;i<=8;i++){const y=(i/8)*cH;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cW,y);ctx.stroke();ctx.fillText(fmtPrice(max-(i/8)*range),cW+6,y+3)}

  // Time labels
  ctx.fillStyle='#282828';
  const step=Math.max(1,Math.floor(candles.length/8));
  for(let i=0;i<candles.length;i+=step){
    const x=i*gap+gap/2;const t=new Date(candles[i].t);
    let tl;
    if(activeTF==='1d'||activeTF==='1w')tl=(t.getMonth()+1)+'/'+t.getDate();
    else if(activeTF==='4h')tl=t.getHours().toString().padStart(2,'0')+':00';
    else tl=t.getHours().toString().padStart(2,'0')+':'+t.getMinutes().toString().padStart(2,'0');
    ctx.fillText(tl,x-14,cH+14);
  }

  // Volume bars
  const maxVol=Math.max(...candles.map(c=>c.v));
  candles.forEach((c,i)=>{const x=i*gap+(gap-barW)/2;const vH=(c.v/maxVol)*(cH*0.12);ctx.fillStyle=c.c>=c.o?'rgba(0,200,83,0.08)':'rgba(255,23,68,0.08)';ctx.fillRect(x,cH-vH,barW,vH)});

  // Candles
  candles.forEach((c,i)=>{
    const x=i*gap+gap/2,bx=i*gap+(gap-barW)/2;
    const bull=c.c>=c.o;
    ctx.strokeStyle=bull?'#005f27':'#7a0b20';ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(x,Math.max(0,Math.min(cH,cH-((c.h-min)/range)*cH)));
    ctx.lineTo(x,Math.max(0,Math.min(cH,cH-((c.l-min)/range)*cH)));
    ctx.stroke();
    const oY=Math.max(0,Math.min(cH,cH-((c.o-min)/range)*cH));
    const cY=Math.max(0,Math.min(cH,cH-((c.c-min)/range)*cH));
    ctx.fillStyle=bull?'#00c853':'#ff1744';
    ctx.fillRect(bx,Math.min(oY,cY),barW,Math.max(Math.abs(oY-cY),1));
  });

  // Technical Indicators
  if(indicators.sma20){
    const sma=calcSMA(allCandles,20);
    if(sma.length>0){
      const offset=allCandles.length-sma.length;
      ctx.beginPath();
      sma.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='#2196f3';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
  if(indicators.sma50){
    const sma=calcSMA(allCandles,50);
    if(sma.length>0){
      const offset=allCandles.length-sma.length;
      ctx.beginPath();
      sma.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='#e040fb';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
  if(indicators.ema20){
    const ema=calcEMA(allCandles,20);
    if(ema.length>0){
      const offset=allCandles.length-ema.length;
      ctx.beginPath();
      ema.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='#ffeb3b';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
  if(indicators.bb){
    const bb=calcBB(allCandles,20,2);
    if(bb.upper.length>0){
      const offset=allCandles.length-bb.upper.length;
      // Upper band
      ctx.beginPath();
      bb.upper.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='rgba(156,39,176,0.5)';ctx.lineWidth=1;ctx.stroke();
      // Middle (same as SMA20)
      ctx.beginPath();
      bb.middle.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='rgba(156,39,176,0.8)';ctx.lineWidth=1.5;ctx.stroke();
      // Lower band
      ctx.beginPath();
      bb.lower.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='rgba(156,39,176,0.5)';ctx.lineWidth=1;ctx.stroke();
    }
  }
  if(indicators.vwap){
    const vwap=calcVWAP(allCandles);
    if(vwap.length>0){
      ctx.beginPath();
      vwap.forEach((val,i)=>{
        const idx=i-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='#00bcd4';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
  
  // Volume Profile (horizontal bars on right side)
  if(indicators.volProfile){
    const profile=calcVolumeProfile(allCandles,20);
    const maxVol=Math.max(...Object.values(profile));
    const profileW=60;
    Object.keys(profile).forEach(priceStr=>{
      const price=parseFloat(priceStr);
      const vol=profile[priceStr];
      const y=Math.max(0,Math.min(cH,cH-((price-min)/range)*cH));
      const barW=(vol/maxVol)*profileW;
      ctx.fillStyle='rgba(255,140,0,0.2)';
      ctx.fillRect(cW-profileW,y-2,barW,4);
    });
  }
  
  // Liquidation Levels
  if(indicators.liqLevels){
    const currentPrice=candles[candles.length-1].c;
    const levels=calcLiquidationLevels(currentPrice);
    levels.forEach(liq=>{
      if(liq.price<min||liq.price>max)return; // out of view
      const y=Math.max(0,Math.min(cH,cH-((liq.price-min)/range)*cH));
      ctx.setLineDash([2,4]);
      ctx.strokeStyle=liq.type==='long'?'rgba(0,200,83,0.3)':'rgba(255,23,68,0.3)';
      ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cW,y);ctx.stroke();
      ctx.setLineDash([]);
      ctx.font='8px JetBrains Mono';
      ctx.fillStyle=liq.type==='long'?'rgba(0,200,83,0.6)':'rgba(255,23,68,0.6)';
      ctx.fillText(liq.label,cW-60,y-2);
    });
  }

  // Last price line
  const lastC=candles[candles.length-1].c;
  const lastY=Math.max(10,Math.min(cH-10,cH-((lastC-min)/range)*cH));
  ctx.setLineDash([3,3]);
  ctx.strokeStyle=lastC>=candles[0].o?'rgba(0,200,83,0.5)':'rgba(255,23,68,0.5)';
  ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(0,lastY);ctx.lineTo(cW,lastY);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle=lastC>=candles[0].o?'#00c853':'#ff1744';
  ctx.fillRect(cW,lastY-9,72,18);
  ctx.fillStyle='#000';ctx.font='600 10px JetBrains Mono';
  ctx.fillText(fmtPrice(lastC),cW+4,lastY+3);

  // OHLC
  const last=candles[candles.length-1];
  document.getElementById('ohlcO').textContent=fmtPrice(last.o);
  document.getElementById('ohlcH').textContent=fmtPrice(last.h);
  document.getElementById('ohlcL').textContent=fmtPrice(last.l);
  document.getElementById('ohlcC').textContent=fmtPrice(last.c);
  document.getElementById('ohlcV').textContent=fmtCompact(last.v);
}

function drawLine(ctx,W,H,d){
  if(!d.history||d.history.length<2)return;
  const prices=d.history.map(h=>h.price);
  const mR=80,mB=30,cW=W-mR,cH=H-mB;
  const min=Math.min(...prices)*0.9998,max=Math.max(...prices)*1.0002;
  const range=max-min||1;
  ctx.strokeStyle='#111';ctx.lineWidth=0.5;ctx.font='9px JetBrains Mono';ctx.fillStyle='#333';
  for(let i=0;i<=8;i++){const y=(i/8)*cH;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cW,y);ctx.stroke();ctx.fillText(fmtPrice(max-(i/8)*range),cW+6,y+3)}
  const isUp=prices[prices.length-1]>=prices[0];const lc=isUp?'#00c853':'#ff1744';
  if(chartType==='area'){
    const grad=ctx.createLinearGradient(0,0,0,cH);
    grad.addColorStop(0,isUp?'rgba(0,200,83,0.12)':'rgba(255,23,68,0.12)');
    grad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.beginPath();prices.forEach((p,i)=>{const x=(i/(prices.length-1))*cW,y=cH-((p-min)/range)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
    ctx.lineTo(cW,cH);ctx.lineTo(0,cH);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  }
  ctx.beginPath();prices.forEach((p,i)=>{const x=(i/(prices.length-1))*cW,y=cH-((p-min)/range)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
  ctx.strokeStyle=lc;ctx.lineWidth=1.5;ctx.stroke();
  const lastY=cH-((prices[prices.length-1]-min)/range)*cH;
  ctx.setLineDash([3,3]);ctx.strokeStyle=isUp?'rgba(0,200,83,0.4)':'rgba(255,23,68,0.4)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,lastY);ctx.lineTo(cW,lastY);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle=lc;ctx.fillRect(cW,lastY-9,72,18);ctx.fillStyle='#000';ctx.font='600 10px JetBrains Mono';ctx.fillText('$'+fmtPrice(d.price),cW+4,lastY+3);
}

/* ═══════════════════════════════════════════
   [2] ANALYSIS
   ═══════════════════════════════════════════ */
function renderAnalysis(){
  const d=priceData[activeCoin];if(!d)return;
  const el=document.getElementById('analysisContent');
  const rsi=40+Math.random()*30;
  const macd=(Math.random()-0.5)*2;
  const signal=rsi>60?'BUY':rsi<40?'SELL':'NEUTRAL';
  const signalColor=signal==='BUY'?'var(--green)':signal==='SELL'?'var(--red)':'var(--orange)';
  
  const aiCard=aiInsight?`<div class="analysis-card" style="grid-column:1/-1;background:linear-gradient(135deg,rgba(255,140,0,0.05),rgba(0,0,0,0))">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>AI MARKET INSIGHT</h3>
      <button onclick="fetchAIInsight()" style="background:var(--orange-bg);border:1px solid var(--orange-dim);color:var(--orange);padding:4px 10px;border-radius:3px;cursor:pointer;font-size:9px;font-family:var(--font)">REFRESH</button>
    </div>
    <div style="font-size:12px;color:var(--text);line-height:1.6;margin-top:8px">${aiInsight}</div>
    <div style="font-size:9px;color:var(--muted);margin-top:8px">Generated by Mistral-7B • Auto-refreshes every 5 min</div>
  </div>`:`<div class="analysis-card" style="grid-column:1/-1;text-align:center;padding:20px">
    <div style="color:var(--muted);font-size:11px">Loading AI analysis...</div>
  </div>`;
  
  el.innerHTML=aiCard+`
    <div class="analysis-card">
      <h3>SIGNAL SUMMARY</h3>
      <div style="text-align:center;margin:20px 0">
        <div style="font-size:32px;font-weight:800;color:${signalColor}">${signal}</div>
        <div style="font-size:11px;color:var(--dim);margin-top:4px">Based on 12 technical indicators</div>
      </div>
      <div class="signal-meter">
        <div class="signal-bar" style="background:var(--red-bg);color:var(--red)">SELL</div>
        <div class="signal-bar" style="background:var(--red-bg);color:var(--red);opacity:0.6">WEAK</div>
        <div class="signal-bar" style="background:var(--orange-bg);color:var(--orange)">NEUTRAL</div>
        <div class="signal-bar" style="background:var(--green-bg);color:var(--green);opacity:0.6">WEAK</div>
        <div class="signal-bar" style="background:var(--green-bg);color:var(--green)">BUY</div>
      </div>
      <div class="indicator-row"><span class="name">Moving Averages (7)</span><span class="val up">5 Buy / 2 Sell</span></div>
      <div class="indicator-row"><span class="name">Oscillators (5)</span><span class="val">2 Buy / 1 Sell / 2 Neutral</span></div>
    </div>
    <div class="analysis-card">
      <h3>OSCILLATORS</h3>
      <div class="indicator-row"><span class="name">RSI (14)</span><span class="val ${rsi>60?'up':rsi<40?'down':''}">${rsi.toFixed(1)}</span></div>
      <div class="indicator-row"><span class="name">MACD (12,26,9)</span><span class="val ${macd>=0?'up':'down'}">${macd.toFixed(4)}</span></div>
      <div class="indicator-row"><span class="name">Stochastic %K</span><span class="val">${(30+Math.random()*40).toFixed(1)}</span></div>
      <div class="indicator-row"><span class="name">CCI (20)</span><span class="val">${(-50+Math.random()*200).toFixed(1)}</span></div>
      <div class="indicator-row"><span class="name">Williams %R</span><span class="val">${(-80+Math.random()*60).toFixed(1)}</span></div>
      <div class="indicator-row"><span class="name">ADX (14)</span><span class="val">${(15+Math.random()*30).toFixed(1)}</span></div>
    </div>
    <div class="analysis-card">
      <h3>MOVING AVERAGES</h3>
      ${['SMA 10','SMA 20','SMA 50','SMA 100','SMA 200','EMA 10','EMA 20'].map(ma=>{
        const val=d.price*(0.95+Math.random()*0.1);
        const above=d.price>val;
        return `<div class="indicator-row"><span class="name">${ma}</span><span class="val">${fmtPrice(val)}</span><span class="${above?'up':'down'}" style="font-weight:600;font-size:10px">${above?'BUY':'SELL'}</span></div>`;
      }).join('')}
    </div>
    <div class="analysis-card">
      <h3>SUPPORT & RESISTANCE</h3>
      ${[['R3',1.04],['R2',1.025],['R1',1.012],['Pivot',1.0],['S1',0.988],['S2',0.975],['S3',0.96]].map(([label,mult])=>{
        const val=d.price*mult;
        const isSupport=mult<1;
        const pct=((mult-1)*100);
        return `<div class="sr-level">
          <span style="width:30px;font-weight:700;color:${isSupport?'var(--green)':'var(--red)'}">${label}</span>
          <div class="sr-bar" style="background:${isSupport?'var(--green-bg)':'var(--red-bg)'};width:${Math.abs(pct)*20}%"></div>
          <span style="font-weight:600">$${fmtPrice(val)}</span>
        </div>`;
      }).join('')}
    </div>
    <div class="analysis-card">
      <h3>ECONOMIC CALENDAR (THIS WEEK)</h3>
      ${economicEvents.length===0?'<div style="padding:12px;color:var(--muted);font-size:10px">Loading events...</div>':economicEvents.map(e=>{
        const impactColor=e.impact==='High'?'var(--red)':e.impact==='Medium'?'var(--orange)':'var(--dim)';
        const dateStr=e.date.toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
        return `<div class="indicator-row" style="align-items:flex-start">
          <div style="display:flex;flex-direction:column;gap:2px">
            <span style="font-size:10px;color:${impactColor};font-weight:700">${e.country} • ${e.impact.toUpperCase()}</span>
            <span style="font-size:9px;color:var(--muted)">${dateStr}</span>
          </div>
          <div style="display:flex;flex-direction:column;gap:2px;text-align:right">
            <span style="font-size:10px;font-weight:600">${e.title}</span>
            <span style="font-size:9px;color:var(--dim)">Fcst: ${e.forecast||'—'} | Prev: ${e.previous||'—'}</span>
          </div>
        </div>`;
      }).join('')}
    </div>
  `;
}

/* ═══════════════════════════════════════════
   [3] ORDER BOOK
   ═══════════════════════════════════════════ */
function renderOrderBookFull(){
  const d=priceData[activeCoin];if(!d)return;
  const price=d.price;
  const el=document.getElementById('obList');
  const ob=orderBookData[activeCoin];
  
  let html='';
  let asks,bids;
  
  // Use real L2 data if available (crypto), else generate fake (stocks)
  if(ob&&ob.asks&&ob.bids){
    asks=ob.asks.slice(0,20).reverse(); // top 20 asks, reversed for display
    bids=ob.bids.slice(0,20); // top 20 bids
  }else{
    // Fake data for non-crypto
    asks=[];bids=[];
    for(let i=20;i>=1;i--){
      const off=price*(0.00005*i+Math.random()*0.0001);
      asks.push({price:price+off,size:+(Math.random()*40+1).toFixed(3)});
    }
    for(let i=1;i<=20;i++){
      const off=price*(0.00005*i+Math.random()*0.0001);
      bids.push({price:price-off,size:+(Math.random()*40+1).toFixed(3)});
    }
  }
  
  // Render asks (highest to lowest, so reverse)
  let cum=0;
  const maxSize=Math.max(...asks.map(a=>a.size),...bids.map(b=>b.size));
  asks.forEach(a=>{
    cum+=a.size;
    const pct=(a.size/maxSize)*100;
    html+=`<div class="ob-row2"><div class="ob-bar2" style="width:${pct}%;background:var(--red)"></div><span style="color:var(--red);font-weight:600">${fmtPrice(a.price)}</span><span style="text-align:right;color:var(--dim)">${a.size.toFixed(3)}</span><span style="text-align:right;color:var(--muted)">${cum.toFixed(1)}</span></div>`;
  });
  
  // Mid
  html+=`<div class="ob-mid2"><span class="${d.price>=d.prevPrice?'up':'down'}">$${fmtPrice(price)}</span></div>`;
  
  // Bids
  cum=0;
  bids.forEach(b=>{
    cum+=b.size;
    const pct=(b.size/maxSize)*100;
    html+=`<div class="ob-row2"><div class="ob-bar2" style="width:${pct}%;background:var(--green)"></div><span style="color:var(--green);font-weight:600">${fmtPrice(b.price)}</span><span style="text-align:right;color:var(--dim)">${b.size.toFixed(3)}</span><span style="text-align:right;color:var(--muted)">${cum.toFixed(1)}</span></div>`;
  });
  
  el.innerHTML=html;
  renderDepthCanvas();
}

function renderDepthCanvas(){
  const canvas=document.getElementById('depthCanvas');
  const d=priceData[activeCoin];if(!d||!canvas)return;
  const rect=canvas.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height;
  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
  
  const price=d.price;
  const ob=orderBookData[activeCoin];
  let bidCum=[],askCum=[],bidTotal=0,askTotal=0;
  
  // Use real L2 data if available
  if(ob&&ob.bids&&ob.asks){
    // Build cumulative depth from real data
    ob.bids.slice(0,50).forEach(b=>{
      bidTotal+=b.size;
      bidCum.push({price:b.price,cum:bidTotal});
    });
    ob.asks.slice(0,50).forEach(a=>{
      askTotal+=a.size;
      askCum.push({price:a.price,cum:askTotal});
    });
  }else{
    // Fake data fallback
    const spread=price*0.05,levels=40;
    for(let i=0;i<levels;i++){
      bidTotal+=Math.random()*50+5+(levels-i)*2;
      askTotal+=Math.random()*50+5+(levels-i)*1.5;
      bidCum.push({price:price-(i/levels)*spread,cum:bidTotal});
      askCum.push({price:price+(i/levels)*spread,cum:askTotal});
    }
  }
  const maxCum=Math.max(bidTotal,askTotal);
  const midX=W/2,mB=30,cH=H-mB;
  
  // Title
  ctx.font='600 12px JetBrains Mono';ctx.fillStyle='#ff8c00';
  ctx.fillText('DEPTH — '+activeCoin,12,20);
  
  // Bid fill
  const bidGrad=ctx.createLinearGradient(0,0,0,cH);
  bidGrad.addColorStop(0,'rgba(0,200,83,0.25)');bidGrad.addColorStop(1,'rgba(0,200,83,0.02)');
  ctx.beginPath();ctx.moveTo(midX,cH);
  bidCum.forEach((b,i)=>{ctx.lineTo(midX-(i/levels)*midX,cH-(b.cum/maxCum)*(cH-50))});
  ctx.lineTo(0,cH);ctx.closePath();ctx.fillStyle=bidGrad;ctx.fill();
  ctx.beginPath();ctx.moveTo(midX,cH);
  bidCum.forEach((b,i)=>{ctx.lineTo(midX-(i/levels)*midX,cH-(b.cum/maxCum)*(cH-50))});
  ctx.strokeStyle='#00c853';ctx.lineWidth=2;ctx.stroke();
  
  // Ask fill
  const askGrad=ctx.createLinearGradient(0,0,0,cH);
  askGrad.addColorStop(0,'rgba(255,23,68,0.25)');askGrad.addColorStop(1,'rgba(255,23,68,0.02)');
  ctx.beginPath();ctx.moveTo(midX,cH);
  askCum.forEach((a,i)=>{ctx.lineTo(midX+(i/levels)*midX,cH-(a.cum/maxCum)*(cH-50))});
  ctx.lineTo(W,cH);ctx.closePath();ctx.fillStyle=askGrad;ctx.fill();
  ctx.beginPath();ctx.moveTo(midX,cH);
  askCum.forEach((a,i)=>{ctx.lineTo(midX+(i/levels)*midX,cH-(a.cum/maxCum)*(cH-50))});
  ctx.strokeStyle='#ff1744';ctx.lineWidth=2;ctx.stroke();
  
  // Mid line
  ctx.setLineDash([4,4]);ctx.strokeStyle='#ff8c00';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(midX,30);ctx.lineTo(midX,cH);ctx.stroke();ctx.setLineDash([]);
  
  ctx.font='600 11px JetBrains Mono';ctx.textAlign='center';ctx.fillStyle='#ff8c00';
  ctx.fillText('$'+fmtPrice(price),midX,cH+15);
  ctx.fillStyle='#00c853';ctx.textAlign='left';ctx.fillText('BIDS: '+fmtCompact(bidTotal),12,cH+15);
  ctx.fillStyle='#ff1744';ctx.textAlign='right';ctx.fillText('ASKS: '+fmtCompact(askTotal),W-12,cH+15);ctx.textAlign='left';
}

/* ═══════════════════════════════════════════
   [4] REL VALUE
   ═══════════════════════════════════════════ */
function renderRelValue(){
  // Peer table
  const el=document.getElementById('rvTableBody');
  el.innerHTML=getFilteredAssets().map(c=>{
    const d=priceData[c];if(!d)return'';
    const change24=((d.price-d.open)/d.open*100);
    const change7d=(Math.random()-0.3)*15;
    const vol=d.volume||Math.random()*500e6;
    const funding=d.funding||(Math.random()-0.5)*0.01;
    const oi=d.openInterest||Math.random()*200;
    const isUp=change24>=0;
    return `<div class="rv-row" onclick="selectCoin('${c}')" style="${c===activeCoin?'background:#1a1200;':''}">
      <span class="sym">${c}</span>
      <span style="color:var(--dim)">${fmtCompact(vol*10)}</span>
      <span style="font-weight:600">$${fmtPrice(d.price)}</span>
      <span class="${isUp?'up':'down'}" style="font-weight:600">${isUp?'+':''}${change24.toFixed(2)}%</span>
      <span class="${change7d>=0?'up':'down'}">${change7d>=0?'+':''}${change7d.toFixed(2)}%</span>
      <span style="color:var(--dim)">$${fmtCompact(vol)}</span>
      <span class="${funding>=0?'up':'down'}">${(funding*100).toFixed(4)}%</span>
      <span style="color:var(--dim)">${fmtCompact(oi*d.price)}</span>
      <span></span>
    </div>`;
  }).join('');
  
  // Render comparison chart
  renderRelChart();
}

function renderRelChart(){
  const canvas=document.getElementById('rvChart');
  const rect=canvas.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height;
  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
  
  const colors=['#ff8c00','#00c853','#ff1744','#2196f3','#e040fb','#ffeb3b'];
  const compare=['BTC','ETH','SOL','DOGE','SUI','HYPE'].filter(c=>priceData[c]);
  
  ctx.font='600 11px JetBrains Mono';ctx.fillStyle='#ff8c00';
  ctx.fillText('RELATIVE PERFORMANCE',12,20);
  
  // Legend
  compare.forEach((c,i)=>{
    ctx.fillStyle=colors[i%colors.length];
    ctx.fillRect(12+i*80,30,12,3);
    ctx.fillText(c,28+i*80,34);
  });
  
  const mT=50,mB=30,mR=60,cW=W-mR,cH=H-mT-mB;
  
  // Generate normalized performance lines
  compare.forEach((c,ci)=>{
    const d=priceData[c];if(!d||!d.history||d.history.length<2)return;
    const hist=d.history;
    const base=hist[0].price;
    ctx.beginPath();
    hist.forEach((h,i)=>{
      const x=(i/(hist.length-1))*cW;
      const pct=((h.price-base)/base)*100;
      const y=mT+cH/2-(pct/10)*cH/2; // scale: 10% = half height
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.strokeStyle=colors[ci%colors.length];
    ctx.lineWidth=1.5;ctx.stroke();
  });
  
  // Zero line
  ctx.setLineDash([4,4]);ctx.strokeStyle='#333';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,mT+cH/2);ctx.lineTo(cW,mT+cH/2);ctx.stroke();ctx.setLineDash([]);
  ctx.font='9px JetBrains Mono';ctx.fillStyle='#444';ctx.fillText('0%',cW+6,mT+cH/2+3);
}

document.querySelectorAll('.rv-btn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.rv-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
  renderRelValue();
}));

/* ═══════════════════════════════════════════
   [5] NEWS
   ═══════════════════════════════════════════ */
/* ═══════════════════════════════════════════
   [5] SCREENER
   ═══════════════════════════════════════════ */
function renderScreener(){
  const filter=document.getElementById('screenFilter')?.value||'all';
  const sortBy=document.getElementById('screenSort')?.value||'change';
  
  let assets=ALL_TICKERS.map(sym=>{
    const d=priceData[sym];
    if(!d)return null;
    const change=((d.price-d.open)/d.open*100);
    const volatility=d.high&&d.low?((d.high-d.low)/d.low*100):0;
    return{sym,price:d.price,change,volume:d.volume||0,volatility,cat:assetCategory(sym)};
  }).filter(Boolean);
  
  // Apply filter
  if(filter==='gainers')assets=assets.filter(a=>a.change>0).sort((a,b)=>b.change-a.change);
  else if(filter==='losers')assets=assets.filter(a=>a.change<0).sort((a,b)=>a.change-b.change);
  else if(filter==='volume')assets.sort((a,b)=>b.volume-a.volume);
  else if(filter==='volatile')assets.sort((a,b)=>b.volatility-a.volatility);
  
  // Apply sort
  if(sortBy==='change')assets.sort((a,b)=>b.change-a.change);
  else if(sortBy==='price')assets.sort((a,b)=>b.price-a.price);
  else if(sortBy==='volume')assets.sort((a,b)=>b.volume-a.volume);
  else if(sortBy==='name')assets.sort((a,b)=>a.sym.localeCompare(b.sym));
  
  const el=document.getElementById('screenerTable');
  const header=`<div style="display:grid;grid-template-columns:80px 1fr 100px 80px 90px 80px 1fr;padding:8px 16px;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;border-bottom:1px solid #1a1a1a;position:sticky;top:0;background:#0d0d0d;z-index:1">
    <span>SYMBOL</span><span>NAME</span><span style="text-align:right">PRICE</span><span style="text-align:right">24H %</span><span style="text-align:right">VOLUME</span><span style="text-align:right">VOLATILITY</span><span>CATEGORY</span>
  </div>`;
  const rows=assets.slice(0,100).map(a=>{
    const isUp=a.change>=0;
    return `<div style="display:grid;grid-template-columns:80px 1fr 100px 80px 90px 80px 1fr;padding:6px 16px;font-size:11px;border-bottom:1px solid #0f0f0f;cursor:pointer" onclick="selectCoin('${a.sym}')" onmouseover="this.style.background='#111'" onmouseout="this.style.background='transparent'">
      <span style="font-weight:700;color:${categoryColor(a.sym)}">${cleanSym(a.sym)}</span>
      <span style="color:var(--dim);font-size:10px">${displayName(a.sym)}</span>
      <span style="text-align:right;font-weight:600">$${fmtPrice(a.price)}</span>
      <span style="text-align:right;font-weight:700;color:${isUp?'var(--green)':'var(--red)'}">${isUp?'+':''}${a.change.toFixed(2)}%</span>
      <span style="text-align:right;color:var(--dim)">$${fmtCompact(a.volume)}</span>
      <span style="text-align:right;color:var(--orange)">${a.volatility.toFixed(2)}%</span>
      <span style="font-size:9px;color:var(--muted)">${a.cat.toUpperCase()}</span>
    </div>`;
  }).join('');
  el.innerHTML=header+rows;
}

document.getElementById('screenFilter')?.addEventListener('change',renderScreener);
document.getElementById('screenSort')?.addEventListener('change',renderScreener);

/* ═══════════════════════════════════════════
   [4] GMM (GLOBAL MARKET MONITOR)
   ═══════════════════════════════════════════ */
function renderGMM(){
  const assets=ALL_TICKERS.map(sym=>{
    const d=priceData[sym];
    if(!d)return null;
    const change=((d.price-d.open)/d.open*100);
    const volatility=d.high&&d.low?((d.high-d.low)/d.low*100):0;
    return{sym,price:d.price,change,volume:d.volume||0,volatility};
  }).filter(Boolean);
  
  // Top Gainers
  const gainers=assets.filter(a=>a.change>0).sort((a,b)=>b.change-a.change).slice(0,20);
  document.getElementById('gmmGainers').innerHTML=gainers.map(a=>createGMMRow(a,true)).join('');
  
  // Top Losers
  const losers=assets.filter(a=>a.change<0).sort((a,b)=>a.change-b.change).slice(0,20);
  document.getElementById('gmmLosers').innerHTML=losers.map(a=>createGMMRow(a,false)).join('');
  
  // Volume Leaders
  const volume=assets.sort((a,b)=>b.volume-a.volume).slice(0,20);
  document.getElementById('gmmVolume').innerHTML=volume.map(a=>createGMMRow(a,a.change>=0)).join('');
  
  // Most Volatile
  const volatile=assets.sort((a,b)=>b.volatility-a.volatility).slice(0,20);
  document.getElementById('gmmVolatile').innerHTML=volatile.map(a=>createGMMRow(a,a.change>=0)).join('');
}

function createGMMRow(asset,isUp){
  return `<div style="display:grid;grid-template-columns:80px 1fr 100px;padding:8px 16px;border-bottom:1px solid #0f0f0f;cursor:pointer;font-size:11px" onclick="selectCoin('${asset.sym}')" onmouseover="this.style.background='#111'" onmouseout="this.style.background='transparent'">
    <span style="font-weight:700;color:${categoryColor(asset.sym)}">${cleanSym(asset.sym)}</span>
    <span style="text-align:right;font-weight:600;color:var(--white)">$${fmtPrice(asset.price)}</span>
    <span style="text-align:right;font-weight:700;font-size:13px;color:${isUp?'var(--green)':'var(--red)'}">${isUp?'+':''}${asset.change.toFixed(2)}%</span>
  </div>`;
}

/* ═══════════════════════════════════════════
   [6] PORTFOLIO (Bloomberg PORT)
   ═══════════════════════════════════════════ */
let portfolioPositions=[];

// Load portfolio from localStorage
function loadPortfolio(){
  try{
    const saved=localStorage.getItem('omar_terminal_portfolio');
    if(saved){
      portfolioPositions=JSON.parse(saved);
    }
  }catch(e){
    console.error('Failed to load portfolio:',e);
    portfolioPositions=[];
  }
}

// Save portfolio to localStorage
function savePortfolio(){
  try{
    localStorage.setItem('omar_terminal_portfolio',JSON.stringify(portfolioPositions));
  }catch(e){
    console.error('Failed to save portfolio:',e);
  }
}

function renderPortfolio(){
  // Calculate summary stats
  let totalValue=0;
  let totalPnL=0;
  let totalCost=0;
  let wins=0;
  let total=portfolioPositions.length;
  
  portfolioPositions.forEach(pos=>{
    const d=priceData[pos.symbol];
    if(!d)return;
    
    const currentPrice=d.price;
    const positionValue=pos.size*currentPrice;
    const costBasis=pos.size*pos.entryPrice;
    const pnl=positionValue-costBasis;
    
    totalValue+=positionValue;
    totalPnL+=pnl;
    totalCost+=costBasis;
    
    if(pnl>0)wins++;
  });
  
  const winRate=total>0?(wins/total*100):0;
  const dayPnL=totalPnL*0.1; // Placeholder - would need historical data for real day P&L
  
  // Update summary
  document.getElementById('portTotalValue').textContent='$'+fmtCompact(totalValue);
  document.getElementById('portTotalPnL').textContent=(totalPnL>=0?'+':'')+' $'+fmtCompact(Math.abs(totalPnL));
  document.getElementById('portTotalPnL').style.color=totalPnL>=0?'var(--green)':'var(--red)';
  document.getElementById('portDayPnL').textContent=(dayPnL>=0?'+':'')+' $'+fmtCompact(Math.abs(dayPnL));
  document.getElementById('portDayPnL').style.color=dayPnL>=0?'var(--green)':'var(--red)';
  document.getElementById('portPositionCount').textContent=total;
  document.getElementById('portWinRate').textContent=winRate.toFixed(1)+'%';
  
  // Render positions table
  const rows=portfolioPositions.map((pos,idx)=>{
    const d=priceData[pos.symbol];
    if(!d)return '';
    
    const currentPrice=d.price;
    const positionValue=pos.size*currentPrice;
    const costBasis=pos.size*pos.entryPrice;
    const pnl=positionValue-costBasis;
    const pnlPct=(pnl/costBasis)*100;
    
    return `<div style="display:grid;grid-template-columns:100px 80px 100px 100px 100px 100px 100px 80px 60px;padding:8px 12px;border-bottom:1px solid #0f0f0f;font-size:11px" onmouseover="this.style.background='#111'" onmouseout="this.style.background='transparent'">
      <span style="font-weight:700;color:${categoryColor(pos.symbol)};cursor:pointer" onclick="selectCoin('${pos.symbol}')">${cleanSym(pos.symbol)}</span>
      <span style="font-weight:600;color:${pos.side==='LONG'?'var(--green)':'var(--red)'}">${pos.side}</span>
      <span style="text-align:right;color:var(--dim)">$${fmtPrice(pos.entryPrice)}</span>
      <span style="text-align:right;font-weight:600">$${fmtPrice(currentPrice)}</span>
      <span style="text-align:right;color:var(--white)">${pos.size.toFixed(4)}</span>
      <span style="text-align:right;font-weight:600;color:var(--white)">$${fmtCompact(positionValue)}</span>
      <span style="text-align:right;font-weight:700;color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}$${fmtCompact(Math.abs(pnl))}</span>
      <span style="text-align:right;font-weight:700;color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}${pnlPct.toFixed(2)}%</span>
      <span style="text-align:center;cursor:pointer;color:var(--red);font-weight:700" onclick="removePosition(${idx})" title="Close position">×</span>
    </div>`;
  }).join('');
  
  document.getElementById('portfolioPositions').innerHTML=rows || '<div style="padding:40px;text-align:center;color:var(--muted);font-size:11px">No positions. Click "+ ADD POSITION" to start tracking.</div>';
}

function showAddPositionModal(){
  const modal=document.createElement('div');
  modal.style.cssText=`position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:10000`;
  
  modal.innerHTML=`
    <div style="background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:24px;width:450px;font-family:var(--font)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <span style="font-size:14px;font-weight:800;color:var(--orange);letter-spacing:0.1em">ADD POSITION</span>
        <span onclick="this.closest('[style*=fixed]').remove()" style="cursor:pointer;color:var(--muted);font-size:20px">×</span>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:16px">
        <div>
          <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:6px;letter-spacing:0.08em">SYMBOL</label>
          <input type="text" id="posSymbol" placeholder="BTC" style="width:100%;background:var(--bg3);border:1px solid #333;color:var(--text);padding:8px 12px;font-family:var(--font);font-size:12px;border-radius:3px" />
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:6px;letter-spacing:0.08em">SIDE</label>
            <select id="posSide" style="width:100%;background:var(--bg3);border:1px solid #333;color:var(--text);padding:8px 12px;font-family:var(--font);font-size:12px;border-radius:3px">
              <option value="LONG">LONG</option>
              <option value="SHORT">SHORT</option>
            </select>
          </div>
          
          <div>
            <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:6px;letter-spacing:0.08em">SIZE</label>
            <input type="number" id="posSize" placeholder="1.0" step="0.0001" style="width:100%;background:var(--bg3);border:1px solid #333;color:var(--text);padding:8px 12px;font-family:var(--font);font-size:12px;border-radius:3px" />
          </div>
        </div>
        
        <div>
          <label style="font-size:10px;color:var(--muted);display:block;margin-bottom:6px;letter-spacing:0.08em">ENTRY PRICE</label>
          <input type="number" id="posEntry" placeholder="0.00" step="0.01" style="width:100%;background:var(--bg3);border:1px solid #333;color:var(--text);padding:8px 12px;font-family:var(--font);font-size:12px;border-radius:3px" />
        </div>
        
        <div style="display:flex;gap:8px;margin-top:8px">
          <button onclick="addPositionFromModal()" style="flex:1;background:var(--orange);color:#000;border:none;padding:10px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;border-radius:3px;letter-spacing:0.08em">ADD POSITION</button>
          <button onclick="this.closest('[style*=fixed]').remove()" style="flex:1;background:transparent;color:var(--muted);border:1px solid #333;padding:10px;font-family:var(--font);font-size:11px;font-weight:600;cursor:pointer;border-radius:3px">CANCEL</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.getElementById('posSymbol').focus();
}

function addPositionFromModal(){
  const symbol=document.getElementById('posSymbol').value.trim().toUpperCase();
  const side=document.getElementById('posSide').value;
  const size=parseFloat(document.getElementById('posSize').value);
  const entryPrice=parseFloat(document.getElementById('posEntry').value);
  
  if(!symbol||!size||!entryPrice){
    alert('Please fill in all fields');
    return;
  }
  
  // Check if asset exists
  if(!ALL_TICKERS.includes(symbol)){
    alert('Asset not found. Available: '+ALL_TICKERS.join(', '));
    return;
  }
  
  portfolioPositions.push({
    symbol,
    side,
    size,
    entryPrice,
    timestamp:Date.now()
  });
  
  savePortfolio();
  renderPortfolio();
  
  // Close modal
  document.querySelector('[style*="position:fixed"]')?.remove();
}

function removePosition(index){
  if(confirm('Close this position?')){
    portfolioPositions.splice(index,1);
    savePortfolio();
    renderPortfolio();
  }
}

function clearAllPositions(){
  if(confirm('Clear all positions? This cannot be undone.')){
    portfolioPositions=[];
    savePortfolio();
    renderPortfolio();
  }
}

// Load portfolio on startup
loadPortfolio();

function timeAgo(date){
  const now=Date.now();
  const diff=now-date.getTime();
  const mins=Math.floor(diff/60000);
  const hrs=Math.floor(diff/3600000);
  if(mins<1)return'just now';
  if(mins<60)return mins+'m ago';
  if(hrs<24)return hrs+'h ago';
  return Math.floor(hrs/24)+'d ago';
}

function renderNewsFull(){
  const el=document.getElementById('newsList');
  if(newsData.length===0){
    el.innerHTML='<div style="padding:20px;text-align:center;color:var(--muted)">Loading news...</div>';
    return;
  }
  el.innerHTML=newsData.map(n=>`<div class="news-card" onclick="window.open('${n.url}','_blank')" style="cursor:pointer">
    <div class="time">${timeAgo(n.time)}</div>
    <div class="headline">${n.title}</div>
    <div class="source">${n.source}</div>
  </div>`).join('');
}

/* ═══════════════════════════════════════════
   [6] POSITIONS
   ═══════════════════════════════════════════ */
document.querySelectorAll('.pos-subtab').forEach(t=>t.addEventListener('click',()=>{
  activePosSub=t.dataset.sub;
  document.querySelectorAll('.pos-subtab').forEach(x=>x.classList.toggle('active',x.dataset.sub===activePosSub));
  renderPositionsSub();
}));

function renderPositionsSub(){
  const el=document.getElementById('posContent');
  if(activePosSub==='positions')renderPositions(el);
  else if(activePosSub==='orders')renderOrders(el);
  else if(activePosSub==='history')renderHistory(el);
  else if(activePosSub==='account')renderAccount(el);
}

function renderPositions(el){
  const positions=[
    {sym:'BTC',side:'LONG',size:'0.150',entry:'96,842.50',mark:'97,220.00',liq:'91,200.00',pnl:'+$56.63',roe:'+4.15%',margin:'$1,452',up:true},
    {sym:'ETH',side:'SHORT',size:'2.500',entry:'2,784.20',mark:'2,758.40',liq:'3,012.00',pnl:'+$64.50',roe:'+3.72%',margin:'$834',up:true},
    {sym:'SOL',side:'LONG',size:'45.00',entry:'168.42',mark:'171.88',liq:'152.10',pnl:'+$155.70',roe:'+6.82%',margin:'$1,516',up:true},
    {sym:'DOGE',side:'LONG',size:'10,000',entry:'0.25410',mark:'0.24980',liq:'0.22100',pnl:'-$43.00',roe:'-1.69%',margin:'$508',up:false},
    {sym:'HYPE',side:'LONG',size:'120',entry:'24.50',mark:'25.12',liq:'20.80',pnl:'+$74.40',roe:'+5.06%',margin:'$588',up:true},
  ];
  el.innerHTML=`
    <div class="pos-head"><span>SYMBOL</span><span>SIDE</span><span>SIZE</span><span>ENTRY</span><span>MARK</span><span>LIQ</span><span>PnL</span><span>ROE%</span><span>MARGIN</span></div>
    ${positions.map(p=>`<div class="pos-row">
      <span class="pos-sym">${p.sym}</span>
      <span><span class="pos-badge ${p.side==='LONG'?'pos-long':'pos-short'}">${p.side}</span></span>
      <span>${p.size}</span><span>$${p.entry}</span><span>$${p.mark}</span>
      <span style="color:var(--red-dim)">${p.liq}</span>
      <span class="${p.up?'up':'down'}" style="font-weight:700">${p.pnl}</span>
      <span class="${p.up?'up':'down'}" style="font-weight:600">${p.roe}</span>
      <span style="color:var(--dim)">${p.margin}</span>
    </div>`).join('')}
    <div style="padding:8px 12px;font-size:11px;color:var(--green);font-weight:700;border-top:1px solid #1a1a1a">TOTAL UNREALIZED PnL: +$308.23</div>
  `;
}

function renderOrders(el){
  const orders=[
    {sym:'BTC',side:'BUY',type:'LIMIT',price:'$66,500.00',size:'0.200',status:'OPEN',time:'14:32:01'},
    {sym:'ETH',side:'SELL',type:'LIMIT',price:'$2,850.00',size:'5.000',status:'OPEN',time:'13:45:22'},
    {sym:'SOL',side:'BUY',type:'STOP',price:'$165.00',size:'30.00',status:'PENDING',time:'12:10:45'},
    {sym:'HYPE',side:'BUY',type:'LIMIT',price:'$23.00',size:'200',status:'OPEN',time:'11:55:33'},
  ];
  el.innerHTML=`
    <div class="pos-head"><span>SYMBOL</span><span>SIDE</span><span>TYPE</span><span>PRICE</span><span>SIZE</span><span>STATUS</span><span>TIME</span><span></span><span></span></div>
    ${orders.map(o=>`<div class="pos-row">
      <span class="pos-sym">${o.sym}</span>
      <span><span class="pos-badge ${o.side==='BUY'?'pos-long':'pos-short'}">${o.side}</span></span>
      <span style="color:var(--dim)">${o.type}</span><span>${o.price}</span><span>${o.size}</span>
      <span style="color:${o.status==='OPEN'?'var(--green)':'var(--orange)'}">${o.status}</span>
      <span style="color:var(--muted)">${o.time}</span><span></span><span></span>
    </div>`).join('')}
  `;
}

function renderHistory(el){
  const trades=[
    {sym:'BTC',side:'SELL',price:'$97,100',size:'0.100',pnl:'+$142.00',time:'22:15',date:'02/25',up:true},
    {sym:'ETH',side:'BUY',price:'$2,784',size:'2.500',pnl:'—',time:'21:45',date:'02/25'},
    {sym:'SOL',side:'SELL',price:'$172.80',size:'20.00',pnl:'+$87.20',time:'15:22',date:'02/25',up:true},
    {sym:'DOGE',side:'SELL',price:'$0.261',size:'5,000',pnl:'+$34.50',time:'19:12',date:'02/25',up:true},
    {sym:'BTC',side:'BUY',price:'$96,200',size:'0.050',pnl:'-$18.30',time:'18:05',date:'02/25',up:false},
  ];
  el.innerHTML=`
    <div class="pos-head"><span>SYMBOL</span><span>SIDE</span><span>PRICE</span><span>SIZE</span><span>PnL</span><span>TIME</span><span>DATE</span><span></span><span></span></div>
    ${trades.map(t=>`<div class="pos-row">
      <span class="pos-sym">${t.sym}</span>
      <span><span class="pos-badge ${t.side==='BUY'?'pos-long':'pos-short'}">${t.side}</span></span>
      <span>${t.price}</span><span>${t.size}</span>
      <span class="${t.up===true?'up':t.up===false?'down':''}" style="font-weight:600">${t.pnl}</span>
      <span style="color:var(--muted)">${t.time}</span><span style="color:var(--muted)">${t.date}</span><span></span><span></span>
    </div>`).join('')}
  `;
}

function renderAccount(el){
  el.innerHTML=`
    <div class="account-grid">
      <div class="account-cell"><div class="lbl">ACCOUNT EQUITY</div><div class="val">$12,458.63</div></div>
      <div class="account-cell"><div class="lbl">AVAILABLE BALANCE</div><div class="val" style="color:var(--green)">$7,560.40</div></div>
      <div class="account-cell"><div class="lbl">MARGIN USED</div><div class="val" style="color:var(--orange)">$4,898.23</div></div>
      <div class="account-cell"><div class="lbl">UNREALIZED PnL</div><div class="val up">+$308.23</div></div>
      <div class="account-cell"><div class="lbl">REALIZED PnL (TODAY)</div><div class="val up">+$271.20</div></div>
      <div class="account-cell"><div class="lbl">TOTAL PnL (24H)</div><div class="val up">+$579.43</div></div>
      <div class="account-cell"><div class="lbl">MARGIN RATIO</div><div class="val" style="color:var(--green)">39.3%</div></div>
      <div class="account-cell"><div class="lbl">AVG LEVERAGE</div><div class="val" style="color:var(--orange)">8.2x</div></div>
      <div class="account-cell"><div class="lbl">OPEN POSITIONS</div><div class="val">5</div></div>
    </div>
  `;
}

/* ═══════════════════════════════════════════
   KEYBOARD SHORTCUTS
   ═══════════════════════════════════════════ */
document.addEventListener('keydown',e=>{
  if(document.activeElement===coinInput)return;
  
  // Tab switching (1-8) - Bloomberg style
  if(e.key==='1')switchTab('overview');
  else if(e.key==='2')switchTab('analysis');
  else if(e.key==='3')switchTab('orderbook');
  else if(e.key==='4')switchTab('gmm'); // GMM - Global Market Monitor
  else if(e.key==='5')switchTab('screener'); // EQS - Equity Screener
  else if(e.key==='6')switchTab('portfolio'); // PORT - Portfolio Manager
  else if(e.key==='7')switchTab('news');
  else if(e.key==='8')switchTab('relvalue');
  
  // Search
  else if(e.key==='/'){e.preventDefault();coinInput.focus()}
  
  // Timeframe switching (Shift + 1-7)
  else if(e.shiftKey&&e.key==='!'){switchTimeframe('1m')} // Shift+1
  else if(e.shiftKey&&e.key==='@'){switchTimeframe('5m')} // Shift+2
  else if(e.shiftKey&&e.key==='#'){switchTimeframe('15m')} // Shift+3
  else if(e.shiftKey&&e.key==='$'){switchTimeframe('1h')} // Shift+4
  else if(e.shiftKey&&e.key==='%'){switchTimeframe('4h')} // Shift+5
  else if(e.shiftKey&&e.key==='^'){switchTimeframe('1d')} // Shift+6
  else if(e.shiftKey&&e.key==='&'){switchTimeframe('1w')} // Shift+7
  
  // Watchlist navigation (j/k vim-style)
  else if(e.key==='j'){
    const idx=ALL_TICKERS.indexOf(activeCoin);
    if(idx<ALL_TICKERS.length-1)selectCoin(ALL_TICKERS[idx+1]);
  }
  else if(e.key==='k'){
    const idx=ALL_TICKERS.indexOf(activeCoin);
    if(idx>0)selectCoin(ALL_TICKERS[idx-1]);
  }
  
  // Category cycling (c)
  else if(e.key==='c'){
    const cats=['all','favorites','crypto','stocks','commodities','forex'];
    const idx=cats.indexOf(activeCategory);
    activeCategory=cats[(idx+1)%cats.length];
    renderWatchlist();
  }
  
  // Toggle favorite (f)
  else if(e.key==='f'){toggleFavorite(activeCoin)}
  
  // Indicator toggles (Alt + letter)
  else if(e.altKey&&e.key==='s'){indicators.sma20=!indicators.sma20;document.getElementById('ind-sma20')?.classList.toggle('active');saveSettings();renderChart()}
  else if(e.altKey&&e.key==='e'){indicators.ema20=!indicators.ema20;document.getElementById('ind-ema20')?.classList.toggle('active');saveSettings();renderChart()}
  else if(e.altKey&&e.key==='b'){indicators.bb=!indicators.bb;document.getElementById('ind-bb')?.classList.toggle('active');saveSettings();renderChart()}
  else if(e.altKey&&e.key==='v'){indicators.vwap=!indicators.vwap;document.getElementById('ind-vwap')?.classList.toggle('active');saveSettings();renderChart()}
  
  // Reset zoom (Escape or r)
  else if(e.key==='Escape'||e.key==='r'){chartZoomX=1;chartZoomY=1;chartPanX=0;document.getElementById('chartScroll').value=100;renderChart()}
  
  // Refresh data (Ctrl+R or F5)
  else if((e.ctrlKey&&e.key==='r')||e.key==='F5'){e.preventDefault();fetchPrices();fetchStocks();fetchOrderBook(activeCoin)}
  
  // Create price alert (Alt+A)
  else if(e.altKey&&e.key==='a'){
    const d=priceData[activeCoin];
    if(!d)return;
    const target=prompt(`Create price alert for ${activeCoin} (current: $${fmtPrice(d.price)})\nEnter target price:`);
    if(!target||isNaN(parseFloat(target)))return;
    const price=parseFloat(target);
    const condition=price>d.price?'above':'below';
    addPriceAlert(activeCoin,price,condition);
    alert(`Alert set: ${activeCoin} ${condition} $${fmtPrice(price)}`);
  }
  
  // Bloomberg-style function shortcuts
  else if(e.altKey&&e.key==='g'){switchTab('gmm')} // Alt+G → GMM (Global Market Monitor)
  else if(e.altKey&&e.key==='p'){switchTab('portfolio')} // Alt+P → PORT (Portfolio)
  else if(e.altKey&&e.key==='e'){switchTab('screener')} // Alt+E → EQS (Screener)
  else if(e.altKey&&e.key==='n'){switchTab('news')} // Alt+N → News
  
  // Quick add position (Ctrl+P)
  else if(e.ctrlKey&&e.key==='p'){e.preventDefault();showAddPositionModal()}
  
  // Toggle sound (Alt+M for mute)
  else if(e.altKey&&e.key==='m'){soundEnabled=!soundEnabled;saveSettings();alert(soundEnabled?'Sound enabled':'Sound muted')}
  
  // Toggle theme (Alt+T)
  else if(e.altKey&&e.key==='t'){toggleTheme()}
  
  // Layout manager (Alt+L)
  else if(e.altKey&&e.key==='l'){showLayoutManager()}
  
  // Export chart as PNG (Ctrl+P)
  else if(e.ctrlKey&&e.key==='p'){e.preventDefault();exportChartPNG()}
  
  // Download CSV (Ctrl+D)
  else if(e.ctrlKey&&e.key==='d'){e.preventDefault();downloadCSV()}
  
  // Help (?)
  else if(e.key==='?'){alert(`KEYBOARD SHORTCUTS:
1-6: Switch tabs
Shift+1-7: Change timeframe
j/k: Next/prev coin (vim-style)
c: Cycle category filters
f: Toggle favorite
/: Focus search
Alt+S/E/B/V: Toggle indicators
r/Esc: Reset zoom
Ctrl+R/F5: Refresh data
?: This help`);}
});

/* ═══════════════════════════════════════════
   TF + TYPE BUTTONS
   ═══════════════════════════════════════════ */
document.querySelectorAll('.tf-btn').forEach(b=>b.addEventListener('click',()=>switchTimeframe(b.dataset.tf)));
document.querySelectorAll('.type-btn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.type-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
  chartType=b.dataset.type;renderChart();
}));

// Indicator toggles
['sma20','sma50','ema20','bb','vwap','rsi','volProfile','liqLevels'].forEach(ind=>{
  const btn=document.getElementById('ind-'+ind);
  if(!btn)return;
  if(indicators[ind])btn.classList.add('active');
  btn.addEventListener('click',()=>{
    indicators[ind]=!indicators[ind];
    btn.classList.toggle('active');
    saveSettings(); // Save indicator preferences
    renderChart();
  });
});

window.addEventListener('resize',()=>{renderChart();if(activeTab==='orderbook')renderDepthCanvas();if(activeTab==='relvalue')renderRelChart()});

/* ═══════════════════════════════════════════
   BOOT
   ═══════════════════════════════════════════ */
loadFromURL();
loadSavedLayouts();
loadSettings();
fetchPrices();
fetchMeta();
fetchStocks();
fetchOrderBook(activeCoin);
fetchFearGreed();
fetchCryptoNews();
fetchAIInsight();
fetchEconomicCalendar();
setInterval(fetchPrices,3000);
setInterval(fetchMeta,15000);
setInterval(fetchStocks,10000);
setInterval(()=>fetchOrderBook(activeCoin),2000);
setInterval(fetchFearGreed,60000);
setInterval(fetchCryptoNews,120000); // News every 2 min
setInterval(fetchAIInsight,300000); // AI insight every 5 min
setInterval(fetchEconomicCalendar,3600000); // Economic calendar every hour
setInterval(()=>{if(activeTab==='overview')renderRecentTrades()},5000);

/* ═══════════════════════════════════════════
   DRAWING TOOLS SYSTEM
   Complete charting tools with persistence
   ═══════════════════════════════════════════ */

// Drawing state
let activeTool = null;
let drawings = {}; // per coin-timeframe key
let activeDrawing = null;
let selectedDrawing = null;
let drawingInProgress = false;

// Tool types
const TOOLS = {
  HLINE: 'hline',
  TRENDLINE: 'trendline',
  FIB_RET: 'fib_ret',
  FIB_EXT: 'fib_ext',
  RECTANGLE: 'rectangle',
  RULER: 'ruler',
  TEXT: 'text'
};

// Initialize drawings from localStorage
function loadDrawings() {
  try {
    const saved = localStorage.getItem('omar_terminal_drawings');
    if (saved) {
      drawings = JSON.parse(saved);
    }
  } catch (e) {
    console.error('Failed to load drawings:', e);
    drawings = {};
  }
}

// Save drawings to localStorage
function saveDrawings() {
  try {
    localStorage.setItem('omar_terminal_drawings', JSON.stringify(drawings));
  } catch (e) {
    console.error('Failed to save drawings:', e);
  }
}

// Get current drawing key
function getDrawingKey() {
  return `${activeCoin}_${activeTF}`;
}

// Get or initialize drawings for current chart
function getCurrentDrawings() {
  const key = getDrawingKey();
  if (!drawings[key]) {
    drawings[key] = [];
  }
  return drawings[key];
}

// Set active tool
function setDrawingTool(tool) {
  activeTool = activeTool === tool ? null : tool;
  
  // Update toolbar button states
  document.querySelectorAll('.draw-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tool === activeTool);
  });
  
  // Change cursor
  const chartBody = document.getElementById('chartBody');
  if (activeTool) {
    chartBody.style.cursor = 'crosshair';
  } else {
    chartBody.style.cursor = 'default';
  }
}

// Create drawing object from mouse coordinates
function createDrawing(tool, x1, y1, x2, y2) {
  const drawing = {
    id: Date.now() + Math.random(),
    tool,
    x1, y1, x2, y2,
    color: '#ff8c00',
    lineWidth: 2,
    text: tool === TOOLS.TEXT ? 'Text' : null,
    label: null, // Custom label for any drawing
    alertEnabled: false, // Alert when price crosses this drawing
    alertCrossed: false, // Track if alert has triggered
    timestamp: Date.now()
  };
  
  return drawing;
}

// Convert canvas coordinates to price/time
function canvasToPriceTime(canvas, canvasX, canvasY) {
  const rect = canvas.parentElement.getBoundingClientRect();
  const candles = candleData[candleKey(activeCoin, activeTF)];
  if (!candles || candles.length < 2) return null;
  
  const mR = 80, mB = 30;
  const cW = rect.width - mR;
  const cH = rect.height - mB;
  
  // Calculate visible candles based on zoom/pan
  const visibleCount = Math.max(5, Math.floor(candles.length / chartZoomX));
  const startIdx = Math.max(0, candles.length - visibleCount - Math.floor(chartPanX));
  const endIdx = Math.min(candles.length, startIdx + visibleCount);
  const visibleCandles = candles.slice(startIdx, endIdx);
  
  if (visibleCandles.length < 1) return null;
  
  // Calculate price range
  const dataMin = Math.min(...visibleCandles.map(c => c.l));
  const dataMax = Math.max(...visibleCandles.map(c => c.h));
  const dataMid = (dataMax + dataMin) / 2;
  const dataRange = (dataMax - dataMin) || 1;
  const zr = dataRange / chartZoomY;
  const min = dataMid - zr / 2;
  const max = dataMid + zr / 2;
  const range = max - min || 1;
  
  // Convert canvas X to candle index
  const gap = cW / visibleCandles.length;
  const candleIdx = Math.floor(canvasX / gap);
  const time = visibleCandles[Math.min(candleIdx, visibleCandles.length - 1)]?.t || Date.now();
  
  // Convert canvas Y to price
  const price = max - (canvasY / cH) * range;
  
  return { price, time, candleIdx: startIdx + candleIdx };
}

// Convert price/time to canvas coordinates
function priceTimeToCanvas(canvas, price, candleIdx) {
  const rect = canvas.parentElement.getBoundingClientRect();
  const candles = candleData[candleKey(activeCoin, activeTF)];
  if (!candles || candles.length < 2) return null;
  
  const mR = 80, mB = 30;
  const cW = rect.width - mR;
  const cH = rect.height - mB;
  
  // Calculate visible candles
  const visibleCount = Math.max(5, Math.floor(candles.length / chartZoomX));
  const startIdx = Math.max(0, candles.length - visibleCount - Math.floor(chartPanX));
  const endIdx = Math.min(candles.length, startIdx + visibleCount);
  const visibleCandles = candles.slice(startIdx, endIdx);
  
  if (visibleCandles.length < 1) return null;
  
  // Calculate price range
  const dataMin = Math.min(...visibleCandles.map(c => c.l));
  const dataMax = Math.max(...visibleCandles.map(c => c.h));
  const dataMid = (dataMax + dataMin) / 2;
  const dataRange = (dataMax - dataMin) || 1;
  const zr = dataRange / chartZoomY;
  const min = dataMid - zr / 2;
  const max = dataMid + zr / 2;
  const range = max - min || 1;
  
  // Convert price to canvas Y
  const y = cH - ((price - min) / range) * cH;
  
  // Convert candle index to canvas X
  const gap = cW / visibleCandles.length;
  const relIdx = candleIdx - startIdx;
  const x = relIdx * gap + gap / 2;
  
  return { x: Math.max(0, Math.min(cW, x)), y: Math.max(0, Math.min(cH, y)) };
}

// Draw all drawings on canvas
function renderDrawings(canvas, ctx) {
  const currentDrawings = getCurrentDrawings();
  if (currentDrawings.length === 0 && !activeDrawing) return;
  
  const rect = canvas.parentElement.getBoundingClientRect();
  const mR = 80, mB = 30;
  const cW = rect.width - mR;
  const cH = rect.height - mB;
  
  ctx.save();
  
  // Draw saved drawings
  currentDrawings.forEach(drawing => {
    renderSingleDrawing(ctx, drawing, cW, cH, false);
  });
  
  // Draw active drawing being created
  if (activeDrawing) {
    renderSingleDrawing(ctx, activeDrawing, cW, cH, true);
  }
  
  ctx.restore();
}

// Render a single drawing
function renderSingleDrawing(ctx, drawing, cW, cH, isActive) {
  ctx.strokeStyle = isActive ? '#ffcc00' : drawing.color;
  ctx.fillStyle = isActive ? '#ffcc00' : drawing.color;
  ctx.lineWidth = drawing.lineWidth;
  ctx.font = '12px JetBrains Mono';
  
  const canvas = document.getElementById('chart');
  
  // Get canvas coordinates for drawing points
  const pt1 = canvasToPriceTime(canvas, drawing.x1, drawing.y1);
  const pt2 = canvasToPriceTime(canvas, drawing.x2, drawing.y2);
  
  if (!pt1 || !pt2) return;
  
  const coords1 = priceTimeToCanvas(canvas, pt1.price, pt1.candleIdx);
  const coords2 = priceTimeToCanvas(canvas, pt2.price, pt2.candleIdx);
  
  if (!coords1 || !coords2) return;
  
  const x1 = coords1.x, y1 = coords1.y;
  const x2 = coords2.x, y2 = coords2.y;
  
  switch (drawing.tool) {
    case TOOLS.HLINE:
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(0, y1);
      ctx.lineTo(cW, y1);
      ctx.stroke();
      
      // Price label
      ctx.fillStyle = drawing.color;
      ctx.fillRect(cW, y1 - 8, 72, 16);
      ctx.fillStyle = '#000';
      ctx.fillText(fmtPrice(pt1.price), cW + 4, y1 + 3);
      break;
      
    case TOOLS.TRENDLINE:
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
      
      // Draw extension
      if (x2 !== x1) {
        const slope = (y2 - y1) / (x2 - x1);
        const extendX = x2 < x1 ? 0 : cW;
        const extendY = y2 + slope * (extendX - x2);
        ctx.setLineDash([5, 5]);
        ctx.globalAlpha = 0.5;
        ctx.beginPath();
        ctx.moveTo(x2, y2);
        ctx.lineTo(extendX, extendY);
        ctx.stroke();
        ctx.globalAlpha = 1;
        ctx.setLineDash([]);
      }
      
      // Draw handles
      [{ x: x1, y: y1 }, { x: x2, y: y2 }].forEach(pt => {
        ctx.fillStyle = drawing.color;
        ctx.fillRect(pt.x - 3, pt.y - 3, 6, 6);
      });
      break;
      
    case TOOLS.FIB_RET:
      // Draw main line
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
      
      // Fibonacci levels: 0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0
      const fibLevels = [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0];
      const fibColors = ['#f44336', '#ff9800', '#ffeb3b', '#8bc34a', '#4caf50', '#03a9f4', '#9c27b0'];
      
      fibLevels.forEach((level, i) => {
        const fibY = y1 + (y2 - y1) * level;
        const fibPrice = pt1.price + (pt2.price - pt1.price) * level;
        
        ctx.strokeStyle = fibColors[i] + '80';
        ctx.setLineDash([2, 2]);
        ctx.beginPath();
        ctx.moveTo(Math.min(x1, x2), fibY);
        ctx.lineTo(Math.max(x1, x2), fibY);
        ctx.stroke();
        
        // Label
        ctx.fillStyle = fibColors[i];
        ctx.font = '9px JetBrains Mono';
        ctx.fillText(
          (level * 100).toFixed(1) + '% - ' + fmtPrice(fibPrice),
          Math.max(x1, x2) + 5,
          fibY + 3
        );
      });
      
      ctx.setLineDash([]);
      
      // Draw handles
      ctx.fillStyle = drawing.color;
      ctx.fillRect(x1 - 4, y1 - 4, 8, 8);
      ctx.fillRect(x2 - 4, y2 - 4, 8, 8);
      break;
      
    case TOOLS.FIB_EXT:
      // Similar to retracement but extends beyond 100%
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
      
      const fibExtLevels = [0, 0.236, 0.382, 0.5, 0.618, 1.0, 1.272, 1.618, 2.618];
      const fibExtColors = ['#f44336', '#ff5722', '#ff9800', '#ffc107', '#8bc34a', '#4caf50', '#009688', '#00bcd4', '#2196f3'];
      
      fibExtLevels.forEach((level, i) => {
        const fibY = y1 + (y2 - y1) * level;
        const fibPrice = pt1.price + (pt2.price - pt1.price) * level;
        
        if (fibY < 0 || fibY > cH) return; // Skip off-screen levels
        
        ctx.strokeStyle = fibExtColors[i] + '80';
        ctx.setLineDash([2, 2]);
        ctx.beginPath();
        ctx.moveTo(0, fibY);
        ctx.lineTo(cW, fibY);
        ctx.stroke();
        
        ctx.fillStyle = fibExtColors[i];
        ctx.font = '9px JetBrains Mono';
        ctx.fillText(
          (level * 100).toFixed(1) + '% - ' + fmtPrice(fibPrice),
          cW - 120,
          fibY - 2
        );
      });
      
      ctx.setLineDash([]);
      ctx.fillStyle = drawing.color;
      ctx.fillRect(x1 - 4, y1 - 4, 8, 8);
      ctx.fillRect(x2 - 4, y2 - 4, 8, 8);
      break;
      
    case TOOLS.RECTANGLE:
      ctx.setLineDash([]);
      ctx.strokeRect(
        Math.min(x1, x2),
        Math.min(y1, y2),
        Math.abs(x2 - x1),
        Math.abs(y2 - y1)
      );
      
      // Fill with transparency
      ctx.fillStyle = drawing.color + '10';
      ctx.fillRect(
        Math.min(x1, x2),
        Math.min(y1, y2),
        Math.abs(x2 - x1),
        Math.abs(y2 - y1)
      );
      
      // Corner handles
      [
        { x: x1, y: y1 },
        { x: x2, y: y1 },
        { x: x1, y: y2 },
        { x: x2, y: y2 }
      ].forEach(pt => {
        ctx.fillStyle = drawing.color;
        ctx.fillRect(pt.x - 3, pt.y - 3, 6, 6);
      });
      break;
      
    case TOOLS.RULER:
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
      
      // Calculate distance
      const priceDiff = Math.abs(pt2.price - pt1.price);
      const pricePercent = ((pt2.price - pt1.price) / pt1.price * 100).toFixed(2);
      const timeDiff = Math.abs(pt2.candleIdx - pt1.candleIdx);
      
      // Draw measurement box
      const midX = (x1 + x2) / 2;
      const midY = (y1 + y2) / 2;
      
      ctx.fillStyle = 'rgba(0,0,0,0.8)';
      ctx.fillRect(midX - 60, midY - 25, 120, 50);
      
      ctx.fillStyle = drawing.color;
      ctx.font = '10px JetBrains Mono';
      ctx.textAlign = 'center';
      ctx.fillText('Δ Price: ' + fmtPrice(priceDiff), midX, midY - 8);
      ctx.fillText(pricePercent + '%', midX, midY + 5);
      ctx.fillText('Δ Bars: ' + timeDiff, midX, midY + 18);
      ctx.textAlign = 'left';
      
      // Draw endpoints
      ctx.fillStyle = drawing.color;
      [[x1, y1], [x2, y2]].forEach(([px, py]) => {
        ctx.beginPath();
        ctx.arc(px, py, 4, 0, Math.PI * 2);
        ctx.fill();
      });
      break;
      
    case TOOLS.TEXT:
      // Draw text at position
      ctx.font = '600 14px JetBrains Mono';
      ctx.fillStyle = drawing.color;
      ctx.textBaseline = 'top';
      
      // Background for readability
      const textMetrics = ctx.measureText(drawing.text || 'Text');
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.fillRect(x1 - 2, y1 - 2, textMetrics.width + 4, 18);
      
      ctx.fillStyle = drawing.color;
      ctx.fillText(drawing.text || 'Text', x1, y1);
      
      // Handle
      ctx.fillRect(x1 - 3, y1 - 3, 6, 6);
      break;
  }
  
  // Draw label if exists (for any drawing type)
  if (drawing.label && drawing.tool !== TOOLS.TEXT) {
    const labelX = drawing.tool === TOOLS.HLINE ? 10 : Math.min(x1, x2);
    const labelY = drawing.tool === TOOLS.HLINE ? y1 - 12 : Math.min(y1, y2) - 12;
    
    ctx.font = '600 11px JetBrains Mono';
    ctx.textBaseline = 'bottom';
    const labelMetrics = ctx.measureText(drawing.label);
    
    // Background
    ctx.fillStyle = 'rgba(0,0,0,0.85)';
    ctx.fillRect(labelX - 2, labelY - 13, labelMetrics.width + 4, 15);
    
    // Text
    ctx.fillStyle = drawing.color;
    ctx.fillText(drawing.label, labelX, labelY);
  }
  
  // Draw alert indicator if enabled
  if (drawing.alertEnabled) {
    const alertX = drawing.tool === TOOLS.HLINE ? cW - 20 : Math.max(x1, x2) + 5;
    const alertY = drawing.tool === TOOLS.HLINE ? y1 : Math.min(y1, y2);
    
    ctx.font = '12px Arial';
    ctx.font = '700 9px JetBrains Mono';
    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.fillRect(alertX - 2, alertY - 10, 24, 12);
    ctx.fillStyle = drawing.alertCrossed ? '#4caf50' : '#ffeb3b';
    ctx.fillText('ALT', alertX, alertY);
  }
}

// Mouse event handlers for drawing
let drawStartX = 0, drawStartY = 0;

function initDrawingHandlers() {
  const chartBody = document.getElementById('chartBody');
  const canvas = document.getElementById('chart');
  
  chartBody.addEventListener('mousedown', (e) => {
    if (!activeTool || chartDragState) return;
    
    const rect = chartBody.getBoundingClientRect();
    drawStartX = e.clientX - rect.left;
    drawStartY = e.clientY - rect.top;
    
    activeDrawing = createDrawing(
      activeTool,
      drawStartX,
      drawStartY,
      drawStartX,
      drawStartY
    );
    
    drawingInProgress = true;
    e.stopPropagation();
  });
  
  chartBody.addEventListener('mousemove', (e) => {
    if (!drawingInProgress || !activeDrawing) return;
    
    const rect = chartBody.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    activeDrawing.x2 = currentX;
    activeDrawing.y2 = currentY;
    
    renderChart(); // Redraw chart with active drawing
    e.stopPropagation();
  });
  
  chartBody.addEventListener('mouseup', (e) => {
    if (!drawingInProgress || !activeDrawing) return;
    
    const rect = chartBody.getBoundingClientRect();
    activeDrawing.x2 = e.clientX - rect.left;
    activeDrawing.y2 = e.clientY - rect.top;
    
    // Special handling for single-click tools
    if (activeTool === TOOLS.HLINE) {
      activeDrawing.x2 = rect.width;
    } else if (activeTool === TOOLS.TEXT) {
      // Prompt for text
      const text = prompt('Enter text:', 'Text');
      if (text) {
        activeDrawing.text = text;
      } else {
        activeDrawing = null;
        drawingInProgress = false;
        renderChart();
        return;
      }
    }
    
    // Save drawing
    getCurrentDrawings().push(activeDrawing);
    saveDrawings();
    
    activeDrawing = null;
    drawingInProgress = false;
    
    renderChart();
    e.stopPropagation();
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Delete selected drawing
    if (e.key === 'Delete' || e.key === 'Backspace') {
      if (selectedDrawing !== null) {
        const drawings = getCurrentDrawings();
        drawings.splice(selectedDrawing, 1);
        selectedDrawing = null;
        saveDrawings();
        renderChart();
        e.preventDefault();
      }
    }
    
    // Clear all drawings (Ctrl+Shift+D)
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
      if (confirm('Clear all drawings on this chart?')) {
        drawings[getDrawingKey()] = [];
        saveDrawings();
        renderChart();
      }
      e.preventDefault();
    }
    
    // Escape to cancel active tool
    if (e.key === 'Escape') {
      setDrawingTool(null);
      activeDrawing = null;
      drawingInProgress = false;
      selectedDrawing = null;
      renderChart();
    }
  });
  
  // Right-click context menu for drawings
  chartBody.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    
    const rect = chartBody.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    // Find drawing near click
    const nearbyDrawing = findDrawingNearClick(clickX, clickY);
    
    if (nearbyDrawing) {
      showDrawingContextMenu(e.clientX, e.clientY, nearbyDrawing.index, nearbyDrawing.drawing);
    }
  });
}

// Find drawing near click position
function findDrawingNearClick(clickX, clickY) {
  const currentDrawings = getCurrentDrawings();
  const threshold = 10; // pixels
  
  for (let i = currentDrawings.length - 1; i >= 0; i--) {
    const drawing = currentDrawings[i];
    const canvas = document.getElementById('chart');
    
    const pt1 = canvasToPriceTime(canvas, drawing.x1, drawing.y1);
    const pt2 = canvasToPriceTime(canvas, drawing.x2, drawing.y2);
    
    if (!pt1 || !pt2) continue;
    
    const coords1 = priceTimeToCanvas(canvas, pt1.price, pt1.candleIdx);
    const coords2 = priceTimeToCanvas(canvas, pt2.price, pt2.candleIdx);
    
    if (!coords1 || !coords2) continue;
    
    const x1 = coords1.x, y1 = coords1.y;
    const x2 = coords2.x, y2 = coords2.y;
    
    // Check if click is near this drawing
    if (drawing.tool === TOOLS.HLINE) {
      if (Math.abs(clickY - y1) < threshold) {
        return { drawing, index: i };
      }
    } else if (drawing.tool === TOOLS.RECTANGLE) {
      const minX = Math.min(x1, x2), maxX = Math.max(x1, x2);
      const minY = Math.min(y1, y2), maxY = Math.max(y1, y2);
      if (clickX >= minX && clickX <= maxX && clickY >= minY && clickY <= maxY) {
        return { drawing, index: i };
      }
    } else {
      // Line-based tools: check distance to line segment
      const dist = distanceToLineSegment(clickX, clickY, x1, y1, x2, y2);
      if (dist < threshold) {
        return { drawing, index: i };
      }
    }
  }
  
  return null;
}

// Calculate distance from point to line segment
function distanceToLineSegment(px, py, x1, y1, x2, y2) {
  const dx = x2 - x1;
  const dy = y2 - y1;
  const lengthSq = dx * dx + dy * dy;
  
  if (lengthSq === 0) return Math.sqrt((px - x1) ** 2 + (py - y1) ** 2);
  
  let t = ((px - x1) * dx + (py - y1) * dy) / lengthSq;
  t = Math.max(0, Math.min(1, t));
  
  const nearX = x1 + t * dx;
  const nearY = y1 + t * dy;
  
  return Math.sqrt((px - nearX) ** 2 + (py - nearY) ** 2);
}

// Show context menu for drawing
function showDrawingContextMenu(x, y, drawingIndex, drawing) {
  // Remove existing context menu
  const existingMenu = document.getElementById('drawing-context-menu');
  if (existingMenu) existingMenu.remove();
  
  // Create context menu
  const menu = document.createElement('div');
  menu.id = 'drawing-context-menu';
  menu.style.cssText = `
    position: fixed;
    left: ${x}px;
    top: ${y}px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 4px;
    padding: 4px 0;
    z-index: 10000;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    min-width: 180px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  `;
  
  const options = [
    { label: 'Edit Label', action: () => editDrawingLabel(drawingIndex, drawing) },
    { label: drawing.alertEnabled ? 'Disable Alert' : 'Enable Alert', action: () => toggleDrawingAlert(drawingIndex, drawing) },
    { label: 'Change Color', action: () => changeDrawingColor(drawingIndex, drawing) },
    { label: 'Delete', action: () => deleteDrawing(drawingIndex), danger: true }
  ];
  
  options.forEach(opt => {
    const item = document.createElement('div');
    item.textContent = opt.label;
    item.style.cssText = `
      padding: 8px 16px;
      cursor: pointer;
      color: ${opt.danger ? '#ff1744' : '#e8e8e8'};
      transition: background 0.15s;
    `;
    item.onmouseenter = () => item.style.background = '#2a2a2a';
    item.onmouseleave = () => item.style.background = 'transparent';
    item.onclick = () => {
      opt.action();
      menu.remove();
    };
    menu.appendChild(item);
  });
  
  document.body.appendChild(menu);
  
  // Close menu on click outside
  setTimeout(() => {
    document.addEventListener('click', function closeMenu() {
      menu.remove();
      document.removeEventListener('click', closeMenu);
    });
  }, 100);
}

// Edit drawing label
function editDrawingLabel(index, drawing) {
  const currentLabel = drawing.label || '';
  const newLabel = prompt('Enter label for this drawing:', currentLabel);
  
  if (newLabel !== null) {
    const drawings = getCurrentDrawings();
    drawings[index].label = newLabel || null;
    saveDrawings();
    renderChart();
  }
}

// Toggle drawing alert
function toggleDrawingAlert(index, drawing) {
  const drawings = getCurrentDrawings();
  drawings[index].alertEnabled = !drawing.alertEnabled;
  drawings[index].alertCrossed = false; // Reset alert state
  saveDrawings();
  renderChart();
}

// Change drawing color
function changeDrawingColor(index, drawing) {
  const colors = ['#ff8c00', '#f44336', '#4caf50', '#2196f3', '#ffeb3b', '#9c27b0', '#00bcd4', '#ffffff'];
  const colorNames = ['Orange', 'Red', 'Green', 'Blue', 'Yellow', 'Purple', 'Cyan', 'White'];
  
  let choice = '';
  colors.forEach((c, i) => {
    choice += `${i + 1}. ${colorNames[i]}\n`;
  });
  
  const input = prompt('Choose color (1-8):\n' + choice);
  const colorIdx = parseInt(input) - 1;
  
  if (colorIdx >= 0 && colorIdx < colors.length) {
    const drawings = getCurrentDrawings();
    drawings[index].color = colors[colorIdx];
    saveDrawings();
    renderChart();
  }
}

// Delete drawing
function deleteDrawing(index) {
  if (confirm('Delete this drawing?')) {
    const drawings = getCurrentDrawings();
    drawings.splice(index, 1);
    saveDrawings();
    renderChart();
  }
}

// Check drawing alerts on price update
function checkDrawingAlerts() {
  const d = priceData[activeCoin];
  if (!d) return;
  
  const currentPrice = d.price;
  const drawings = getCurrentDrawings();
  
  drawings.forEach((drawing, idx) => {
    if (!drawing.alertEnabled || drawing.alertCrossed) return;
    
    const canvas = document.getElementById('chart');
    const pt1 = canvasToPriceTime(canvas, drawing.x1, drawing.y1);
    const pt2 = canvasToPriceTime(canvas, drawing.x2, drawing.y2);
    
    if (!pt1 || !pt2) return;
    
    let alertPrice = null;
    
    // Determine alert price based on drawing type
    if (drawing.tool === TOOLS.HLINE) {
      alertPrice = pt1.price;
    } else if (drawing.tool === TOOLS.TRENDLINE || drawing.tool === TOOLS.FIB_RET || drawing.tool === TOOLS.FIB_EXT) {
      // For trendlines/fibs, check if price crosses any level
      // Simplified: check if price is near start or end point
      if (Math.abs(currentPrice - pt1.price) < pt1.price * 0.002 || 
          Math.abs(currentPrice - pt2.price) < pt2.price * 0.002) {
        alertPrice = currentPrice;
      }
    }
    
    if (alertPrice && Math.abs(currentPrice - alertPrice) < alertPrice * 0.001) {
      // Price crossed the drawing! Trigger alert
      drawings[idx].alertCrossed = true;
      saveDrawings();
      
      const label = drawing.label || `${drawing.tool.toUpperCase()} @ ${fmtPrice(alertPrice)}`;
      
      // Show notification
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Drawing Alert Triggered', {
          body: `${activeCoin} crossed ${label}`,
          icon: '/favicon.ico'
        });
      }
      
      // Play sound
      if (soundEnabled) {
        playAlertSound();
      }
      
      // Visual alert
      const alertDiv = document.createElement('div');
      alertDiv.style.cssText = `
        position: fixed;
        top: 60px;
        right: 20px;
        background: linear-gradient(135deg, #ff8c00, #ff6f00);
        color: #000;
        padding: 16px 20px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 13px;
        z-index: 9999;
        box-shadow: 0 4px 16px rgba(255,140,0,0.4);
        animation: slideIn 0.3s ease;
      `;
      alertDiv.textContent = `DRAWING ALERT: ${label}`;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alertDiv.remove(), 300);
      }, 5000);
    }
  });
}

// Add drawing alert checking to price update interval
const originalFetchPrices = window.fetchPrices;
if (originalFetchPrices) {
  window.fetchPrices = async function() {
    await originalFetchPrices();
    checkDrawingAlerts();
  };
}

// Initialize drawing tools
loadDrawings();
initDrawingHandlers();

/* ═══════════════════════════════════════════
   DIAGNOSTIC: ON-SCREEN STATUS
   ═══════════════════════════════════════════ */
setTimeout(() => {
  const tabs = document.querySelectorAll('.tab');
  const statusDiv = document.createElement('div');
  statusDiv.style.cssText = `
    position:fixed;
    top:10px;
    right:10px;
    background:rgba(0,0,0,0.9);
    color:#0f0;
    padding:10px;
    font-family:monospace;
    font-size:11px;
    border:2px solid #0f0;
    z-index:9999;
    max-width:300px;
  `;
  
  let status = `<strong>🔍 DIAGNOSTIC REPORT:</strong><br><br>`;
  status += `✓ Tabs found: ${tabs.length}<br>`;
  status += `✓ switchTab exists: ${typeof switchTab !== 'undefined'}<br>`;
  
  if (tabs.length > 0) {
    const tab1Style = getComputedStyle(tabs[0]);
    status += `<br><strong>Tab 1 CSS:</strong><br>`;
    status += `• pointer-events: ${tab1Style.pointerEvents}<br>`;
    status += `• z-index: ${tab1Style.zIndex}<br>`;
    status += `• cursor: ${tab1Style.cursor}<br>`;
    
    // Test if click works
    tabs[0].addEventListener('click', () => {
      statusDiv.innerHTML += `<br><br><span style="color:yellow">✓ TAB CLICKED!</span>`;
    });
    
    status += `<br><strong>Click tab 1 to test...</strong>`;
  }
  
  statusDiv.innerHTML = status;
  document.body.appendChild(statusDiv);
  
  // Auto-remove after 30 seconds
  setTimeout(() => statusDiv.remove(), 30000);
}, 1000);
</script>
</body>
</html>
