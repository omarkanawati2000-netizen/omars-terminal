<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>OMAR TERMINAL</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600;700;800;900&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--bg4:#222;
  --orange:#ff8c00;--orange-dim:#cc7000;--orange-bg:rgba(255,140,0,0.08);
  --green:#00c853;--green-bg:rgba(0,200,83,0.1);
  --red:#ff1744;--red-bg:rgba(255,23,68,0.1);
  --white:#e8e8e8;--text:#bbb;--dim:#777;--muted:#444;
  --font:'JetBrains Mono',monospace;--sans:'Inter',sans-serif;
}
body.light{
  --bg:#f5f5f5;--bg2:#fff;--bg3:#e0e0e0;--bg4:#d0d0d0;
  --orange:#ff8c00;--orange-dim:#cc7000;--orange-bg:rgba(255,140,0,0.12);
  --green:#00c853;--green-bg:rgba(0,200,83,0.15);
  --red:#ff1744;--red-bg:rgba(255,23,68,0.15);
  --white:#1a1a1a;--text:#333;--dim:#666;--muted:#999;
}
html,body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:12px;line-height:1.4;overflow:hidden;height:100%;user-select:none;-webkit-font-smoothing:antialiased}

/* â•â•â• APP SHELL â•â•â• */
.app{display:flex;flex-direction:column;height:100vh}

/* â•â•â• HEADER BAR â•â•â• */
.header{display:flex;align-items:center;height:44px;background:#0d0d0d;border-bottom:1px solid #222;padding:0 16px;gap:16px}
.hdr-coin{display:flex;align-items:center;gap:10px;cursor:pointer;position:relative}
.hdr-coin-input{background:transparent;border:1px solid #333;color:var(--orange);font-family:var(--font);font-size:14px;font-weight:700;padding:4px 12px;width:200px;outline:none;caret-color:var(--orange)}
.hdr-coin-input:focus{border-color:var(--orange)}
.hdr-coin-input::placeholder{color:#444}
.coin-dropdown{position:absolute;top:100%;left:0;width:240px;background:#111;border:1px solid #333;max-height:300px;overflow-y:auto;z-index:100;display:none}
.coin-dropdown.show{display:block}
.coin-opt{padding:8px 12px;cursor:pointer;display:flex;justify-content:space-between;font-size:11px;min-height:44px;align-items:center}
.coin-opt:hover{background:#1a1a1a}
.coin-opt:active{background:#222}
.coin-opt .sym{font-weight:700;color:var(--white)}

.hdr-label{font-family:var(--sans);font-weight:800;font-size:18px;color:var(--white);letter-spacing:-0.02em}
.hdr-type{font-size:10px;color:var(--dim);letter-spacing:0.05em}
.hdr-price{font-size:20px;font-weight:700;margin-left:8px}
.hdr-change{font-size:12px;font-weight:600;padding:2px 8px;border-radius:3px;margin-left:6px}
.hdr-change.up{background:var(--green-bg);color:var(--green)}
.hdr-change.down{background:var(--red-bg);color:var(--red)}
.hdr-right{margin-left:auto;display:flex;align-items:center;gap:16px}
.hdr-live{display:flex;align-items:center;gap:5px;color:var(--green);font-size:10px;font-weight:600}
.hdr-dot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 1.5s ease infinite;box-shadow:0 0 8px rgba(0,200,83,0.5)}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.7)}}
.hdr-time{color:var(--orange);font-size:12px;font-weight:600}
.hdr-brand{color:var(--orange);font-weight:800;font-size:13px;letter-spacing:0.12em}

/* â•â•â• TAB NAVIGATION â•â•â• */
.tabs{display:flex;align-items:center;height:36px;background:#080808;border-bottom:1px solid #1a1a1a;padding:0 16px;gap:2px}
.tab{padding:8px 16px;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;letter-spacing:0.03em;border-bottom:2px solid transparent;transition:all 0.15s}
.tab:hover{color:var(--dim)}
.tab.active{color:var(--orange);border-bottom-color:var(--orange)}
.tab .num{color:var(--orange-dim);margin-right:4px;font-size:10px}

/* â•â•â• MAIN VIEW â•â•â• */
.view{flex:1;overflow:hidden;display:none}
.view.active{display:flex;flex-direction:column}

/* â•â•â• OVERVIEW TAB â•â•â• */
.overview{display:flex;flex:1;overflow:hidden}
.ov-left{flex:1;display:flex;flex-direction:column;min-width:300px}
.ov-right{width:340px;border-left:1px solid #1a1a1a;overflow-y:auto;background:#0d0d0d}
.ov-right-row{display:flex;justify-content:space-between;padding:8px 16px;border-bottom:1px solid #141414;font-size:11px}
.ov-right-row .lbl{color:var(--dim)}
.ov-right-row .val{font-weight:600;color:var(--white)}
.ov-section-title{padding:10px 16px;font-size:10px;font-weight:700;color:var(--orange);letter-spacing:0.1em;text-transform:uppercase;background:#0a0a0a;border-bottom:1px solid #1a1a1a;position:sticky;top:0;z-index:1}

/* Chart */
.chart-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
.chart-toolbar{display:flex;align-items:center;padding:6px 12px;gap:4px;background:#0d0d0d;border-bottom:1px solid #1a1a1a}
.tf-btn{padding:4px 10px;background:transparent;border:none;color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:3px;font-weight:600}
.tf-btn:hover{color:var(--dim);background:#1a1a1a}
.tf-btn.active{background:var(--orange);color:#000}
.chart-sep{width:1px;height:16px;background:#222;margin:0 4px}
.type-btn{padding:4px 8px;background:transparent;border:none;color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:3px}
.type-btn:hover{color:var(--dim)}
.type-btn.active{color:var(--orange)}

.chart-body{flex:1;position:relative;cursor:crosshair;overflow:hidden;background:#000}
.chart-body canvas{width:100%;height:100%;pointer-events:none}
.chart-ohlc{position:absolute;top:8px;left:12px;display:flex;gap:12px;font-size:10px;pointer-events:none;z-index:2}
.chart-ohlc span{color:var(--dim)}
.chart-ohlc .lbl{color:var(--muted);font-size:9px}
.chart-watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:var(--sans);font-weight:900;font-size:50px;color:rgba(255,140,0,0.03);pointer-events:none}
.chart-scroll{height:18px;padding:3px 80px 3px 0;background:#050505;border-top:1px solid #1a1a1a}
.chart-scroll input[type=range]{-webkit-appearance:none;width:100%;height:10px;background:#111;border-radius:2px;outline:none;cursor:pointer}
.chart-scroll input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:40px;height:10px;background:var(--orange);border-radius:2px;cursor:grab}

/* Recent trades below chart */
.recent-trades{max-height:160px;overflow-y:auto;border-top:1px solid #1a1a1a}
.rt-head,.rt-row{display:grid;grid-template-columns:100px 1fr 1fr 1fr;padding:4px 12px;font-size:10px}
.rt-head{color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;font-size:9px;border-bottom:1px solid #141414;position:sticky;top:0;background:#0d0d0d;z-index:1}
.rt-row{border-bottom:1px solid #0f0f0f}
.rt-row:hover{background:#111}

/* â•â•â• ANALYSIS TAB â•â•â• */
.analysis-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:#1a1a1a;flex:1;overflow-y:auto}
.analysis-card{background:var(--bg);padding:20px}
.analysis-card h3{color:var(--orange);font-size:11px;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:12px}
.signal-meter{display:flex;gap:4px;margin:12px 0}
.signal-bar{flex:1;height:24px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700}
.indicator-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #141414;font-size:11px}
.indicator-row .name{color:var(--dim)}
.indicator-row .val{font-weight:600}
.sr-level{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px}
.sr-bar{height:4px;border-radius:2px;flex:1}

/* â•â•â• ORDER BOOK TAB â•â•â• */
.ob-view{display:flex;flex:1;overflow:hidden}
.ob-list{flex:1;overflow-y:auto;padding:0}
.ob-depth-chart{flex:1;position:relative;background:#000}
.ob-depth-chart canvas{width:100%;height:100%}
.ob-head2{display:grid;grid-template-columns:1fr 1fr 1fr;padding:6px 12px;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;border-bottom:1px solid #1a1a1a;position:sticky;top:0;background:#0d0d0d;z-index:1}
.ob-row2{display:grid;grid-template-columns:1fr 1fr 1fr;padding:3px 12px;font-size:11px;position:relative}
.ob-row2:hover{background:#111}
.ob-bar2{position:absolute;top:0;bottom:0;right:0;opacity:0.06;pointer-events:none}
.ob-mid2{text-align:center;padding:10px;font-size:16px;font-weight:700;background:#0d0d0d;border-top:1px solid #1a1a1a;border-bottom:1px solid #1a1a1a}

/* â•â•â• REL VALUE TAB â•â•â• */
.rv-chart{height:300px;background:#000;position:relative;border-bottom:1px solid #1a1a1a}
.rv-chart canvas{width:100%;height:100%}
.rv-toolbar{display:flex;align-items:center;padding:8px 16px;gap:6px;background:#0d0d0d;border-bottom:1px solid #1a1a1a}
.rv-btn{padding:4px 10px;background:transparent;border:none;color:var(--muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:3px;font-weight:600}
.rv-btn:hover{color:var(--dim);background:#1a1a1a}
.rv-btn.active{background:var(--orange);color:#000}
.rv-table{flex:1;overflow-y:auto}
.rv-head,.rv-row{display:grid;grid-template-columns:80px 100px 90px 80px 80px 80px 80px 80px 1fr;padding:6px 12px;font-size:11px;align-items:center}
.rv-head{color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;font-size:9px;border-bottom:1px solid #1a1a1a;position:sticky;top:0;background:#0d0d0d;z-index:1}
.rv-row{border-bottom:1px solid #0f0f0f;cursor:pointer}
.rv-row:hover{background:#111}
.rv-row .sym{font-weight:700;color:var(--white)}

/* â•â•â• NEWS TAB â•â•â• */
.news-list{flex:1;overflow-y:auto;padding:8px 0}
.news-card{padding:12px 20px;border-bottom:1px solid #141414;cursor:pointer}
.news-card:hover{background:#111}
.news-card .time{font-size:10px;color:var(--orange-dim)}
.news-card .headline{font-size:13px;color:var(--white);margin:4px 0;font-weight:500;line-height:1.5}
.news-card .source{font-size:10px;color:var(--dim)}

/* â•â•â• POSITIONS TAB â•â•â• */
.pos-view{display:flex;flex-direction:column;flex:1;overflow:hidden}
.pos-subtabs{display:flex;padding:0 16px;border-bottom:1px solid #1a1a1a;background:#0d0d0d}
.pos-subtab{padding:8px 16px;font-size:10px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent}
.pos-subtab:hover{color:var(--dim)}
.pos-subtab.active{color:var(--orange);border-bottom-color:var(--orange)}
.pos-content{flex:1;overflow-y:auto}
.pos-head,.pos-row{display:grid;grid-template-columns:70px 55px 80px 90px 90px 80px 80px 70px 1fr;padding:6px 12px;align-items:center;font-size:11px}
.pos-head{color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;font-size:9px;border-bottom:1px solid #1a1a1a;position:sticky;top:0;background:#0d0d0d;z-index:1}
.pos-row{border-bottom:1px solid #0f0f0f}
.pos-row:hover{background:#111}
.pos-badge{font-weight:800;font-size:9px;padding:2px 6px;border-radius:2px;letter-spacing:0.05em}
.pos-long{background:var(--green-bg);color:var(--green)}
.pos-short{background:var(--red-bg);color:var(--red)}
.pos-sym{font-weight:700;color:var(--white)}
.up{color:var(--green)}.down{color:var(--red)}

/* Account summary */
.account-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:#1a1a1a}
.account-cell{background:var(--bg);padding:16px 20px}
.account-cell .lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px}
.account-cell .val{font-size:18px;font-weight:700;color:var(--white)}

/* â•â•â• SCROLLING TICKER â•â•â• */
.ticker-bar{height:28px;background:#050505;border-top:1px solid #1a1a1a;overflow:hidden;position:relative}
.ticker-track{display:flex;align-items:center;height:100%;white-space:nowrap;animation:tickerScroll 60s linear infinite}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.ticker-item{display:inline-flex;align-items:center;gap:6px;padding:0 20px;font-size:11px}
.ticker-item .sym{font-weight:700;color:var(--white)}
.ticker-item .price{color:var(--text)}
.ticker-item .chg{font-weight:600;font-size:10px}

/* Scrollbar */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:#333;border-radius:2px}

/* â•â•â• MOBILE RESPONSIVE â•â•â• */
@media (max-width: 768px) {
  html,body{font-size:10px}
  
  /* Header: stack vertically */
  .header{flex-wrap:wrap;height:auto;padding:8px}
  .hdr-coin{width:100%;order:1;margin-bottom:6px}
  .hdr-coin-input{font-size:13px}
  .hdr-label{font-size:14px;order:2}
  .hdr-type{order:3}
  .hdr-price{font-size:16px;order:4}
  .hdr-change{order:5}
  .hdr-right{width:100%;order:6;justify-content:space-between;margin-top:6px}
  
  /* Tabs: smaller, scrollable */
  .tabs{overflow-x:auto;padding:0 8px}
  .tab{font-size:9px;padding:6px 10px;white-space:nowrap}
  
  /* Overview: stack left/right vertically */
  .overview{flex-direction:column}
  .ov-left{width:100%!important}
  .ov-right{width:100%!important;max-height:400px}
  
  /* Chart toolbar: wrap, smaller buttons */
  .chart-toolbar{flex-wrap:wrap;padding:4px 8px;gap:2px}
  .tf-btn,.type-btn{font-size:8px;padding:3px 6px}
  .chart-sep{display:none} /* hide separators on mobile */
  
  /* Hide OHLC overlay on mobile (too cluttered) */
  .chart-ohlc{display:none}
  
  /* Order book view: stack side-by-side */
  .ob-view{flex-direction:column}
  .ob-list{width:100%!important;max-height:300px}
  .ob-depth-chart{width:100%!important;height:200px}
  
  /* Position table: smaller fonts, horizontal scroll */
  .pos-head,.pos-row{grid-template-columns:60px 45px 70px 75px 75px 65px 60px 60px 1fr;font-size:9px;padding:4px 6px}
  .pos-badge{font-size:8px;padding:1px 4px}
  
  /* Relative value table: horizontal scroll */
  .rv-head,.rv-row{grid-template-columns:70px 90px 80px 70px 70px 70px 70px 70px 1fr;font-size:9px}
  
  /* Ticker: slower scroll, bigger text */
  .ticker-bar{height:32px}
  .ticker-item{font-size:10px;padding:0 16px}
  
  /* Watchlist: bigger tap targets */
  .ov-right-row{padding:8px 12px}
  
  /* News cards: more padding */
  .news-card{padding:10px 16px}
  
  /* Hide watermark on mobile */
  .chart-watermark{display:none}
  
  /* Coin dropdown: full width on mobile */
  .coin-dropdown{width:calc(100vw - 16px);left:0;right:0}
  .coin-opt{min-height:48px;padding:10px 16px}
}

@media (max-width: 480px) {
  /* Extra small phones: even tighter */
  html,body{font-size:9px}
  .header{padding:6px}
  .hdr-label{font-size:12px}
  .hdr-price{font-size:14px}
  .tab{font-size:8px;padding:5px 8px}
  .tf-btn,.type-btn{font-size:7px;padding:2px 5px}
  
  /* Single column for everything */
  .analysis-grid{grid-template-columns:1fr}
  .account-grid{grid-template-columns:1fr}
  
  /* Hide some stat columns on tiny screens */
  .rv-head,.rv-row{grid-template-columns:60px 70px 70px 60px 1fr;font-size:8px}
  .rv-head span:nth-child(n+6),.rv-row span:nth-child(n+6){display:none}
}
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="hdr-coin">
      <input type="text" class="hdr-coin-input" id="coinInput" placeholder="BTC PERP" spellcheck="false" autocomplete="off">
      <div class="coin-dropdown" id="coinDropdown"></div>
    </div>
    <span class="hdr-label" id="coinLabel">Bitcoin</span>
    <span class="hdr-type" id="coinType">Perpetual</span>
    <span class="hdr-price" id="headerPrice">â€”</span>
    <span class="hdr-change up" id="headerChange">+0.00%</span>
    <div class="hdr-right">
      <div class="hdr-live"><div class="hdr-dot"></div>LIVE</div>
      <span class="hdr-time" id="clock"></span>
      <span onclick="toggleTheme()" style="cursor:pointer;font-size:14px;margin-left:8px" title="Toggle theme (Alt+T)" id="themeToggle">ğŸŒ™</span>
      <span class="hdr-brand">OMAR TERMINAL</span>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs" id="tabBar">
    <div class="tab active" data-tab="overview"><span class="num">[1]</span>OVERVIEW</div>
    <div class="tab" data-tab="analysis"><span class="num">[2]</span>ANALYSIS</div>
    <div class="tab" data-tab="orderbook"><span class="num">[3]</span>ORDER BOOK</div>
    <div class="tab" data-tab="relvalue"><span class="num">[4]</span>REL VALUE</div>
    <div class="tab" data-tab="news"><span class="num">[5]</span>NEWS</div>
    <div class="tab" data-tab="positions"><span class="num">[6]</span>POSITIONS</div>
  </div>

  <!-- â•â•â• [1] OVERVIEW â•â•â• -->
  <div class="view active" id="view-overview">
    <div class="overview">
      <div class="ov-left">
        <div class="chart-container">
          <div class="chart-toolbar">
            <button class="tf-btn" data-tf="1m">1m</button>
            <button class="tf-btn" data-tf="5m">5m</button>
            <button class="tf-btn" data-tf="15m">15m</button>
            <button class="tf-btn active" data-tf="1h">1H</button>
            <button class="tf-btn" data-tf="4h">4H</button>
            <button class="tf-btn" data-tf="1d">1D</button>
            <button class="tf-btn" data-tf="1w">1W</button>
            <div class="chart-sep"></div>
            <button class="type-btn active" data-type="candle">Candle</button>
            <button class="type-btn" data-type="line">Line</button>
            <button class="type-btn" data-type="area">Area</button>
            <div class="chart-sep"></div>
            <button class="tf-btn" id="ind-sma20" style="font-size:9px;padding:3px 6px">SMA20</button>
            <button class="tf-btn" id="ind-sma50" style="font-size:9px;padding:3px 6px">SMA50</button>
            <button class="tf-btn" id="ind-ema20" style="font-size:9px;padding:3px 6px">EMA20</button>
            <button class="tf-btn" id="ind-bb" style="font-size:9px;padding:3px 6px">BB</button>
            <button class="tf-btn" id="ind-vwap" style="font-size:9px;padding:3px 6px">VWAP</button>
            <button class="tf-btn" id="ind-rsi" style="font-size:9px;padding:3px 6px">RSI</button>
          </div>
          <div class="chart-body" id="chartBody">
            <div class="chart-watermark">OMAR</div>
            <div class="chart-ohlc">
              <span><span class="lbl">O</span> <span id="ohlcO">â€”</span></span>
              <span><span class="lbl">H</span> <span id="ohlcH">â€”</span></span>
              <span><span class="lbl">L</span> <span id="ohlcL">â€”</span></span>
              <span><span class="lbl">C</span> <span id="ohlcC">â€”</span></span>
              <span><span class="lbl">VOL</span> <span id="ohlcV">â€”</span></span>
            </div>
            <canvas id="chart"></canvas>
          </div>
          <div class="chart-scroll"><input type="range" id="chartScroll" min="0" max="100" value="100"></div>
        </div>
        <div class="recent-trades" id="recentTradesPanel">
          <div class="rt-head"><span>TIME</span><span>SIDE</span><span>PRICE</span><span>SIZE</span></div>
          <div id="recentTrades"></div>
        </div>
      </div>
      <div class="ov-right" id="ovRight">
        <div class="ov-section-title">KEY STATISTICS</div>
        <div id="keyStats"></div>
        <div class="ov-section-title">CONTRACT INFO</div>
        <div id="contractInfo"></div>
        <div class="ov-section-title">MARKET SENTIMENT</div>
        <div id="fearGreedGauge"></div>
        <div class="ov-section-title">WATCHLIST</div>
        <div id="watchlist"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â• [2] ANALYSIS â•â•â• -->
  <div class="view" id="view-analysis">
    <div class="analysis-grid" id="analysisContent"></div>
  </div>

  <!-- â•â•â• [3] ORDER BOOK â•â•â• -->
  <div class="view" id="view-orderbook">
    <div class="ob-view">
      <div class="ob-list" id="obListPanel">
        <div class="ob-head2"><span>PRICE (USD)</span><span style="text-align:right">SIZE</span><span style="text-align:right">TOTAL</span></div>
        <div id="obList"></div>
      </div>
      <div class="ob-depth-chart"><canvas id="depthCanvas"></canvas></div>
    </div>
  </div>

  <!-- â•â•â• [4] REL VALUE â•â•â• -->
  <div class="view" id="view-relvalue">
    <div class="rv-toolbar" id="rvToolbar">
      <button class="rv-btn active" data-period="1d">1D</button>
      <button class="rv-btn" data-period="1w">1W</button>
      <button class="rv-btn" data-period="1m">1M</button>
      <button class="rv-btn" data-period="3m">3M</button>
    </div>
    <div class="rv-chart"><canvas id="rvChart"></canvas></div>
    <div class="rv-table">
      <div class="rv-head"><span>COIN</span><span>MKT CAP</span><span>PRICE</span><span>24H %</span><span>7D %</span><span>VOLUME</span><span>FUNDING</span><span>OI</span><span></span></div>
      <div id="rvTableBody"></div>
    </div>
  </div>

  <!-- â•â•â• [5] NEWS â•â•â• -->
  <div class="view" id="view-news">
    <div class="news-list" id="newsList"></div>
  </div>

  <!-- â•â•â• [6] POSITIONS â•â•â• -->
  <div class="view" id="view-positions">
    <div class="pos-view">
      <div class="pos-subtabs">
        <div class="pos-subtab active" data-sub="positions">POSITIONS</div>
        <div class="pos-subtab" data-sub="orders">OPEN ORDERS</div>
        <div class="pos-subtab" data-sub="history">TRADE HISTORY</div>
        <div class="pos-subtab" data-sub="account">ACCOUNT</div>
      </div>
      <div class="pos-content" id="posContent"></div>
    </div>
  </div>

  <!-- SCROLLING TICKER -->
  <div class="ticker-bar">
    <div class="ticker-track" id="tickerTrack"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// â•â•â• ASSET CATEGORIES â•â•â•
const CRYPTO = ['BTC','ETH','SOL','XRP','DOGE','SUI','AVAX','LINK','ADA','HYPE','PEPE','WIF','JTO','TIA','SEI','INJ','ONDO','PENDLE','PUMP'];
const STOCKS = ['SPY','QQQ','AAPL','MSFT','NVDA','TSLA','AMZN','META','GOOGL','JPM','AMD','COIN','MSTR','PLTR'];
const COMMODITIES = ['GC=F','SI=F','CL=F','NG=F'];
const FOREX = ['EURUSD=X','GBPUSD=X','USDJPY=X','DX-Y.NYB'];
const ALL_TICKERS = [...CRYPTO,...STOCKS,...COMMODITIES,...FOREX];
const COINS = CRYPTO; // backward compat

const ASSET_NAMES = {
  // Crypto
  BTC:'Bitcoin',ETH:'Ethereum',SOL:'Solana',XRP:'XRP',DOGE:'Dogecoin',SUI:'Sui',AVAX:'Avalanche',LINK:'Chainlink',ADA:'Cardano',HYPE:'Hyperliquid',PEPE:'Pepe',WIF:'dogwifhat',JTO:'Jito',TIA:'Celestia',SEI:'Sei',INJ:'Injective',ONDO:'Ondo',PENDLE:'Pendle',PUMP:'Pump.fun',
  // Stocks & ETFs
  SPY:'S&P 500 ETF',QQQ:'Nasdaq 100 ETF',AAPL:'Apple',MSFT:'Microsoft',NVDA:'NVIDIA',TSLA:'Tesla',AMZN:'Amazon',META:'Meta',GOOGL:'Alphabet',JPM:'JPMorgan',AMD:'AMD',COIN:'Coinbase',MSTR:'MicroStrategy',PLTR:'Palantir',
  // Commodities
  'GC=F':'Gold','SI=F':'Silver','CL=F':'Crude Oil','NG=F':'Natural Gas',
  // Forex
  'EURUSD=X':'EUR/USD','GBPUSD=X':'GBP/USD','USDJPY=X':'USD/JPY','DX-Y.NYB':'US Dollar Index'
};
const COIN_NAMES = ASSET_NAMES; // backward compat

const ASSET_TYPE = {};
CRYPTO.forEach(c=>ASSET_TYPE[c]='crypto');
STOCKS.forEach(s=>ASSET_TYPE[s]='stock');
COMMODITIES.forEach(c=>ASSET_TYPE[c]='commodity');
FOREX.forEach(f=>ASSET_TYPE[f]='forex');

let activeCoin = 'BTC';
let activeCategory = 'all'; // all, crypto, stocks, commodities, forex
let chartType = 'candle';
let activeTF = '1h';
let activeTab = 'overview';
let activePosSub = 'positions';
let priceData = {};
let candleData = {};
let metaData = null;
let orderBookData = {};
let fearGreedData = null; // {value, classification}
let indicators = {sma20:true,sma50:false,ema20:false,rsi:false,bb:false,vwap:false}; // active indicators
let favorites = []; // favorite coins
let priceAlerts = [];
let soundEnabled = true;
let theme = 'dark'; // 'dark' or 'light'

const TF_MS = {'1m':60000,'5m':300000,'15m':900000,'1h':3600000,'4h':14400000,'1d':86400000,'1w':604800000};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSISTENT SETTINGS (localStorage)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadSettings(){
  try{
    const saved=JSON.parse(localStorage.getItem('omar_terminal_settings')||'{}');
    if(saved.activeCoin&&ALL_TICKERS.includes(saved.activeCoin))activeCoin=saved.activeCoin;
    if(saved.activeTF&&TF_MS[saved.activeTF])activeTF=saved.activeTF;
    if(saved.indicators)indicators={...indicators,...saved.indicators};
    if(saved.favorites&&Array.isArray(saved.favorites))favorites=saved.favorites.filter(c=>ALL_TICKERS.includes(c));
    if(saved.activeCategory)activeCategory=saved.activeCategory;
    if(saved.priceAlerts&&Array.isArray(saved.priceAlerts))priceAlerts=saved.priceAlerts;
    if(saved.soundEnabled!==undefined)soundEnabled=saved.soundEnabled;
    if(saved.theme)theme=saved.theme;
  }catch(e){console.error('Settings load error:',e)}
  applyTheme();
}

function saveSettings(){
  try{
    const settings={activeCoin,activeTF,indicators,favorites,activeCategory,priceAlerts,soundEnabled,theme};
    localStorage.setItem('omar_terminal_settings',JSON.stringify(settings));
  }catch(e){console.error('Settings save error:',e)}
}

function toggleTheme(){
  theme=theme==='dark'?'light':'dark';
  applyTheme();
  saveSettings();
}

function applyTheme(){
  document.body.className=theme==='light'?'light':'';
}

function toggleFavorite(coin){
  const idx=favorites.indexOf(coin);
  if(idx>=0)favorites.splice(idx,1);
  else favorites.push(coin);
  saveSettings();
  renderWatchlist();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRICE ALERTS & SOUND
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function playAlertSound(){
  if(!soundEnabled)return;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.frequency.value=880; // A5 note
    osc.type='sine';
    gain.gain.setValueAtTime(0.3,ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.3);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime+0.3);
  }catch(e){console.error('Audio error:',e)}
}

function addPriceAlert(coin,price,condition){
  priceAlerts.push({coin,price,condition,triggered:false});
  saveSettings();
}

function checkPriceAlerts(){
  priceAlerts.forEach(alert=>{
    if(alert.triggered)return;
    const d=priceData[alert.coin];
    if(!d)return;
    const hit=(alert.condition==='above'&&d.price>=alert.price)||(alert.condition==='below'&&d.price<=alert.price);
    if(hit){
      alert.triggered=true;
      playAlertSound();
      const msg=`ğŸ”” PRICE ALERT: ${alert.coin} ${alert.condition==='above'?'â‰¥':'â‰¤'} $${fmtPrice(alert.price)} (now $${fmtPrice(d.price)})`;
      console.log(msg);
      if('Notification' in window&&Notification.permission==='granted'){
        new Notification('Price Alert',{body:msg,icon:'https://omarkanawati2000-netizen.github.io/omars-terminal/favicon.ico'});
      }
      saveSettings();
    }
  });
}
const TF_BARS = {'1m':500,'5m':500,'15m':400,'1h':300,'4h':200,'1d':365,'1w':150};
const TF_API = {'1m':'1m','5m':'5m','15m':'15m','1h':'1h','4h':'4h','1d':'1d','1w':'1w'};

function getFilteredAssets(){
  if(activeCategory==='favorites')return favorites.length>0?favorites:ALL_TICKERS;
  if(activeCategory==='crypto')return CRYPTO;
  if(activeCategory==='stocks')return STOCKS;
  if(activeCategory==='commodities')return COMMODITIES;
  if(activeCategory==='forex')return FOREX;
  return ALL_TICKERS;
}

function displayName(sym){return ASSET_NAMES[sym]||sym}
function assetCategory(sym){return ASSET_TYPE[sym]||'crypto'}
function categoryColor(sym){const t=assetCategory(sym);return t==='crypto'?'var(--orange)':t==='stock'?'#2196f3':t==='commodity'?'#ffeb3b':'#e040fb'}
function categoryLabel(sym){const t=assetCategory(sym);return t==='crypto'?'PERP':t==='stock'?'EQUITY':t==='commodity'?'FUTURES':t==='forex'?'FX':''}
function cleanSym(sym){return sym.replace('=F','').replace('=X','').replace('-Y.NYB','').replace('DX','DXY')}

function candleKey(c,t){return c+':'+t}
let candleLoading = {};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOCK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateClock(){
  const now=new Date();
  document.getElementById('clock').textContent=now.toLocaleString('en-US',{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})+' MST';
}
setInterval(updateClock,1000);updateClock();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB SWITCHING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(tab){
  activeTab=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.querySelectorAll('.view').forEach(v=>v.classList.toggle('active',v.id==='view-'+tab));
  if(tab==='overview')renderOverview();
  if(tab==='analysis')renderAnalysis();
  if(tab==='orderbook')renderOrderBookFull();
  if(tab==='relvalue')renderRelValue();
  if(tab==='news')renderNewsFull();
  if(tab==='positions')renderPositionsSub();
}

document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COIN SELECTOR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const coinInput = document.getElementById('coinInput');
const coinDropdown = document.getElementById('coinDropdown');

function selectCoin(coin){
  activeCoin=coin;
  coinInput.value=cleanSym(coin)+' '+categoryLabel(coin);
  document.getElementById('coinLabel').textContent=displayName(coin);
  document.getElementById('coinType').textContent=categoryLabel(coin);
  coinDropdown.classList.remove('show');
  chartZoomX=1;chartZoomY=1;chartPanX=0;
  const key=candleKey(coin,activeTF);
  if(!candleData[key]||candleData[key].length<2)fetchRealCandles(coin,activeTF);
  fetchOrderBook(coin);
  saveSettings(); // Save coin selection
  renderAll();
}

coinInput.addEventListener('focus',()=>{
  renderCoinDropdown('');
  coinDropdown.classList.add('show');
});
coinInput.addEventListener('input',()=>{
  renderCoinDropdown(coinInput.value.trim().toUpperCase());
  coinDropdown.classList.add('show');
});
coinInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const val=coinInput.value.trim().toUpperCase().replace(/ (PERP|EQUITY|FUTURES|FX)$/,'');
    const match=ALL_TICKERS.find(t=>cleanSym(t)===val||t===val);
    if(match)selectCoin(match);
    coinDropdown.classList.remove('show');
    coinInput.blur();
  }
  if(e.key==='Escape'){coinDropdown.classList.remove('show');coinInput.blur();}
});
document.addEventListener('click',e=>{if(!e.target.closest('.hdr-coin'))coinDropdown.classList.remove('show')});

// Fuzzy match scoring
function fuzzyScore(str,query){
  if(!query)return 1;
  str=str.toUpperCase();query=query.toUpperCase();
  if(str===query)return 1000; // exact match
  if(str.startsWith(query))return 100; // starts with
  let score=0,lastIdx=-1;
  for(const char of query){
    const idx=str.indexOf(char,lastIdx+1);
    if(idx===-1)return 0; // no match
    score+=50/(idx-lastIdx); // closer chars = higher score
    lastIdx=idx;
  }
  return score;
}

function renderCoinDropdown(filter){
  const scored=ALL_TICKERS.map(c=>{
    const symScore=fuzzyScore(cleanSym(c),filter);
    const nameScore=fuzzyScore(ASSET_NAMES[c]||'',filter);
    return{coin:c,score:Math.max(symScore,nameScore)};
  }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,20); // top 20 matches
  
  coinDropdown.innerHTML=scored.map(({coin:c})=>{
    const d=priceData[c];
    const price=d?'$'+fmtPrice(d.price):'â€”';
    const change=d?((d.price-d.open)/d.open*100):0;
    const cls=change>=0?'up':'down';
    const badge=`<span style="font-size:8px;padding:1px 4px;border-radius:2px;background:${categoryColor(c)};color:#000;font-weight:700">${assetCategory(c).toUpperCase()}</span>`;
    return `<div class="coin-opt" onclick="selectCoin('${c}')"><span class="sym">${cleanSym(c)}</span>${badge}<span style="color:var(--dim);font-size:10px">${displayName(c)}</span><span class="${cls}">${price}</span></div>`;
  }).join('');
}

coinInput.value='BTC PERP';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANDLE DATA (REAL API)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchRealCandles(coin,tf){
  // Route non-crypto to Yahoo Finance
  if(assetCategory(coin)!=='crypto'){return fetchStockCandles(coin,tf)}
  const key=candleKey(coin,tf);
  if(candleLoading[key])return;
  candleLoading[key]=true;
  try{
    const bars=TF_BARS[tf]||300;
    const interval=TF_MS[tf]||3600000;
    const endTime=Date.now();
    const startTime=endTime-bars*interval;
    const resp=await fetch('https://api.hyperliquid.xyz/info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'candleSnapshot',req:{coin,interval:TF_API[tf]||'1h',startTime,endTime}})});
    const data=await resp.json();
    if(Array.isArray(data)&&data.length>0){
      candleData[key]=data.map(c=>({o:parseFloat(c.o),h:parseFloat(c.h),l:parseFloat(c.l),c:parseFloat(c.c),v:parseFloat(c.v),t:c.t}));
      if(coin===activeCoin&&tf===activeTF)renderChart();
    }
  }catch(e){console.error('Candle fetch error:',coin,tf,e)}
  finally{candleLoading[key]=false}
}

function switchTimeframe(tf){
  activeTF=tf;
  chartZoomX=1;chartZoomY=1;chartPanX=0;
  document.querySelectorAll('.tf-btn').forEach(b=>b.classList.toggle('active',b.dataset.tf===tf));
  const key=candleKey(activeCoin,tf);
  if(!candleData[key]||candleData[key].length<2)fetchRealCandles(activeCoin,tf);
  saveSettings(); // Save timeframe selection
  renderChart();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRICE FETCHING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchPrices(){
  try{
    const resp=await fetch('https://api.hyperliquid.xyz/info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'allMids'})});
    const data=await resp.json();
    for(const coin of COINS){
      const price=parseFloat(data[coin]||0);
      if(!price)continue;
      if(!priceData[coin]){
        priceData[coin]={price,prevPrice:price,open:price,high:price,low:price,history:[],volume:0};
        if(coin===activeCoin)fetchRealCandles(coin,activeTF);
      }else{
        priceData[coin].prevPrice=priceData[coin].price;
        priceData[coin].price=price;
        priceData[coin].high=Math.max(priceData[coin].high,price);
        priceData[coin].low=Math.min(priceData[coin].low,price);
      }
      priceData[coin].history.push({time:Date.now(),price});
      if(priceData[coin].history.length>300)priceData[coin].history.shift();
      // Update live candle
      for(const tf of Object.keys(TF_MS)){
        const key=candleKey(coin,tf);
        if(candleData[key]&&candleData[key].length>0){
          const last=candleData[key][candleData[key].length-1];
          if(Date.now()-last.t>TF_MS[tf]){
            if(coin===activeCoin&&tf===activeTF)fetchRealCandles(coin,tf);
          }else{
            last.c=price;last.h=Math.max(last.h,price);last.l=Math.min(last.l,price);
          }
        }
      }
    }
    checkPriceAlerts(); // Check if any alerts triggered
    renderAll();
  }catch(e){console.error('Fetch error:',e)}
}

// Fetch metadata (volume, funding, OI)
async function fetchMeta(){
  try{
    const resp=await fetch('https://api.hyperliquid.xyz/info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'metaAndAssetCtxs'})});
    metaData=await resp.json();
    // Map volume/funding/OI to priceData
    if(metaData&&metaData.length>=2){
      const universe=metaData[0].universe;
      const ctxs=metaData[1];
      universe.forEach((u,i)=>{
        const coin=u.name;
        if(priceData[coin]&&ctxs[i]){
          priceData[coin].volume=parseFloat(ctxs[i].dayNtlVlm||0);
          priceData[coin].funding=parseFloat(ctxs[i].funding||0);
          priceData[coin].openInterest=parseFloat(ctxs[i].openInterest||0);
          priceData[coin].markPx=parseFloat(ctxs[i].markPx||0);
          priceData[coin].prevDayPx=parseFloat(ctxs[i].prevDayPx||0);
          if(priceData[coin].prevDayPx){
            priceData[coin].open=priceData[coin].prevDayPx;
          }
        }
      });
    }
  }catch(e){console.error('Meta fetch error:',e)}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOCK/COMMODITY/FOREX FETCHING (Yahoo Finance via proxy)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const YAHOO_SYMBOLS = [...STOCKS,...COMMODITIES,...FOREX];
const CORS_PROXY = 'https://corsproxy.io/?';

async function fetchStocks(){
  // Use v8 chart endpoint via CORS proxy (Yahoo has no CORS headers)
  const promises=YAHOO_SYMBOLS.map(async sym=>{
    try{
      const url=CORS_PROXY+encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=5d`);
      const resp=await fetch(url);
      const data=await resp.json();
      const result=data.chart&&data.chart.result&&data.chart.result[0];
      if(!result||!result.meta)return;
      const m=result.meta;
      const price=m.regularMarketPrice;
      if(!price)return;
      const open=m.chartPreviousClose||m.previousClose||price;
      const high=m.regularMarketDayHigh||price;
      const low=m.regularMarketDayLow||price;
      const vol=m.regularMarketVolume||0;
      if(!priceData[sym]){
        priceData[sym]={price,prevPrice:price,open,high,low,history:[],volume:vol,isStock:true};
      }else{
        priceData[sym].prevPrice=priceData[sym].price;
        priceData[sym].price=price;
        priceData[sym].high=high;priceData[sym].low=low;
        priceData[sym].volume=vol;priceData[sym].open=open;
      }
      priceData[sym].history.push({time:Date.now(),price});
      if(priceData[sym].history.length>300)priceData[sym].history.shift();
    }catch(e){/* silent per-symbol */}
  });
  await Promise.allSettled(promises);
  renderAll();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORDER BOOK FETCHING (Hyperliquid L2)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchOrderBook(coin){
  // Only fetch for crypto (Hyperliquid has order books)
  if(assetCategory(coin)!=='crypto')return;
  try{
    const resp=await fetch('https://api.hyperliquid.xyz/info',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({type:'l2Book',coin})
    });
    const data=await resp.json();
    if(data&&data.levels&&data.levels.length===2){
      orderBookData[coin]={
        bids:data.levels[0].map(l=>({price:parseFloat(l.px),size:parseFloat(l.sz),count:l.n})),
        asks:data.levels[1].map(l=>({price:parseFloat(l.px),size:parseFloat(l.sz),count:l.n})),
        timestamp:data.time
      };
      if(coin===activeCoin&&activeTab==='orderbook')renderOrderBookFull();
    }
  }catch(e){console.error('Order book fetch error:',coin,e)}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FEAR & GREED INDEX
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchFearGreed(){
  try{
    const resp=await fetch('https://api.alternative.me/fng/');
    const data=await resp.json();
    if(data&&data.data&&data.data[0]){
      fearGreedData={value:parseInt(data.data[0].value),classification:data.data[0].value_classification};
    }
  }catch(e){console.error('Fear & Greed fetch error:',e)}
}

// Fetch Yahoo Finance candles for stocks
async function fetchStockCandles(sym,tf){
  const key=candleKey(sym,tf);
  if(candleLoading[key])return;
  candleLoading[key]=true;
  try{
    // Map TF to Yahoo interval/range
    const yInterval={'1m':'1m','5m':'5m','15m':'15m','1h':'1h','4h':'1h','1d':'1d','1w':'1wk'}[tf]||'1h';
    const yRange={'1m':'1d','5m':'5d','15m':'5d','1h':'1mo','4h':'3mo','1d':'1y','1w':'5y'}[tf]||'1mo';
    const url=CORS_PROXY+encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=${yInterval}&range=${yRange}`);
    const resp=await fetch(url);
    const data=await resp.json();
    const result=data.chart&&data.chart.result&&data.chart.result[0];
    if(result&&result.timestamp&&result.indicators){
      const ts=result.timestamp;
      const q=result.indicators.quote[0];
      const candles=[];
      for(let i=0;i<ts.length;i++){
        if(q.open[i]==null)continue;
        candles.push({o:q.open[i],h:q.high[i],l:q.low[i],c:q.close[i],v:q.volume[i]||0,t:ts[i]*1000});
      }
      if(candles.length>0){
        candleData[key]=candles;
        if(sym===activeCoin&&tf===activeTF)renderChart();
      }
    }
  }catch(e){console.error('Yahoo candle error:',sym,tf,e)}
  finally{candleLoading[key]=false}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMATTING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmtPrice(p){
  if(p>=1000)return p.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  if(p>=1)return p.toFixed(4);
  if(p>=0.01)return p.toFixed(5);
  return p.toFixed(8);
}
function fmtCompact(n){
  if(n>=1e9)return(n/1e9).toFixed(2)+'B';
  if(n>=1e6)return(n/1e6).toFixed(2)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  return n.toFixed(0);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TECHNICAL INDICATORS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcSMA(candles,period){
  if(!candles||candles.length<period)return[];
  const sma=[];
  for(let i=period-1;i<candles.length;i++){
    const sum=candles.slice(i-period+1,i+1).reduce((a,c)=>a+c.c,0);
    sma.push(sum/period);
  }
  return sma;
}

function calcEMA(candles,period){
  if(!candles||candles.length<period)return[];
  const ema=[];
  const k=2/(period+1);
  let prevEma=candles.slice(0,period).reduce((a,c)=>a+c.c,0)/period;
  ema.push(prevEma);
  for(let i=period;i<candles.length;i++){
    prevEma=(candles[i].c-prevEma)*k+prevEma;
    ema.push(prevEma);
  }
  return ema;
}

function calcRSI(candles,period=14){
  if(!candles||candles.length<period+1)return[];
  const rsi=[];
  let gains=0,losses=0;
  for(let i=1;i<=period;i++){
    const change=candles[i].c-candles[i-1].c;
    if(change>0)gains+=change;else losses-=change;
  }
  let avgGain=gains/period,avgLoss=losses/period;
  rsi.push(100-(100/(1+(avgGain/avgLoss))));
  for(let i=period+1;i<candles.length;i++){
    const change=candles[i].c-candles[i-1].c;
    avgGain=(avgGain*(period-1)+(change>0?change:0))/period;
    avgLoss=(avgLoss*(period-1)+(change<0?-change:0))/period;
    rsi.push(100-(100/(1+(avgGain/avgLoss))));
  }
  return rsi;
}

function calcBB(candles,period=20,mult=2){
  if(!candles||candles.length<period)return{upper:[],middle:[],lower:[]};
  const sma=calcSMA(candles,period);
  const upper=[],lower=[];
  for(let i=0;i<sma.length;i++){
    const slice=candles.slice(i,i+period);
    const mean=sma[i];
    const variance=slice.reduce((a,c)=>a+Math.pow(c.c-mean,2),0)/period;
    const std=Math.sqrt(variance);
    upper.push(mean+mult*std);
    lower.push(mean-mult*std);
  }
  return{upper,middle:sma,lower};
}

function calcVWAP(candles){
  if(!candles||candles.length<1)return[];
  const vwap=[];
  let cumVolPrice=0,cumVol=0;
  candles.forEach(c=>{
    const typical=(c.h+c.l+c.c)/3;
    cumVolPrice+=typical*c.v;
    cumVol+=c.v;
    vwap.push(cumVolPrice/cumVol);
  });
  return vwap;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ALL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll(){
  updateHeader();
  updateTicker();
  if(activeTab==='overview')renderOverview();
  else if(activeTab==='analysis')renderAnalysis();
  else if(activeTab==='orderbook')renderOrderBookFull();
  else if(activeTab==='relvalue')renderRelValue();
  else if(activeTab==='positions')renderPositionsSub();
}

function updateHeader(){
  const d=priceData[activeCoin];if(!d)return;
  const change=((d.price-d.open)/d.open*100);
  const isUp=change>=0;
  document.getElementById('headerPrice').textContent='$'+fmtPrice(d.price);
  document.getElementById('headerPrice').className='hdr-price '+(isUp?'up':'down');
  const el=document.getElementById('headerChange');
  el.textContent=(isUp?'+':'')+change.toFixed(2)+'%';
  el.className='hdr-change '+(isUp?'up':'down');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TICKER BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateTicker(){
  const items=ALL_TICKERS.map(c=>{
    const d=priceData[c];if(!d)return'';
    const change=((d.price-d.open)/d.open*100);
    const isUp=change>=0;
    const arrow=isUp?'â–²':'â–¼';
    return `<span class="ticker-item"><span class="sym" style="color:${categoryColor(c)}">${cleanSym(c)}</span><span class="price">$${fmtPrice(d.price)}</span><span class="chg ${isUp?'up':'down'}">${arrow}${isUp?'+':''}${change.toFixed(2)}%</span></span>`;
  }).filter(Boolean).join('');
  document.getElementById('tickerTrack').innerHTML=items+items;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   [1] OVERVIEW RENDERING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderOverview(){
  renderChart();
  renderKeyStats();
  renderContractInfo();
  renderFearGreed();
  renderWatchlist();
  renderRecentTrades();
}

function renderFearGreed(){
  const el=document.getElementById('fearGreedGauge');
  if(!fearGreedData){
    el.innerHTML='<div style="padding:12px;text-align:center;color:var(--muted);font-size:10px">Loading...</div>';
    return;
  }
  const v=fearGreedData.value;
  const cls=fearGreedData.classification;
  let color;
  if(v<=25)color='var(--red)';
  else if(v<=45)color='#ff9800';
  else if(v<=55)color='#ffeb3b';
  else if(v<=75)color='#8bc34a';
  else color='var(--green)';
  el.innerHTML=`
    <div style="padding:12px;text-align:center">
      <div style="font-size:32px;font-weight:800;color:${color}">${v}</div>
      <div style="font-size:10px;color:var(--dim);margin-top:2px">${cls}</div>
      <div style="width:100%;height:6px;background:#1a1a1a;border-radius:3px;margin-top:8px;position:relative;overflow:hidden">
        <div style="position:absolute;left:0;top:0;bottom:0;width:${v}%;background:${color};transition:width 0.5s"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--muted);margin-top:4px">
        <span>Extreme Fear</span><span>Extreme Greed</span>
      </div>
    </div>
  `;
}

function renderKeyStats(){
  const d=priceData[activeCoin];if(!d)return;
  const el=document.getElementById('keyStats');
  const vol=d.volume||0;
  const funding=d.funding||0;
  const oi=d.openInterest||0;
  const mark=d.markPx||d.price;
  el.innerHTML=`
    <div class="ov-right-row"><span class="lbl">Mark Price</span><span class="val">$${fmtPrice(mark)}</span></div>
    <div class="ov-right-row"><span class="lbl">Index Price</span><span class="val">$${fmtPrice(d.price)}</span></div>
    <div class="ov-right-row"><span class="lbl">24H High</span><span class="val up">$${fmtPrice(d.high)}</span></div>
    <div class="ov-right-row"><span class="lbl">24H Low</span><span class="val down">$${fmtPrice(d.low)}</span></div>
    <div class="ov-right-row"><span class="lbl">24H Volume</span><span class="val">$${fmtCompact(vol)}</span></div>
    <div class="ov-right-row"><span class="lbl">Open Interest</span><span class="val">$${fmtCompact(oi*d.price)}</span></div>
    <div class="ov-right-row"><span class="lbl">Funding (8H)</span><span class="val ${funding>=0?'up':'down'}">${(funding*100).toFixed(4)}%</span></div>
    <div class="ov-right-row"><span class="lbl">24H Change</span><span class="val ${((d.price-d.open)/d.open*100)>=0?'up':'down'}">${((d.price-d.open)/d.open*100).toFixed(2)}%</span></div>
  `;
}

function renderContractInfo(){
  const el=document.getElementById('contractInfo');
  const cat=assetCategory(activeCoin);
  if(cat==='crypto'){
    const maxLev=activeCoin==='BTC'||activeCoin==='ETH'?'50x':'20x';
    el.innerHTML=`
      <div class="ov-right-row"><span class="lbl">Exchange</span><span class="val">Hyperliquid</span></div>
      <div class="ov-right-row"><span class="lbl">Type</span><span class="val">Perpetual</span></div>
      <div class="ov-right-row"><span class="lbl">Max Leverage</span><span class="val" style="color:var(--orange)">${maxLev}</span></div>
      <div class="ov-right-row"><span class="lbl">Settlement</span><span class="val">USDC</span></div>`;
  }else if(cat==='stock'){
    el.innerHTML=`
      <div class="ov-right-row"><span class="lbl">Exchange</span><span class="val">NASDAQ/NYSE</span></div>
      <div class="ov-right-row"><span class="lbl">Type</span><span class="val">Equity</span></div>
      <div class="ov-right-row"><span class="lbl">Currency</span><span class="val">USD</span></div>
      <div class="ov-right-row"><span class="lbl">Market Hours</span><span class="val">9:30-16:00 ET</span></div>`;
  }else if(cat==='commodity'){
    el.innerHTML=`
      <div class="ov-right-row"><span class="lbl">Exchange</span><span class="val">NYMEX/COMEX</span></div>
      <div class="ov-right-row"><span class="lbl">Type</span><span class="val">Futures</span></div>
      <div class="ov-right-row"><span class="lbl">Currency</span><span class="val">USD</span></div>`;
  }else{
    el.innerHTML=`
      <div class="ov-right-row"><span class="lbl">Market</span><span class="val">Forex</span></div>
      <div class="ov-right-row"><span class="lbl">Type</span><span class="val">Spot</span></div>
      <div class="ov-right-row"><span class="lbl">Hours</span><span class="val">24/5</span></div>`;
  }
}

function renderWatchlist(){
  const el=document.getElementById('watchlist');
  const cats=[{id:'favorites',label:'â˜… FAV'},{id:'all',label:'ALL'},{id:'crypto',label:'CRYPTO'},{id:'stocks',label:'STOCKS'},{id:'commodities',label:'CMDTY'},{id:'forex',label:'FX'}];
  const catBar=cats.map(c=>`<span style="padding:3px 8px;font-size:9px;cursor:pointer;border-radius:2px;font-weight:600;${activeCategory===c.id?'background:var(--orange);color:#000':'color:var(--muted)'}" onclick="activeCategory='${c.id}';renderWatchlist()">${c.label}</span>`).join('');
  const assets=getFilteredAssets();
  const rows=assets.map(c=>{
    const d=priceData[c];if(!d)return'';
    const change=((d.price-d.open)/d.open*100);
    const isUp=change>=0;
    const isFav=favorites.includes(c);
    const star=`<span onclick="event.stopPropagation();toggleFavorite('${c}')" style="cursor:pointer;margin-left:3px;color:${isFav?'var(--orange)':'var(--muted)'};font-size:10px">${isFav?'â˜…':'â˜†'}</span>`;
    return `<div class="ov-right-row" style="cursor:pointer;${c===activeCoin?'background:#1a1200;border-left:2px solid var(--orange);':'border-left:2px solid transparent;'}" onclick="selectCoin('${c}')">
      <span><span style="font-weight:700;color:${categoryColor(c)}">${cleanSym(c)}</span>${star} <span style="font-size:9px;color:var(--muted)">${displayName(c)}</span></span>
      <span class="${isUp?'up':'down'}" style="font-weight:600">$${fmtPrice(d.price)} <span style="font-size:10px">${isUp?'+':''}${change.toFixed(2)}%</span></span>
    </div>`;
  }).join('');
  el.innerHTML=`<div style="display:flex;gap:2px;padding:6px 12px;border-bottom:1px solid #1a1a1a">${catBar}</div>${rows}`;
}

function renderRecentTrades(){
  const d=priceData[activeCoin];if(!d)return;
  const el=document.getElementById('recentTrades');
  let html='';
  for(let i=0;i<15;i++){
    const side=Math.random()>0.5?'BUY':'SELL';
    const p=d.price*(1+(Math.random()-0.5)*0.0005);
    const size=+(Math.random()*2+0.001).toFixed(3);
    const t=new Date(Date.now()-i*2000-Math.random()*3000);
    html+=`<div class="rt-row"><span style="color:var(--muted)">${t.toLocaleTimeString('en-US',{hour12:false})}</span><span style="color:${side==='BUY'?'var(--green)':'var(--red)'};font-weight:600">${side}</span><span>$${fmtPrice(p)}</span><span style="color:var(--dim)">${size}</span></div>`;
  }
  el.innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART ZOOM/PAN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let chartZoomX=1,chartZoomY=1,chartPanX=0,chartDragState=null;

(function(){
  const body=document.getElementById('chartBody');
  body.addEventListener('mousedown',e=>{
    const rect=body.getBoundingClientRect();
    const isPrice=e.clientX>rect.right-80;
    const isTime=e.clientY>rect.bottom-30;
    let mode='panX';
    if(isPrice)mode='zoomY';else if(isTime)mode='zoomX';
    chartDragState={startX:e.clientX,startY:e.clientY,startPanX:chartPanX,startZoomX:chartZoomX,startZoomY:chartZoomY,mode};
    body.style.cursor=mode==='zoomY'?'ns-resize':mode==='zoomX'?'ew-resize':'grab';
    e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!chartDragState)return;
    if(chartDragState.mode==='panX'){
      const dx=e.clientX-chartDragState.startX;
      const candles=candleData[candleKey(activeCoin,activeTF)];if(!candles)return;
      chartPanX=Math.max(0,Math.min(candles.length-5,chartDragState.startPanX-dx*0.5/chartZoomX));
      body.style.cursor='grabbing';
    }else if(chartDragState.mode==='zoomY'){
      const dy=e.clientY-chartDragState.startY;
      chartZoomY=Math.max(0.2,Math.min(5,chartDragState.startZoomY*(1+dy*0.005)));
    }else if(chartDragState.mode==='zoomX'){
      const dx=e.clientX-chartDragState.startX;
      chartZoomX=Math.max(0.3,Math.min(8,chartDragState.startZoomX*(1+dx*0.005)));
    }
    renderChart();
  });
  document.addEventListener('mouseup',()=>{if(chartDragState){chartDragState=null;body.style.cursor='crosshair'}});
  body.addEventListener('dblclick',()=>{chartZoomX=1;chartZoomY=1;chartPanX=0;document.getElementById('chartScroll').value=100;renderChart()});
  document.getElementById('chartScroll').addEventListener('input',function(){
    const candles=candleData[candleKey(activeCoin,activeTF)];if(!candles)return;
    chartPanX=(candles.length-5)*(1-this.value/100);renderChart();
  });
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART RENDERING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderChart(){
  const canvas=document.getElementById('chart');
  const ctx=canvas.getContext('2d');
  const rect=canvas.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height;
  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
  const d=priceData[activeCoin];if(!d)return;
  const candles=candleData[candleKey(activeCoin,activeTF)];
  if(chartType==='candle'&&candles&&candles.length>2)drawCandles(ctx,W,H,candles);
  else drawLine(ctx,W,H,d);
}

function drawCandles(ctx,W,H,allCandles){
  const mR=80,mB=30,cW=W-mR,cH=H-mB;
  const visibleCount=Math.max(5,Math.floor(allCandles.length/chartZoomX));
  const startIdx=Math.max(0,allCandles.length-visibleCount-Math.floor(chartPanX));
  const endIdx=Math.min(allCandles.length,startIdx+visibleCount);
  const candles=allCandles.slice(startIdx,endIdx);
  if(candles.length<1)return;

  const dataMin=Math.min(...candles.map(c=>c.l));
  const dataMax=Math.max(...candles.map(c=>c.h));
  const dataMid=(dataMax+dataMin)/2;
  const dataRange=(dataMax-dataMin)||1;
  const zr=dataRange/chartZoomY;
  const min=dataMid-zr/2,max=dataMid+zr/2,range=max-min||1;

  const barW=Math.max(2,Math.min(30,(cW/candles.length)-2));
  const gap=cW/candles.length;

  // Grid
  ctx.strokeStyle='#111';ctx.lineWidth=0.5;ctx.font='9px JetBrains Mono';ctx.fillStyle='#333';
  for(let i=0;i<=8;i++){const y=(i/8)*cH;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cW,y);ctx.stroke();ctx.fillText(fmtPrice(max-(i/8)*range),cW+6,y+3)}

  // Time labels
  ctx.fillStyle='#282828';
  const step=Math.max(1,Math.floor(candles.length/8));
  for(let i=0;i<candles.length;i+=step){
    const x=i*gap+gap/2;const t=new Date(candles[i].t);
    let tl;
    if(activeTF==='1d'||activeTF==='1w')tl=(t.getMonth()+1)+'/'+t.getDate();
    else if(activeTF==='4h')tl=t.getHours().toString().padStart(2,'0')+':00';
    else tl=t.getHours().toString().padStart(2,'0')+':'+t.getMinutes().toString().padStart(2,'0');
    ctx.fillText(tl,x-14,cH+14);
  }

  // Volume bars
  const maxVol=Math.max(...candles.map(c=>c.v));
  candles.forEach((c,i)=>{const x=i*gap+(gap-barW)/2;const vH=(c.v/maxVol)*(cH*0.12);ctx.fillStyle=c.c>=c.o?'rgba(0,200,83,0.08)':'rgba(255,23,68,0.08)';ctx.fillRect(x,cH-vH,barW,vH)});

  // Candles
  candles.forEach((c,i)=>{
    const x=i*gap+gap/2,bx=i*gap+(gap-barW)/2;
    const bull=c.c>=c.o;
    ctx.strokeStyle=bull?'#005f27':'#7a0b20';ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(x,Math.max(0,Math.min(cH,cH-((c.h-min)/range)*cH)));
    ctx.lineTo(x,Math.max(0,Math.min(cH,cH-((c.l-min)/range)*cH)));
    ctx.stroke();
    const oY=Math.max(0,Math.min(cH,cH-((c.o-min)/range)*cH));
    const cY=Math.max(0,Math.min(cH,cH-((c.c-min)/range)*cH));
    ctx.fillStyle=bull?'#00c853':'#ff1744';
    ctx.fillRect(bx,Math.min(oY,cY),barW,Math.max(Math.abs(oY-cY),1));
  });

  // Technical Indicators
  if(indicators.sma20){
    const sma=calcSMA(allCandles,20);
    if(sma.length>0){
      const offset=allCandles.length-sma.length;
      ctx.beginPath();
      sma.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='#2196f3';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
  if(indicators.sma50){
    const sma=calcSMA(allCandles,50);
    if(sma.length>0){
      const offset=allCandles.length-sma.length;
      ctx.beginPath();
      sma.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='#e040fb';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
  if(indicators.ema20){
    const ema=calcEMA(allCandles,20);
    if(ema.length>0){
      const offset=allCandles.length-ema.length;
      ctx.beginPath();
      ema.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='#ffeb3b';ctx.lineWidth=1.5;ctx.stroke();
    }
  }
  if(indicators.bb){
    const bb=calcBB(allCandles,20,2);
    if(bb.upper.length>0){
      const offset=allCandles.length-bb.upper.length;
      // Upper band
      ctx.beginPath();
      bb.upper.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='rgba(156,39,176,0.5)';ctx.lineWidth=1;ctx.stroke();
      // Middle (same as SMA20)
      ctx.beginPath();
      bb.middle.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='rgba(156,39,176,0.8)';ctx.lineWidth=1.5;ctx.stroke();
      // Lower band
      ctx.beginPath();
      bb.lower.forEach((val,i)=>{
        const idx=i+offset-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='rgba(156,39,176,0.5)';ctx.lineWidth=1;ctx.stroke();
    }
  }
  if(indicators.vwap){
    const vwap=calcVWAP(allCandles);
    if(vwap.length>0){
      ctx.beginPath();
      vwap.forEach((val,i)=>{
        const idx=i-startIdx;
        if(idx<0||idx>=candles.length)return;
        const x=idx*gap+gap/2;
        const y=Math.max(0,Math.min(cH,cH-((val-min)/range)*cH));
        i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
      });
      ctx.strokeStyle='#00bcd4';ctx.lineWidth=1.5;ctx.stroke();
    }
  }

  // Last price line
  const lastC=candles[candles.length-1].c;
  const lastY=Math.max(10,Math.min(cH-10,cH-((lastC-min)/range)*cH));
  ctx.setLineDash([3,3]);
  ctx.strokeStyle=lastC>=candles[0].o?'rgba(0,200,83,0.5)':'rgba(255,23,68,0.5)';
  ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(0,lastY);ctx.lineTo(cW,lastY);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle=lastC>=candles[0].o?'#00c853':'#ff1744';
  ctx.fillRect(cW,lastY-9,72,18);
  ctx.fillStyle='#000';ctx.font='600 10px JetBrains Mono';
  ctx.fillText(fmtPrice(lastC),cW+4,lastY+3);

  // OHLC
  const last=candles[candles.length-1];
  document.getElementById('ohlcO').textContent=fmtPrice(last.o);
  document.getElementById('ohlcH').textContent=fmtPrice(last.h);
  document.getElementById('ohlcL').textContent=fmtPrice(last.l);
  document.getElementById('ohlcC').textContent=fmtPrice(last.c);
  document.getElementById('ohlcV').textContent=fmtCompact(last.v);
}

function drawLine(ctx,W,H,d){
  if(!d.history||d.history.length<2)return;
  const prices=d.history.map(h=>h.price);
  const mR=80,mB=30,cW=W-mR,cH=H-mB;
  const min=Math.min(...prices)*0.9998,max=Math.max(...prices)*1.0002;
  const range=max-min||1;
  ctx.strokeStyle='#111';ctx.lineWidth=0.5;ctx.font='9px JetBrains Mono';ctx.fillStyle='#333';
  for(let i=0;i<=8;i++){const y=(i/8)*cH;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cW,y);ctx.stroke();ctx.fillText(fmtPrice(max-(i/8)*range),cW+6,y+3)}
  const isUp=prices[prices.length-1]>=prices[0];const lc=isUp?'#00c853':'#ff1744';
  if(chartType==='area'){
    const grad=ctx.createLinearGradient(0,0,0,cH);
    grad.addColorStop(0,isUp?'rgba(0,200,83,0.12)':'rgba(255,23,68,0.12)');
    grad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.beginPath();prices.forEach((p,i)=>{const x=(i/(prices.length-1))*cW,y=cH-((p-min)/range)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
    ctx.lineTo(cW,cH);ctx.lineTo(0,cH);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  }
  ctx.beginPath();prices.forEach((p,i)=>{const x=(i/(prices.length-1))*cW,y=cH-((p-min)/range)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
  ctx.strokeStyle=lc;ctx.lineWidth=1.5;ctx.stroke();
  const lastY=cH-((prices[prices.length-1]-min)/range)*cH;
  ctx.setLineDash([3,3]);ctx.strokeStyle=isUp?'rgba(0,200,83,0.4)':'rgba(255,23,68,0.4)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,lastY);ctx.lineTo(cW,lastY);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle=lc;ctx.fillRect(cW,lastY-9,72,18);ctx.fillStyle='#000';ctx.font='600 10px JetBrains Mono';ctx.fillText('$'+fmtPrice(d.price),cW+4,lastY+3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   [2] ANALYSIS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAnalysis(){
  const d=priceData[activeCoin];if(!d)return;
  const el=document.getElementById('analysisContent');
  const rsi=40+Math.random()*30;
  const macd=(Math.random()-0.5)*2;
  const signal=rsi>60?'BUY':rsi<40?'SELL':'NEUTRAL';
  const signalColor=signal==='BUY'?'var(--green)':signal==='SELL'?'var(--red)':'var(--orange)';
  
  el.innerHTML=`
    <div class="analysis-card">
      <h3>SIGNAL SUMMARY</h3>
      <div style="text-align:center;margin:20px 0">
        <div style="font-size:32px;font-weight:800;color:${signalColor}">${signal}</div>
        <div style="font-size:11px;color:var(--dim);margin-top:4px">Based on 12 technical indicators</div>
      </div>
      <div class="signal-meter">
        <div class="signal-bar" style="background:var(--red-bg);color:var(--red)">SELL</div>
        <div class="signal-bar" style="background:var(--red-bg);color:var(--red);opacity:0.6">WEAK</div>
        <div class="signal-bar" style="background:var(--orange-bg);color:var(--orange)">NEUTRAL</div>
        <div class="signal-bar" style="background:var(--green-bg);color:var(--green);opacity:0.6">WEAK</div>
        <div class="signal-bar" style="background:var(--green-bg);color:var(--green)">BUY</div>
      </div>
      <div class="indicator-row"><span class="name">Moving Averages (7)</span><span class="val up">5 Buy / 2 Sell</span></div>
      <div class="indicator-row"><span class="name">Oscillators (5)</span><span class="val">2 Buy / 1 Sell / 2 Neutral</span></div>
    </div>
    <div class="analysis-card">
      <h3>OSCILLATORS</h3>
      <div class="indicator-row"><span class="name">RSI (14)</span><span class="val ${rsi>60?'up':rsi<40?'down':''}">${rsi.toFixed(1)}</span></div>
      <div class="indicator-row"><span class="name">MACD (12,26,9)</span><span class="val ${macd>=0?'up':'down'}">${macd.toFixed(4)}</span></div>
      <div class="indicator-row"><span class="name">Stochastic %K</span><span class="val">${(30+Math.random()*40).toFixed(1)}</span></div>
      <div class="indicator-row"><span class="name">CCI (20)</span><span class="val">${(-50+Math.random()*200).toFixed(1)}</span></div>
      <div class="indicator-row"><span class="name">Williams %R</span><span class="val">${(-80+Math.random()*60).toFixed(1)}</span></div>
      <div class="indicator-row"><span class="name">ADX (14)</span><span class="val">${(15+Math.random()*30).toFixed(1)}</span></div>
    </div>
    <div class="analysis-card">
      <h3>MOVING AVERAGES</h3>
      ${['SMA 10','SMA 20','SMA 50','SMA 100','SMA 200','EMA 10','EMA 20'].map(ma=>{
        const val=d.price*(0.95+Math.random()*0.1);
        const above=d.price>val;
        return `<div class="indicator-row"><span class="name">${ma}</span><span class="val">${fmtPrice(val)}</span><span class="${above?'up':'down'}" style="font-weight:600;font-size:10px">${above?'BUY':'SELL'}</span></div>`;
      }).join('')}
    </div>
    <div class="analysis-card">
      <h3>SUPPORT & RESISTANCE</h3>
      ${[['R3',1.04],['R2',1.025],['R1',1.012],['Pivot',1.0],['S1',0.988],['S2',0.975],['S3',0.96]].map(([label,mult])=>{
        const val=d.price*mult;
        const isSupport=mult<1;
        const pct=((mult-1)*100);
        return `<div class="sr-level">
          <span style="width:30px;font-weight:700;color:${isSupport?'var(--green)':'var(--red)'}">${label}</span>
          <div class="sr-bar" style="background:${isSupport?'var(--green-bg)':'var(--red-bg)'};width:${Math.abs(pct)*20}%"></div>
          <span style="font-weight:600">$${fmtPrice(val)}</span>
        </div>`;
      }).join('')}
    </div>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   [3] ORDER BOOK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderOrderBookFull(){
  const d=priceData[activeCoin];if(!d)return;
  const price=d.price;
  const el=document.getElementById('obList');
  const ob=orderBookData[activeCoin];
  
  let html='';
  let asks,bids;
  
  // Use real L2 data if available (crypto), else generate fake (stocks)
  if(ob&&ob.asks&&ob.bids){
    asks=ob.asks.slice(0,20).reverse(); // top 20 asks, reversed for display
    bids=ob.bids.slice(0,20); // top 20 bids
  }else{
    // Fake data for non-crypto
    asks=[];bids=[];
    for(let i=20;i>=1;i--){
      const off=price*(0.00005*i+Math.random()*0.0001);
      asks.push({price:price+off,size:+(Math.random()*40+1).toFixed(3)});
    }
    for(let i=1;i<=20;i++){
      const off=price*(0.00005*i+Math.random()*0.0001);
      bids.push({price:price-off,size:+(Math.random()*40+1).toFixed(3)});
    }
  }
  
  // Render asks (highest to lowest, so reverse)
  let cum=0;
  const maxSize=Math.max(...asks.map(a=>a.size),...bids.map(b=>b.size));
  asks.forEach(a=>{
    cum+=a.size;
    const pct=(a.size/maxSize)*100;
    html+=`<div class="ob-row2"><div class="ob-bar2" style="width:${pct}%;background:var(--red)"></div><span style="color:var(--red);font-weight:600">${fmtPrice(a.price)}</span><span style="text-align:right;color:var(--dim)">${a.size.toFixed(3)}</span><span style="text-align:right;color:var(--muted)">${cum.toFixed(1)}</span></div>`;
  });
  
  // Mid
  html+=`<div class="ob-mid2"><span class="${d.price>=d.prevPrice?'up':'down'}">$${fmtPrice(price)}</span></div>`;
  
  // Bids
  cum=0;
  bids.forEach(b=>{
    cum+=b.size;
    const pct=(b.size/maxSize)*100;
    html+=`<div class="ob-row2"><div class="ob-bar2" style="width:${pct}%;background:var(--green)"></div><span style="color:var(--green);font-weight:600">${fmtPrice(b.price)}</span><span style="text-align:right;color:var(--dim)">${b.size.toFixed(3)}</span><span style="text-align:right;color:var(--muted)">${cum.toFixed(1)}</span></div>`;
  });
  
  el.innerHTML=html;
  renderDepthCanvas();
}

function renderDepthCanvas(){
  const canvas=document.getElementById('depthCanvas');
  const d=priceData[activeCoin];if(!d||!canvas)return;
  const rect=canvas.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height;
  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
  
  const price=d.price;
  const ob=orderBookData[activeCoin];
  let bidCum=[],askCum=[],bidTotal=0,askTotal=0;
  
  // Use real L2 data if available
  if(ob&&ob.bids&&ob.asks){
    // Build cumulative depth from real data
    ob.bids.slice(0,50).forEach(b=>{
      bidTotal+=b.size;
      bidCum.push({price:b.price,cum:bidTotal});
    });
    ob.asks.slice(0,50).forEach(a=>{
      askTotal+=a.size;
      askCum.push({price:a.price,cum:askTotal});
    });
  }else{
    // Fake data fallback
    const spread=price*0.05,levels=40;
    for(let i=0;i<levels;i++){
      bidTotal+=Math.random()*50+5+(levels-i)*2;
      askTotal+=Math.random()*50+5+(levels-i)*1.5;
      bidCum.push({price:price-(i/levels)*spread,cum:bidTotal});
      askCum.push({price:price+(i/levels)*spread,cum:askTotal});
    }
  }
  const maxCum=Math.max(bidTotal,askTotal);
  const midX=W/2,mB=30,cH=H-mB;
  
  // Title
  ctx.font='600 12px JetBrains Mono';ctx.fillStyle='#ff8c00';
  ctx.fillText('DEPTH â€” '+activeCoin,12,20);
  
  // Bid fill
  const bidGrad=ctx.createLinearGradient(0,0,0,cH);
  bidGrad.addColorStop(0,'rgba(0,200,83,0.25)');bidGrad.addColorStop(1,'rgba(0,200,83,0.02)');
  ctx.beginPath();ctx.moveTo(midX,cH);
  bidCum.forEach((b,i)=>{ctx.lineTo(midX-(i/levels)*midX,cH-(b.cum/maxCum)*(cH-50))});
  ctx.lineTo(0,cH);ctx.closePath();ctx.fillStyle=bidGrad;ctx.fill();
  ctx.beginPath();ctx.moveTo(midX,cH);
  bidCum.forEach((b,i)=>{ctx.lineTo(midX-(i/levels)*midX,cH-(b.cum/maxCum)*(cH-50))});
  ctx.strokeStyle='#00c853';ctx.lineWidth=2;ctx.stroke();
  
  // Ask fill
  const askGrad=ctx.createLinearGradient(0,0,0,cH);
  askGrad.addColorStop(0,'rgba(255,23,68,0.25)');askGrad.addColorStop(1,'rgba(255,23,68,0.02)');
  ctx.beginPath();ctx.moveTo(midX,cH);
  askCum.forEach((a,i)=>{ctx.lineTo(midX+(i/levels)*midX,cH-(a.cum/maxCum)*(cH-50))});
  ctx.lineTo(W,cH);ctx.closePath();ctx.fillStyle=askGrad;ctx.fill();
  ctx.beginPath();ctx.moveTo(midX,cH);
  askCum.forEach((a,i)=>{ctx.lineTo(midX+(i/levels)*midX,cH-(a.cum/maxCum)*(cH-50))});
  ctx.strokeStyle='#ff1744';ctx.lineWidth=2;ctx.stroke();
  
  // Mid line
  ctx.setLineDash([4,4]);ctx.strokeStyle='#ff8c00';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(midX,30);ctx.lineTo(midX,cH);ctx.stroke();ctx.setLineDash([]);
  
  ctx.font='600 11px JetBrains Mono';ctx.textAlign='center';ctx.fillStyle='#ff8c00';
  ctx.fillText('$'+fmtPrice(price),midX,cH+15);
  ctx.fillStyle='#00c853';ctx.textAlign='left';ctx.fillText('BIDS: '+fmtCompact(bidTotal),12,cH+15);
  ctx.fillStyle='#ff1744';ctx.textAlign='right';ctx.fillText('ASKS: '+fmtCompact(askTotal),W-12,cH+15);ctx.textAlign='left';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   [4] REL VALUE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderRelValue(){
  // Peer table
  const el=document.getElementById('rvTableBody');
  el.innerHTML=getFilteredAssets().map(c=>{
    const d=priceData[c];if(!d)return'';
    const change24=((d.price-d.open)/d.open*100);
    const change7d=(Math.random()-0.3)*15;
    const vol=d.volume||Math.random()*500e6;
    const funding=d.funding||(Math.random()-0.5)*0.01;
    const oi=d.openInterest||Math.random()*200;
    const isUp=change24>=0;
    return `<div class="rv-row" onclick="selectCoin('${c}')" style="${c===activeCoin?'background:#1a1200;':''}">
      <span class="sym">${c}</span>
      <span style="color:var(--dim)">${fmtCompact(vol*10)}</span>
      <span style="font-weight:600">$${fmtPrice(d.price)}</span>
      <span class="${isUp?'up':'down'}" style="font-weight:600">${isUp?'+':''}${change24.toFixed(2)}%</span>
      <span class="${change7d>=0?'up':'down'}">${change7d>=0?'+':''}${change7d.toFixed(2)}%</span>
      <span style="color:var(--dim)">$${fmtCompact(vol)}</span>
      <span class="${funding>=0?'up':'down'}">${(funding*100).toFixed(4)}%</span>
      <span style="color:var(--dim)">${fmtCompact(oi*d.price)}</span>
      <span></span>
    </div>`;
  }).join('');
  
  // Render comparison chart
  renderRelChart();
}

function renderRelChart(){
  const canvas=document.getElementById('rvChart');
  const rect=canvas.parentElement.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height;
  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
  
  const colors=['#ff8c00','#00c853','#ff1744','#2196f3','#e040fb','#ffeb3b'];
  const compare=['BTC','ETH','SOL','DOGE','SUI','HYPE'].filter(c=>priceData[c]);
  
  ctx.font='600 11px JetBrains Mono';ctx.fillStyle='#ff8c00';
  ctx.fillText('RELATIVE PERFORMANCE',12,20);
  
  // Legend
  compare.forEach((c,i)=>{
    ctx.fillStyle=colors[i%colors.length];
    ctx.fillRect(12+i*80,30,12,3);
    ctx.fillText(c,28+i*80,34);
  });
  
  const mT=50,mB=30,mR=60,cW=W-mR,cH=H-mT-mB;
  
  // Generate normalized performance lines
  compare.forEach((c,ci)=>{
    const d=priceData[c];if(!d||!d.history||d.history.length<2)return;
    const hist=d.history;
    const base=hist[0].price;
    ctx.beginPath();
    hist.forEach((h,i)=>{
      const x=(i/(hist.length-1))*cW;
      const pct=((h.price-base)/base)*100;
      const y=mT+cH/2-(pct/10)*cH/2; // scale: 10% = half height
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.strokeStyle=colors[ci%colors.length];
    ctx.lineWidth=1.5;ctx.stroke();
  });
  
  // Zero line
  ctx.setLineDash([4,4]);ctx.strokeStyle='#333';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,mT+cH/2);ctx.lineTo(cW,mT+cH/2);ctx.stroke();ctx.setLineDash([]);
  ctx.font='9px JetBrains Mono';ctx.fillStyle='#444';ctx.fillText('0%',cW+6,mT+cH/2+3);
}

document.querySelectorAll('.rv-btn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.rv-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
  renderRelValue();
}));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   [5] NEWS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const headlines=[
  {time:'2m ago',text:'Hyperliquid DEX volume surges to $8.2B in 24h, new ATH',src:'HL Analytics'},
  {time:'8m ago',text:'BTC holds above $97K as ETF inflows continue fourth straight week',src:'CoinDesk'},
  {time:'15m ago',text:'Solana DeFi TVL reaches $12.4B, SOL eyes breakout above $175',src:'DeFi Llama'},
  {time:'22m ago',text:'Fed minutes show no rate cut expected before Q3 2026',src:'Reuters'},
  {time:'31m ago',text:'DOGE funding rate turns negative as shorts pile in',src:'Coinglass'},
  {time:'45m ago',text:'Ethereum blob fees hit new low, L2 costs drop to $0.001',src:'L2Beat'},
  {time:'1h ago',text:'SUI ecosystem TVL up 340% YTD, Move language gaining traction',src:'DeFi Llama'},
  {time:'1h ago',text:'Crypto market cap steady at $3.4T, dominance BTC 58.2%',src:'CoinGecko'},
  {time:'2h ago',text:'Hyperliquid HYPE token staking APY at 14.2%',src:'HL Docs'},
  {time:'3h ago',text:'XRP ETF filing under SEC review, decision expected Q2',src:'Bloomberg'},
  {time:'4h ago',text:'Ethereum Pectra upgrade scheduled for Q2 2026, staking improvements incoming',src:'Ethereum Foundation'},
  {time:'5h ago',text:'Top Hyperliquid trader nets $2.4M profit on leveraged BTC long',src:'HL Leaderboard'},
  {time:'6h ago',text:'PEPE whale accumulates 500B tokens in 48 hours',src:'Whale Alert'},
  {time:'8h ago',text:'Bitcoin mining difficulty adjusts +3.2%, hash rate at all-time high',src:'BitInfoCharts'},
];

function renderNewsFull(){
  const el=document.getElementById('newsList');
  el.innerHTML=headlines.map(h=>`<div class="news-card"><div class="time">${h.time}</div><div class="headline">${h.text}</div><div class="source">${h.src}</div></div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   [6] POSITIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.pos-subtab').forEach(t=>t.addEventListener('click',()=>{
  activePosSub=t.dataset.sub;
  document.querySelectorAll('.pos-subtab').forEach(x=>x.classList.toggle('active',x.dataset.sub===activePosSub));
  renderPositionsSub();
}));

function renderPositionsSub(){
  const el=document.getElementById('posContent');
  if(activePosSub==='positions')renderPositions(el);
  else if(activePosSub==='orders')renderOrders(el);
  else if(activePosSub==='history')renderHistory(el);
  else if(activePosSub==='account')renderAccount(el);
}

function renderPositions(el){
  const positions=[
    {sym:'BTC',side:'LONG',size:'0.150',entry:'96,842.50',mark:'97,220.00',liq:'91,200.00',pnl:'+$56.63',roe:'+4.15%',margin:'$1,452',up:true},
    {sym:'ETH',side:'SHORT',size:'2.500',entry:'2,784.20',mark:'2,758.40',liq:'3,012.00',pnl:'+$64.50',roe:'+3.72%',margin:'$834',up:true},
    {sym:'SOL',side:'LONG',size:'45.00',entry:'168.42',mark:'171.88',liq:'152.10',pnl:'+$155.70',roe:'+6.82%',margin:'$1,516',up:true},
    {sym:'DOGE',side:'LONG',size:'10,000',entry:'0.25410',mark:'0.24980',liq:'0.22100',pnl:'-$43.00',roe:'-1.69%',margin:'$508',up:false},
    {sym:'HYPE',side:'LONG',size:'120',entry:'24.50',mark:'25.12',liq:'20.80',pnl:'+$74.40',roe:'+5.06%',margin:'$588',up:true},
  ];
  el.innerHTML=`
    <div class="pos-head"><span>SYMBOL</span><span>SIDE</span><span>SIZE</span><span>ENTRY</span><span>MARK</span><span>LIQ</span><span>PnL</span><span>ROE%</span><span>MARGIN</span></div>
    ${positions.map(p=>`<div class="pos-row">
      <span class="pos-sym">${p.sym}</span>
      <span><span class="pos-badge ${p.side==='LONG'?'pos-long':'pos-short'}">${p.side}</span></span>
      <span>${p.size}</span><span>$${p.entry}</span><span>$${p.mark}</span>
      <span style="color:var(--red-dim)">${p.liq}</span>
      <span class="${p.up?'up':'down'}" style="font-weight:700">${p.pnl}</span>
      <span class="${p.up?'up':'down'}" style="font-weight:600">${p.roe}</span>
      <span style="color:var(--dim)">${p.margin}</span>
    </div>`).join('')}
    <div style="padding:8px 12px;font-size:11px;color:var(--green);font-weight:700;border-top:1px solid #1a1a1a">TOTAL UNREALIZED PnL: +$308.23</div>
  `;
}

function renderOrders(el){
  const orders=[
    {sym:'BTC',side:'BUY',type:'LIMIT',price:'$66,500.00',size:'0.200',status:'OPEN',time:'14:32:01'},
    {sym:'ETH',side:'SELL',type:'LIMIT',price:'$2,850.00',size:'5.000',status:'OPEN',time:'13:45:22'},
    {sym:'SOL',side:'BUY',type:'STOP',price:'$165.00',size:'30.00',status:'PENDING',time:'12:10:45'},
    {sym:'HYPE',side:'BUY',type:'LIMIT',price:'$23.00',size:'200',status:'OPEN',time:'11:55:33'},
  ];
  el.innerHTML=`
    <div class="pos-head"><span>SYMBOL</span><span>SIDE</span><span>TYPE</span><span>PRICE</span><span>SIZE</span><span>STATUS</span><span>TIME</span><span></span><span></span></div>
    ${orders.map(o=>`<div class="pos-row">
      <span class="pos-sym">${o.sym}</span>
      <span><span class="pos-badge ${o.side==='BUY'?'pos-long':'pos-short'}">${o.side}</span></span>
      <span style="color:var(--dim)">${o.type}</span><span>${o.price}</span><span>${o.size}</span>
      <span style="color:${o.status==='OPEN'?'var(--green)':'var(--orange)'}">${o.status}</span>
      <span style="color:var(--muted)">${o.time}</span><span></span><span></span>
    </div>`).join('')}
  `;
}

function renderHistory(el){
  const trades=[
    {sym:'BTC',side:'SELL',price:'$97,100',size:'0.100',pnl:'+$142.00',time:'22:15',date:'02/25',up:true},
    {sym:'ETH',side:'BUY',price:'$2,784',size:'2.500',pnl:'â€”',time:'21:45',date:'02/25'},
    {sym:'SOL',side:'SELL',price:'$172.80',size:'20.00',pnl:'+$87.20',time:'15:22',date:'02/25',up:true},
    {sym:'DOGE',side:'SELL',price:'$0.261',size:'5,000',pnl:'+$34.50',time:'19:12',date:'02/25',up:true},
    {sym:'BTC',side:'BUY',price:'$96,200',size:'0.050',pnl:'-$18.30',time:'18:05',date:'02/25',up:false},
  ];
  el.innerHTML=`
    <div class="pos-head"><span>SYMBOL</span><span>SIDE</span><span>PRICE</span><span>SIZE</span><span>PnL</span><span>TIME</span><span>DATE</span><span></span><span></span></div>
    ${trades.map(t=>`<div class="pos-row">
      <span class="pos-sym">${t.sym}</span>
      <span><span class="pos-badge ${t.side==='BUY'?'pos-long':'pos-short'}">${t.side}</span></span>
      <span>${t.price}</span><span>${t.size}</span>
      <span class="${t.up===true?'up':t.up===false?'down':''}" style="font-weight:600">${t.pnl}</span>
      <span style="color:var(--muted)">${t.time}</span><span style="color:var(--muted)">${t.date}</span><span></span><span></span>
    </div>`).join('')}
  `;
}

function renderAccount(el){
  el.innerHTML=`
    <div class="account-grid">
      <div class="account-cell"><div class="lbl">ACCOUNT EQUITY</div><div class="val">$12,458.63</div></div>
      <div class="account-cell"><div class="lbl">AVAILABLE BALANCE</div><div class="val" style="color:var(--green)">$7,560.40</div></div>
      <div class="account-cell"><div class="lbl">MARGIN USED</div><div class="val" style="color:var(--orange)">$4,898.23</div></div>
      <div class="account-cell"><div class="lbl">UNREALIZED PnL</div><div class="val up">+$308.23</div></div>
      <div class="account-cell"><div class="lbl">REALIZED PnL (TODAY)</div><div class="val up">+$271.20</div></div>
      <div class="account-cell"><div class="lbl">TOTAL PnL (24H)</div><div class="val up">+$579.43</div></div>
      <div class="account-cell"><div class="lbl">MARGIN RATIO</div><div class="val" style="color:var(--green)">39.3%</div></div>
      <div class="account-cell"><div class="lbl">AVG LEVERAGE</div><div class="val" style="color:var(--orange)">8.2x</div></div>
      <div class="account-cell"><div class="lbl">OPEN POSITIONS</div><div class="val">5</div></div>
    </div>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD SHORTCUTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
  if(document.activeElement===coinInput)return;
  
  // Tab switching (1-6)
  if(e.key==='1')switchTab('overview');
  else if(e.key==='2')switchTab('analysis');
  else if(e.key==='3')switchTab('orderbook');
  else if(e.key==='4')switchTab('relvalue');
  else if(e.key==='5')switchTab('news');
  else if(e.key==='6')switchTab('positions');
  
  // Search
  else if(e.key==='/'){e.preventDefault();coinInput.focus()}
  
  // Timeframe switching (Shift + 1-7)
  else if(e.shiftKey&&e.key==='!'){switchTimeframe('1m')} // Shift+1
  else if(e.shiftKey&&e.key==='@'){switchTimeframe('5m')} // Shift+2
  else if(e.shiftKey&&e.key==='#'){switchTimeframe('15m')} // Shift+3
  else if(e.shiftKey&&e.key==='$'){switchTimeframe('1h')} // Shift+4
  else if(e.shiftKey&&e.key==='%'){switchTimeframe('4h')} // Shift+5
  else if(e.shiftKey&&e.key==='^'){switchTimeframe('1d')} // Shift+6
  else if(e.shiftKey&&e.key==='&'){switchTimeframe('1w')} // Shift+7
  
  // Watchlist navigation (j/k vim-style)
  else if(e.key==='j'){
    const idx=ALL_TICKERS.indexOf(activeCoin);
    if(idx<ALL_TICKERS.length-1)selectCoin(ALL_TICKERS[idx+1]);
  }
  else if(e.key==='k'){
    const idx=ALL_TICKERS.indexOf(activeCoin);
    if(idx>0)selectCoin(ALL_TICKERS[idx-1]);
  }
  
  // Category cycling (c)
  else if(e.key==='c'){
    const cats=['all','favorites','crypto','stocks','commodities','forex'];
    const idx=cats.indexOf(activeCategory);
    activeCategory=cats[(idx+1)%cats.length];
    renderWatchlist();
  }
  
  // Toggle favorite (f)
  else if(e.key==='f'){toggleFavorite(activeCoin)}
  
  // Indicator toggles (Alt + letter)
  else if(e.altKey&&e.key==='s'){indicators.sma20=!indicators.sma20;document.getElementById('ind-sma20')?.classList.toggle('active');saveSettings();renderChart()}
  else if(e.altKey&&e.key==='e'){indicators.ema20=!indicators.ema20;document.getElementById('ind-ema20')?.classList.toggle('active');saveSettings();renderChart()}
  else if(e.altKey&&e.key==='b'){indicators.bb=!indicators.bb;document.getElementById('ind-bb')?.classList.toggle('active');saveSettings();renderChart()}
  else if(e.altKey&&e.key==='v'){indicators.vwap=!indicators.vwap;document.getElementById('ind-vwap')?.classList.toggle('active');saveSettings();renderChart()}
  
  // Reset zoom (Escape or r)
  else if(e.key==='Escape'||e.key==='r'){chartZoomX=1;chartZoomY=1;chartPanX=0;document.getElementById('chartScroll').value=100;renderChart()}
  
  // Refresh data (Ctrl+R or F5)
  else if((e.ctrlKey&&e.key==='r')||e.key==='F5'){e.preventDefault();fetchPrices();fetchStocks();fetchOrderBook(activeCoin)}
  
  // Create price alert (Alt+A)
  else if(e.altKey&&e.key==='a'){
    const d=priceData[activeCoin];
    if(!d)return;
    const target=prompt(`Create price alert for ${activeCoin} (current: $${fmtPrice(d.price)})\nEnter target price:`);
    if(!target||isNaN(parseFloat(target)))return;
    const price=parseFloat(target);
    const condition=price>d.price?'above':'below';
    addPriceAlert(activeCoin,price,condition);
    alert(`Alert set: ${activeCoin} ${condition} $${fmtPrice(price)}`);
  }
  
  // Toggle sound (Alt+M for mute)
  else if(e.altKey&&e.key==='m'){soundEnabled=!soundEnabled;saveSettings();alert(soundEnabled?'ğŸ”Š Sound enabled':'ğŸ”‡ Sound muted')}
  
  // Toggle theme (Alt+T)
  else if(e.altKey&&e.key==='t'){toggleTheme()}
  
  // Help (?)
  else if(e.key==='?'){alert(`KEYBOARD SHORTCUTS:
1-6: Switch tabs
Shift+1-7: Change timeframe
j/k: Next/prev coin (vim-style)
c: Cycle category filters
f: Toggle favorite
/: Focus search
Alt+S/E/B/V: Toggle indicators
r/Esc: Reset zoom
Ctrl+R/F5: Refresh data
?: This help`);}
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TF + TYPE BUTTONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.tf-btn').forEach(b=>b.addEventListener('click',()=>switchTimeframe(b.dataset.tf)));
document.querySelectorAll('.type-btn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.type-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
  chartType=b.dataset.type;renderChart();
}));

// Indicator toggles
['sma20','sma50','ema20','bb','vwap','rsi'].forEach(ind=>{
  const btn=document.getElementById('ind-'+ind);
  if(!btn)return;
  if(indicators[ind])btn.classList.add('active');
  btn.addEventListener('click',()=>{
    indicators[ind]=!indicators[ind];
    btn.classList.toggle('active');
    saveSettings(); // Save indicator preferences
    renderChart();
  });
});

window.addEventListener('resize',()=>{renderChart();if(activeTab==='orderbook')renderDepthCanvas();if(activeTab==='relvalue')renderRelChart()});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadSettings();
fetchPrices();
fetchMeta();
fetchStocks();
fetchOrderBook(activeCoin);
fetchFearGreed();
setInterval(fetchPrices,3000);
setInterval(fetchMeta,15000);
setInterval(fetchStocks,10000);
setInterval(()=>fetchOrderBook(activeCoin),2000);
setInterval(fetchFearGreed,60000); // Fear & Greed every 60s
setInterval(()=>{if(activeTab==='overview')renderRecentTrades()},5000);
</script>
</body>
</html>
